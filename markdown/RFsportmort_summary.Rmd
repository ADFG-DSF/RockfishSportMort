---
title: "Rockfish Historical Harvest Estimates"
author: "Phil Joy & Adam Reimer"
date: "February 2025"
output:
  html_document:
    self_contained: yes
    keep_md: false

knit: (function(input_file, encoding) {
        rmarkdown::render(input_file, 
                          output_file = paste0("RFsportmort_update_", "_ab_NO_swhsR_",Sys.Date(),".html"))
      })
---

```{r setup, include=FALSE}

getwd()
file.exists("../scripts/bayes_data_param_load.R")
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(ggplot2)
library(tidyverse)
library(wesanderson)
library(ggpubr)
library(knitr)
library(kableExtra)
library(here)
library(htmltools) 
library(coda)
library(jagsUI)
library(stringr)
library(readxl)
library(openxlsx2)
library(scales)
library(xlsx)
library(writexl)
library(flextable)

source("../scripts/mkdwn_functions.R", echo = FALSE)
#source("./scripts/bayes_data_param_load", echo = FALSE)
start_yr <- 1977
end_yr <- 2023
REP_YR <- 2023 #for Howard estimates
list2env(readinData(start_yr = start_yr,
                  end_yr = end_yr),
         .GlobalEnv)

#...............................................................................
##!!!FLAG: CHANGE THIS IN THE KNIT FUNCTION ABOVE TO PROPERLY LABEL HTML FILE!!!!!!
#...............................................................................
# Notes: on p plot, make symbol size = sample size, 
# Figure out how to show pH "data" for private? swhs bias and how species comps add up to match total releases. pH_pri_comp = pH_pri_all (bias corrected) ~ pH_gui_comp w offset parameter. Calculate pH_pri_all and show range based on species apportionment that illustrates model keeping sum of species = all release estimates
# comp_H - total_release * unkown comp proportion
#-------------------------------------------------------------------------------8
#mod<-"LB_hyb_5pH_infPr"
#mod<-"LB_fit_5pH"
mod<-"LB_fit_3pH"
#mod<-"LB_hyb_3pH"

#bestish
res <- "Gen3ab_indcomp_no_swhs_rel_FULL_thru2023_5e+06_2025-09-29"
#trying
#res <- "rf_harvest_est_kha_rm_wt_thru2023_3e+06_7kn_2025-05-29"
#res <- "rf_harvest_est_nm_wt_loose_b4pH_thru2023_5e+06__2025-07-14"

postH <- readRDS(paste0("..\\output\\bayes_posts\\",res,".rds"))

rhat <- get_Rhat(postH, cutoff = 1.11)

summary_table <- postH$summary %>%
  as.data.frame() %>%
  tibble::rownames_to_column(var = "Parameter") %>%
  select(Parameter, mean, sd, `2.5%`, `50%`, `97.5%`) %>%
  rename(
    Lower_CI = `2.5%`,
    Median = `50%`,
    Upper_CI = `97.5%`
  ) %>% 
  filter(str_detect(Parameter, "^tau_comp\\[") |
         str_detect(Parameter, "^tau_pH\\[") |
          str_detect(Parameter, "^mu_beta0_pelagic\\[")|
           str_detect(Parameter, "^tau_beta0_pelagic\\[")|
           str_detect(Parameter, "^mu_beta0_yellow\\[")|
           str_detect(Parameter, "^tau_beta0_yellow\\[")|
           str_detect(Parameter, "^mu_beta0_black\\[")|
           str_detect(Parameter, "^tau_beta0_black\\[")|
           str_detect(Parameter, "^mu_beta0_yellow_x\\[")|
           str_detect(Parameter, "^tau_beta0_yellow_x\\[")|
           str_detect(Parameter, "^mu_bc_H\\[")|
           str_detect(Parameter, "^tau_bc_H\\[")|
           str_detect(Parameter, "^mu_bc_R\\[")|
           str_detect(Parameter, "^tau_bc_R\\[")|
           str_detect(Parameter, "^bc_R_offset\\[")|
           str_detect(Parameter, "^beta0_pH\\[")|
           str_detect(Parameter, "^beta1_pH\\[")|
           str_detect(Parameter, "^beta2_pH\\[")|
           str_detect(Parameter, "^beta3_pH\\[")|
            str_detect(Parameter, "^beta4_pH\\[")|
           str_detect(Parameter, "^beta0_pelagic\\[")|
           str_detect(Parameter, "^beta1_pelagic\\[")|
           str_detect(Parameter, "^beta2_pelagic\\[")|
           str_detect(Parameter, "^beta3_pelagic\\[")|
           str_detect(Parameter, "^beta0_yellow\\[")|
           str_detect(Parameter, "^beta1_yellow\\[")|
           str_detect(Parameter, "^beta2_yellow\\[")|
           str_detect(Parameter, "^beta3_yellow\\[")|
           str_detect(Parameter, "^beta0_black\\[")|
           str_detect(Parameter, "^beta2_black\\[")|
           str_detect(Parameter, "^beta3_black\\[")|
           str_detect(Parameter, "^beta4_black\\[")|
           str_detect(Parameter, "^beta0_dsr\\[")|
           str_detect(Parameter, "^beta1_dsr\\[")|
           str_detect(Parameter, "^beta2_dsr\\[")|
           str_detect(Parameter, "^beta3_dsr\\[")|
           str_detect(Parameter, "^beta4_dsr\\[")|
           str_detect(Parameter, "^beta0_slope\\[")|
           str_detect(Parameter, "^beta1_slope\\[")|
           str_detect(Parameter, "^beta2_slope\\[")|
           str_detect(Parameter, "^beta3_slope\\[")|
           str_detect(Parameter, "^beta4_slope\\[")|
           str_detect(Parameter, "^beta5_slope\\[")|
           str_detect(Parameter, "^sigma_H\\[")|
           str_detect(Parameter, "^beta_H\\[")|
           str_detect(Parameter, "^beta0_H\\[")|
           str_detect(Parameter, "^lambda_H\\[")|
           str_detect(Parameter, "^mu_lambda_H\\[")|
           str_detect(Parameter, "^sigma_lambda_H\\["))

X <- 0

southeast <- c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO")
central <- c("CI","NG","PWSI","PWSO")
kodiak <- c("BSAI","SOKO2SAP","WKMA","afognak","eastside","northeast")
reg2 <- c(central,kodiak)

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check

```

<style>
.figure-container {
  border: 1px solid #ccc;      /* Adds a border */
  padding: 10px;              /* Space inside the box */
  margin-bottom: 30px;        /* Space below the box */
  background-color: #f9f9f9;  /* Light background */
  border-radius: 5px;         /* Rounded corners */
  box-sizing: border-box;     /* Ensures padding doesnâ€™t shrink content */
  width: 100%;                /* Allow the figure to use full width */
}
.figure-caption {
  font-weight: bold;
  margin-top: 10px;
}
.figure-container img, 
.figure-container .ggplot {
  max-width: 100%;            /* Prevent overflow for plots */
  height: auto;               /* Maintain aspect ratio */
}
</style>

This project seeks to estimate sport fish harvest and releases of rockfish in Alaska waters by improving on the Howard et al. (2020) methods and expand the time series back to 1977 when the statewide harvest survey (SWHS) was first implemented. This is essentially a Bayesian version of the Howard methods that allows for more appropriate and defensible sharing of information between areas, handles missing data in a more appropriate manor, accurately propagates uncertainty throughout the estimation procedure and replaces the Howard decision tree approach to low sample sizes with a hierarchical model. The methods and results for generating harvest estimates are generally consistent between the Bayesian model and the Howard methods. Harvest estimates are consistent with Howard estimates during contemporary times, but may differ based on more appropriate weighting of SWHS and logbook data, including estimating and correcting bias in the SWHS data. 

The Bayesian methods depart from the Howard method in how releases are estimated. The Howard methods assume that the species composition of the harvests are equal to the species composition of released fish, which is clearly contraindicated in the logbook data. For instance, logbook data demonstrates that yelloweye have been retained at high levels up until restrictions were enacted in recent years, whereas pelagic rockfish were released in significant numbers in the past with retention increasing in recent years as they have become more prized by anglers. Recent prohibition on retaining yelloweye in Southeast Alaska highlights the shortcomings of the original Howard assumptions as the species composition of the harvest would indicate that no yelloweye were caught and released during the closure. 

The Howard method for estimating releases for private anglers also relied on an expansion of the logbook release estimates based on the ratio of private:guided releases of all rockfish in the SWHS. In addition to the faulty assumptions about species composition, this method ignores potential bias in SWHS estimates of harvests and releases or at least assumes that the bias in release and harvests are the same. As demonstrated in Figure 1, the bias in those two quantities appears to be quite different based on the logbook data. The Bayesian model thus attempts to estimate release probabilities based on the logbook data coupled with bias corrected estimates from the SWHS.

Lastly, the Howard methods were only used on data beginning in 1999 with the advent of the logbook program and estimates of harvests and releases prior to that have been based on linear ramps from 1999 back to the perceived start of the fishery. The Bayesian methods allow us to expand the time series back to 1977 when the SWHS was implemented by leveraging regional data trends in species composition and the proportion of caught rockfish harvested by species and/or species complex. Key advantages of the Bayesian approach are highlighted in table 1. 

```{r, echo=FALSE}
library(knitr)

# Create a data frame for the table
my_table <- data.frame(
  Issue = c("Time series","Bias in SWHS", "Species composition of releases", "Sample size limitations", "Error propogation"),
  Howard = c("1999 - present","Not explicitly dealt with. Relies on logbook data and ratios of guided/unguided from SWHS data to estimate unguided releases and harvests.", 
              "Assumes that species composition of releases is equal to that of the harvest, which is not evident in the logbook data.",
             "Uses sample size threshholds such that when areas fall below those threshholds values are borrowed from nearby areas.",
             "Error is propogated when variance estimates are available, but there is uncertainty associated with borrowing values from nearby areas, or the assumption of species compositions being identical in harvest and releases, are not dealt with."),
  Bayes = c( "1977 - present","Explicitly estimates bias in SWHS harvest and release estimates based on logbook data.",
              "Recognizes different release probabilities by species / species assemblage and estimates it from logbook data and bias corrected SWHS data",
            "Uses a hierarchichacal modelling approach that shares information between areas in the same region. Thus all data is used, even with small sample sizes. This is a more sound method that avoids assumptions and uses all of the data. ",
            "By breaking the assumption that species composition is equal between harvests and releases, uncertainty in the release estimates is more reflective of the fishery. Furthermore, the hyerarchichal approach more accurately captures uncertainy within and between areas within a region.")
)

# Print the table
kable(my_table, caption = "**Table 1.** Summary of key improvements in reconstructiing sport fish removals of rockfish using the Bayesian model as compared to the Howard et al. (2020) methods.") %>%
  kable_styling(full_width = FALSE) %>%
  column_spec(1, width = "3cm") %>%
  column_spec(2, width = "6cm") %>%  # Set width for Column 2
  column_spec(3, width = "6cm")      # Set width for Column 3
```

## Data
Harvest data was available for 22 commercial fishing management areas in Southcentral and Southeast Alaska. Areas with negligible rockfish harvest were pooled with adjacent areas for analysis. Specifically the Aleutian and Bering areas were pooled into an area labeled BSAI; the IBS and EKYT were pooled into an area labeled EKYKT; the Southeast, Southwest, SAKPEN and Chignik areas were pooled into an area labeled SOKO2PEN and the Westside and Mainland areas were pooled into an area labeled WKMA.

### Stateside Harvest Survey (SWHS)
Statewide harvest survey estimates of rockfish catch and harvest are available for 28 years (1996-2023) for all users and for 13 years (2011-2023) for guided anglers (Figure 0). Additionally, there are overall harvest estimates from 1977- 1995 and release estimates from 1990-1995 that required some partitioning to ascribe to current management units. Harvests in unknown areas were apportioned based on harvest proportions in 1996. Variance estimates are not available for pre-1996 data and as such, the maximum observed coefficient of variation (cv) in each commercial fisheries management unit was applied to the pre-1996 values. 

```{r, fig.width = 11.5, fig.height = 5, fig.cap = paste0("**Figure ",X,".**- Data sources for estimating rockfish harvests and releases in ADF&G commercial fisheries management units. Note that initial rockfish harvest estimates were not differentiated into species assemblage or species until 1998 when logbooks began differentiating by pelagic and non-pelagic. Logbooks began to collect data on yelloweye beginning in 2006. Port sampling programs to gather data on species composition of harvests began in 1996 in Southcentral and Kodiak and in 2006 in Southeast.")}

data_source_order <- c(
  "SWHS total rf harvests",
  "SWHS total rf releases",
  "SWHS rf harvest by user group",
  "SWHS rf releases by user group",
  "Logbook total rf charter harvests",
  "Logbook pelagic charter harvests",
  "Logbook yelloweye charter harvests",
  "Logbook total rf charter releases",
  "Logbook pelagic charter releases",
  "Logbook yelloweye charter releases",
  "Central and Kodiak species composition data",
  "Southeast species composition data"
)

rbind(cbind(year = as.numeric(unique(Hhat_ay$year)),
      data = rep("SWHS total rf harvests",length(unique(Hhat_ay$year)))),
      
      cbind(year = as.numeric(unique(Rhat_ay$year)),
      data = rep("SWHS total rf releases",length(unique(Rhat_ay$year)))),
      
      cbind(year = as.numeric(unique(Hhat_ayu$year)),
      data = rep("SWHS rf harvest by user group",length(unique(Hhat_ayu$year)))),
      
      cbind(year = as.numeric(unique(Rhat_ayu$year)),
      data = rep("SWHS rf releases by user group",length(unique(Rhat_ayu$year)))),
      #Logbook
      cbind(year = as.numeric(unique(H_ayg$year)),
      data = rep("Logbook total rf charter harvests",length(unique(H_ayg$year)))),
      
      cbind(year = as.numeric(unique(H_ayg$year[!is.na(H_ayg$Hp)])),
      data = rep("Logbook pelagic charter harvests",length(unique(H_ayg$year[!is.na(H_ayg$Hp)])))),
      
      cbind(year = as.numeric(unique(H_ayg$year[!is.na(H_ayg$Hye)])),
      data = rep("Logbook yelloweye charter harvests",length(unique(H_ayg$year[!is.na(H_ayg$Hye)])))),
      
      cbind(year = as.numeric(unique(R_ayg$year)),
      data = rep("Logbook total rf charter releases",length(unique(R_ayg$year)))),
      
      cbind(year = as.numeric(unique(R_ayg$year[!is.na(R_ayg$Rp)])),
      data = rep("Logbook pelagic charter releases",length(unique(R_ayg$year[!is.na(R_ayg$Rp)])))),
      
      cbind(year = as.numeric(unique(R_ayg$year[!is.na(R_ayg$Rye)])),
      data = rep("Logbook yelloweye charter releases",length(unique(R_ayg$year[!is.na(R_ayg$Rye)])))),
      #comp
      cbind(year = as.numeric(unique(comp$year[comp$region != "Southeast"])),
      data = rep("Central and Kodiak species composition data",length(unique(comp$year[comp$region != "Southeast"])))),
      
      cbind(year = as.numeric(unique(comp$year[comp$region == "Southeast"])),
      data = rep("Southeast species composition data",length(unique(comp$year[comp$region == "Southeast"]))))) %>% data.frame() -> data_available
  
  ggplot(data = data_available,
         aes(x = as.numeric(year), y = factor(data, levels = rev(data_source_order)))) + 
  geom_point(size = 4, shape = 21, fill = "darkgrey") + 
  theme_bw(base_size = 16) +
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
    axis.text.y = element_text(size = 12)) +
  scale_x_continuous(
    breaks = seq(start_yr, end_yr, by = 2) # Adjust for every other year
  ) +
  labs(y = "Data Sources", x = "Year")
  
ggsave("../figures/bayes_model/data_plot.png")  

X <- X+1
```
<br>

SWHS estimates are believed to be biased to some degree. These modelling efforts aim to estimate and correct for that bias with the assumption that logbook records are a census of guided harvests and releases.

SWHS Rockfish release estimates are inferred from the difference between catch and harvest estimates. 

Adam noted that the first 5 years (23 years counting the historical data) in the SWHS data set for PWSO seem unreasonable (close to zero and not corroborated with logbook estimates). Adam recommended setting these harvests to unknown, but current model development has included the data. Once a satisfactory model has been identified we will exam the effects of censoring the PWSO data. 

### Creel Surveys
NA  

### Guide Logbooks
Sport fishing guides have been required to report their harvest of rockfish for 26 years (1998-2023). Reported harvest is also available by assemblage (pelagic vs. non-pelagic). Harvest of yelloweye and "other" (non-pelagic, non-yelloweye) rockfish were reported separately beginning in 2006. 

Logbooks also record the number of rockfish released for the same categories. However, the reliability of the release data is somewhat questionable as reported releases are generally far lower than that estimated by the SWHS. As such several treatments of the data are considered.  

### Logbook versus SWHS estimates
Estimates of guided harvests and releases from the SWHS do not align with the census from charter logbooks. Logbook harvest reports are generally considered reliable and are used to assess the bias in SWHS reports. However, there is even greater disparity between release estimates in the two sources and it is debatable whether logbook releases should be treated as a census. The Howard et al. (2020) methods do treat the logbook release data as "true" and thus are considerably less than would be estimated from the SWHS data. 

```{r, fig.width = 11.5, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- SWHS harvest (left) and release (right) estimates from guided trips (x-axis) versus repoted harvests from charter logbooks (y-axis).")}
pal <- wes_palette(name = "Zissou1Continuous", type = "continuous", n = 16)

left_join(H_ayg, Hhat_ay, by = c("area", "year", "region")) %>%
  mutate(area = toupper(area),
         area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
  ggplot(aes(H_lb, Hhat, color = area)) +
  geom_abline() +
  geom_point() +
  stat_smooth(method = "lm", formula = y ~ x) +
  scale_color_manual(values = pal) +
  facet_grid(region ~ ., scales = "free") + theme_bw(base_size = 16) +
  theme(plot.margin = margin(t = 20, r = 5, b = 5, l = 5)) +
  labs(x="Logbook harvests", y = "SWHS estimates") -> Hcomp

left_join(Chat_ayu %>% filter(user == "guided"), 
          Hhat_ayu %>% filter(user == "guided"),
          by = c("area", "year", "region")) %>%
  select(year, area, region, gChat = Chat, gHhat = Hhat) %>%
  mutate(gRhat = gChat -gHhat) %>%
  select(year,area,region,Rhat = gRhat) %>%
  left_join(R_ayg %>% select(year,area,region,R),
            by = c('area',"year","region")) %>%
  mutate(area = toupper(area),,
         area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
  ggplot(aes(R, Rhat, color = area)) +
  geom_abline() +
  geom_point() +
  stat_smooth(method = "lm", formula = y ~ x) +
  scale_color_manual(values = pal) +
  facet_grid(region ~ ., scales = "free") + theme_bw(base_size = 16) +
  theme(plot.margin = margin(t = 20, r = 5, b = 5, l = 5)) +
  labs(x="Logbook releases", y = "") -> Ccomp

ggarrange(Hcomp,Ccomp,
          labels = c("Harvests","Releases"),
          ncol=2, common.legend = TRUE, label.y = 1.01, legend = "bottom")

ggsave("../figures/bayes_model/raw_bias.png") 
X <- X+1
```
<br>

#### *A note on model development*

To evaluate the discrepancy in apparent bias in harvest and release data, several models were explored to estimate releases during model development. One method ($LB_{fit}$) considers the logbook release data to be reliable and a second method ($LB_{cens}$) treated the logbook release data as estimates of the minimum released, thus giving more weight to SWHS release estimates. A third method ($LB_{hyb}$) is a hybrid approach that treats reported releases of yelloweye as reliable but total rockfish and pelagic rockfish releases as minimums. Model development revealed a tension between the total and pelagic logbook releases and the yelloweye logbook releases. This tensions eventually highlighted the different release/retention probabilities between yelloweye and pelagics in the logbook data and prompted the current approach whereby that probability was calculated for the three main species complexes covered in the data: pelagics, yelloweye, and "other". The methods described here follow the ($LB_{fit}$) formulation. Based on model behavior it is unlikely that the ($LB_{cens}$) model would work as there would not be enough data to estimate release probabilities. However, it may be worth running the ($LB_{hyb}$) approach as a sensitivity test at the very least. 

### Composition data
Harvest sampling data exists from Gulf of Alaska areas since 1996 and from Southeast Alaska areas since 2006. Port sampling data is comprised of the number of total rockfish, pelagic and non-pelagic rockfish, black rockfish and yelloweye rockfish. In Southeast Alaska, the number of Demersal Shelf Rockfish (DSR, of which yelloweye are one species) and slope rockfish are also recorded.

## Process equations
The true harvest $H_{ay}$ of rockfish for area $a$ during year $y$ is assumed to follow a temporal trend defined by a penalized spline:

\begin{equation}
\textrm{log}(H_{ay})~\sim~\textrm{Normal}(f(a,y), {\sigma_H})
\end{equation} 

where $f(a,y)$ in a p-spline basis with 7 components (knots) and a second degree penalty. The variance, $\sigma_H$,  was given a normal prior with a mean and standard deviation of 0.25 and 1, respectively. 

Charter and private harvest $H_{ayu}$ (where *u* = 1 for charter anglers and *u* = 2 for private anglers) is a fraction of total annual harvest in each area:

\begin{equation}
H_{ay1}~=~H_{ay}P_{(user)ay1}\\H_{ay2}~=~H_{ay}(1-P_{(user)ay1})
\end{equation}

where $P_{(user)ay1}$ is the fraction of the annual harvest in each area taken by charter anglers.  $P_{(user)ay1}$ was modeled hierarchically across years as:

\begin{equation}
P_{(user)ay1}~\sim~\textrm{beta}(\lambda1_a, \lambda2_a)
\end{equation}

with non-informative priors on both parameters.

Annual black rockfish harvest $H_{(black)ayu}$ for each area and user group is:

\begin{equation}
H_{(black)ayu}~=~H_{ayu}P_{(pelagic)ayu}P_{(black|pelagic)ayu}
\end{equation}

where $P_{(pelagic)ayu}$ is the fraction of the annual harvest for each area and user group that was pelagic rockfish and $P_{(black|pelagic)ayu}$ is the fraction of the annual harvest of pelagic rockfish for each area and user group that was black rockfish.

The southeast region also tracks two other non-pelagic rockfish assemblages, demersal shelf rockfish (DSR, which includes yelloweye) and slope rockfish. For the southeast region the harvest of those two assemblages is thus

\begin{equation}
H_{(DSR)ayu}~=~H_{ayu}(1-P_{(pelagic)ayu})P_{(DSR|non-pelagic)ayu}\\
H_{(slope)ayu}~=~H_{ayu}(1-P_{(pelagic)ayu})P_{(slope|non-pelagic)ayu}\\
\end{equation}

where $P_{(DSR|non-pelagic)ayu}$ and $P_{(slope|non-pelagic)ayu}$ are the fractions of the annual harvest of non-pelagic rockfish for each area and user group that were DSR and slope rockfish, respectively. 

Annual yelloweye rockfish harvest $H_{(yelloweye)ayu}$ for each area and user group is calculated differently for central/Kodiak areas and southeast areas. For central and Kodiak areas yelloweye rockfish harvests are calculated as

\begin{equation}
H_{(yelloweye)ayu}~=~H_{ayu}(1-P_{(pelagic)ayu})P_{(yelloweye|non-pelagic)ayu}
\end{equation}

where $P_{(yellow|non-pelagic)ayu}$ is the fraction of the annual harvest of non-pelagic rockfish for each area and user group that was yelloweye rockfish.

For southeast areas yelloweye harvests are a fraction of the DSR harvests such that

\begin{equation}
H_{(yelloweye)ayu}~=~H_{(DSR)ayu}P_{(yelloweye|DSR)ayu}
\end{equation}

The composition parameters $P_{(comp)ayu}$, were modeled using a logistic curve that would allow hindcasting without extrapolating beyond the limit of observed values such that:

\begin{equation}
\textrm{logit}(P_{(comp)ayu})~=~\beta0_{(comp)ayu} + \frac{\beta1_{(comp)ayu}}{(1 + exp(\beta2_{(comp)ayu}*(y - \beta3_{(comp)ayu})))} + \beta4_{(comp)ayu}*I(u=private)+re_{(comp)ayu}
\end{equation}

where the $\beta$ parameters define the intercept, scaling factor, slope, inflection point and private angler effect, respectively, $y$ is the year index, $I(u=private)$ is an index variable which is 1 when the user groups is private and 0 otherwise and $re_{(comp)ayu}$ is a random effect with a non-informative prior. $\beta$ parameters were modeled hierarchically by region. When $\beta$ parameters were inestimable as a result of no discernible change in composition over the observed time period. $\beta1$ (scaling factor) and $\beta2$ (slope) were fixed to 0 so that the long term mean value was used for hindcasting. 

The true number of released rockfish $R_{ayu}$ were based on the proportion of the total catch harvested, $pH_{(comp)ayu}$, by area, year, user group and species grouping. Because release data from the SWHS is for all rockfish and the release data from logbooks is only subdivided into pelagics, yelloweye and "other" (non-pelagic, non-yelloweye), we only estimated $pH_{(comp)ayu}$ for those categories. Thus, converting $H_{(comp)ayu}$ to total catches by user group, $C_{(comp)ayu}$, with $pH_{(comp)ayu}$ results in estimates of total releases such that

\begin{equation}
R_{(comp)ayu}~=~ C_{(comp)ayu} - H_{(comp)ayu} ~=~ \frac{H_{(comp)ayu}}{pH_{(comp)ayu}} - H_{(comp)ayu}
\end{equation} 

with total releases equal to the sum of the compositional releases. For non-yelloweye DSR and Slope rockfish assemblages in Southeast Alaska $R_{(DSR)ayu}$ and $R_{(slope)ayu}$ were estimated from $R_{(other)ayu}$ using the species composition data from the harvest, thus assuming that slope and DSR assemblages were caught and released at the same rates.

The proportion harvest parameters for $pH_{(comp)ayu}$ were modeled using a logistic curve that would allow hindcasting based on trends in the data without extrapolating beyond the range of observed values such that

\begin{equation}
\textrm{logit}(pH_{(pH)ayuc})~=~\beta0_{(pH)ayu} + \frac{\beta1_{(pH)ayuc}}{(1 + exp(\beta2_{(pH)ayuc}*(y - \beta3_{(pH)ayuc})))} + \beta4_{(pH)ayuc}*I(u=private)+re_{(pH)ayuc}
\end{equation}

A random effect term allowed estimation during the historical period when data is available, but the curve defined by the above equation determined release estimates between 1977 and 1990. As with the compositional trends, $\beta$ parameters were modeled hierarchically by region. When $\beta$ parameters were inestimable as a result of no discernable change in harvest probability over the observed time period, $\beta1$ (scaling factor) and $\beta2$ (slope) were fixed to 0 so that the long term mean value was applied. 

Release mortality (i.e., the number of released rockfish expected to die) was calculated assuming fixed mortality rates developed in each of the regions. Deep water release (DWR) devices were mandated for charter fleets in 2013 and rates were derived from CITATION. Southeast applies basic rates estimated in these studies while Southcentral and Kodiak rates were derived by using historical depth-of-release data to adjust the rates based on area and user group.

The total number of mortalities by year, area, user and species/species assemblage in numbers was calculated by summing harvests and release mortality such that

\begin{equation}
M_{(comp)ayu}~=~ H_{(comp)ayu} + m_{R-(comp)ayu} * R_{(comp)ayu}
\end{equation} 

where $m_{R-(comp)ayu}$ is the release mortality rate by year, area, user and species (Figure XX). 

Total removals in biomass were converted using the average weight of fish **from port sampling?**. A minimum sample size per year of **X** fish was used as the cutoff for including in the data set. Weights were modeled hierarchically to estimate weights in years when data was missing. The total biomass of removals by year, area, user and species was thus

\begin{equation}
B_{(comp)ayu}~=~ \overline{wt}_{(comp)ayu} * M_{(comp)ayu}
\end{equation}

where $\overline{wt}_{(comp)ayu}$ is the mean weight by species, area, user and year. 


## Observation equations
SWHS estimates of annual rockfish **harvest** $\widehat{SWHS}_H{ay}$ were assumed to index true harvest:

\begin{equation}
\widehat{SWHS}_H{ay}~\sim~\textrm{LogNormal}\left(\textrm{log}(H_{ay}b_{ay}), \sigma_{SWHSHay}^2\right)
\end{equation}

where bias in the SWHS harvest estimates $b_H{ay}$ is modeled hierarchically across years as:

\begin{equation}
b_H{ay}~\sim~\textrm{Normal}(\mu_H{(b)a}, \sigma_H{(b)a})
\end{equation}

with non-informative priors on both parameters. 

SWHS estimates of guided angler harvest $\widehat{SWHS}_H{ay1}$ are related to total harvest by:

\begin{equation}
\widehat{SWHS}_H{ay1}~\sim~\textrm{LogNormal}\left(\textrm{log}(H_{ay1}b_{ay}), \sigma_{SWHS_{ay1}}^2\right)
\end{equation}

Reported guide logbook harvest $\widehat{LB}_H{ay}$ is related to true harvest as:

\begin{equation}
\widehat{LB}_H{ay}~\sim~\textrm{Poisson}(H_{ay1})\\
\widehat{LB}_H{(pelagic)ay}~\sim~\textrm{Poisson}(H_{ay1}P_{(pelagic)ay1})\\
\widehat{LB}_H{(yelloweye)ay}~\sim~\textrm{Poisson}(H_{(yelloweye)ay1})\\
\widehat{LB}_H{(nonpel,nonye)ay}~\sim~\textrm{Poisson}(H_{(nonpel,nonye)ay1})\\
\end{equation}

Note that for central and Kodiak areas $H_{(nonpel,nonye)ay1}$ is equal to the total harvest minus pelagic and yelloweye harvests. For southeast areas $H_{(nonpel,nonye)ay1}$ is equal to the sum of the DSR and slope harvests *minus* yelloweye harvests.

SWHS estimates of annual rockfish **releases** $\widehat{SWHS}_R{ay}$ were assumed to index true releases in a similar fashion and thus modeled similarly. As such, the release data are related to true releases just as harvests were modeled such that:

\begin{equation}
\widehat{LB}_R{ay}~\sim~\textrm{Poisson}(R_{ay1})\\
\widehat{LB}_R{(pelagic)ay}~\sim~\textrm{Poisson}(R_{ay1}P_{(pelagic)ay1})\\
\widehat{LB}_R{(yelloweye)ay}~\sim~\textrm{Poisson}(R_{(yelloweye)ay1})\\
\widehat{LB}_R{(nonpel,nonye)ay}~\sim~\textrm{Poisson}(R_{(nonpel,nonye)ay1})\\
\end{equation}

Because logbook release data is more questionable and demonstrates greater disagreement with SWHS estimates (Figure 1), a second approaches was considered that loosened the assumption that logbook releases were a census. Methods explored to develope $LB_{hyb}$ and $LB_{cens}$ models are detailed at the end of this section. 

SWHS estimates of guided angler release $\widehat{SWHS}_R{ay1}$ is modeled the same as harvests. 

SWHS release bias was modeled independently of the harvest bias $b_H{ay}$ such that

\begin{equation}
b_R{ay}~\sim~\textrm{Normal}(\mu_R{(b)a}, \sigma_R{(b)a})
\end{equation}

where bias in the SWHS release estimates $b_R{ay}$ is modeled hierarchically across years as:

\begin{equation}
b_R{ay}~\sim~\textrm{Normal}(\mu_R{(b)a}, \sigma_R{(b)a})
\end{equation}

with non-informative priors on both parameters.

The number of pelagic rockfish sampled in harvest sampling programs $x_{(pelagic)ayu}$ follow a binomial distribution:

\begin{equation}
x_{(pelagic)ayu}~\sim~\textrm{Binomial}(P_{(pelagic)ayu}, N_{ayu})
\end{equation}

where $N_{ayu}$ is the total number of rockfish sampled in area $a$ during year $y$ form user group $u$. The number of black rockfish sampled in harvest sampling programs was thus a proportion of the pelagic harvests

\begin{equation}
x_{(black)ayu}~\sim~\textrm{Binomial}(P_{(black)ayu}, N_{ayu}^{pel})
\end{equation}

Yelloweye rockfish in Southcentral and Kodiak were modeled similarly as a proportion of the total number of non-pelagics such that 

\begin{equation}
x_{(yellow_{R2})ayu}~\sim~\textrm{Binomial}(P_{(yellow_{R2})ayu}, N_{ayu}^{nonpel})
\end{equation}

Southeast areas have several other non-pelagic groupings such that DSR and slope rockfish are a proportion of non-pelagics

\begin{equation}
x_{(DSR)ayu}~\sim~\textrm{Binomial}(P_{(DSR)ayu}, N_{ayu}^{nonpel})
\end{equation}

and

\begin{equation}
x_{(slope)ayu}~\sim~\textrm{Binomial}(P_{(slope)ayu}, N_{ayu}^{nonpel})
\end{equation}

with yelloweye in southeast a proportion of the DSR harvest

\begin{equation}
x_{(yellow_{R1})ayu}~\sim~\textrm{Binomial}(P_{(yellow_{R1})ayu}, N_{ayu}^{DSR}).
\end{equation}.

Kodiak has limited port sampling beyond the main harbors but has a robust hydroacoustic survey that is used to quantify black rockfish abundance across the management area and uses  stereocameras to derive species compositions of the hydroacoustic data. This data was used as supplementary data to further inform the model to the proportion of pelagic rockfish that are black in Kodiak areas. Angler landings in Kodiak show a higher proportion of black rockfish relative to the hydroacoustic survey and thus the proportion of black rockfish in the hydroacoustic sample related to the true proportion such that 

\begin{equation}
P_{(black|pelagic)ayu}^{HA} ~\sim~ P_{(black|pelagic)ayu} + ae_{au}
\end{equation}.

where $ae_{au}$ is the angler effect for each area and user group modeled hierarchically around a mean of 0. Predicted $P_{(black|pelagic)ayu}^{HA}$ assumed a beta distribution such that

\begin{equation}
P_{(black|pelagic)ayu}^{HA} ~\sim~ beta(\alpha_{HA},\beta_{HA})
\end{equation}

where

\begin{equation}
\alpha_{HA} ~=~ (P_{(black|pelagic)ayu}^{HA})^2 * \frac{1 - P_{(black|pelagic)ayu}^{HA}}{\frac{var_{P_{HA}}-1}{P_{(black|pelagic)ayu}^{HA}}},
\end{equation}

\begin{equation}
\beta_{HA} ~=~ (\alpha_{HA}) * \frac{1}{P_{(black|pelagic)ayu}^{HA} - 1},
\end{equation} 

\begin{equation}
var_{P_{HA}} ~=~ (P_{(black|pelagic)ayu}^{HA} * cvP_{(black|pelagic)ayu}^{HA})^2
\end{equation} 

where $cvP_{(black|pelagic)ayu}^{HA}$ is the coefficient of variation for the hydroacoustic proportions 

\begin{equation}
cvP_{(black|pelagic)ayu}^{HA} ~=~ \frac{\sqrt{varP_{(black|pelagic)ayu}^{HA}}}{P_{(black|pelagic)ayu}^{HA}}
\end{equation}

and the variance is approximated using the XXXX method as 

\begin{equation}
varP_{(black|pelagic)ayu}^{HA} ~=~ (\frac{1}{n_{pel}})^2 * varN_{black} + (\frac{n_{black}}{n_{pel}^2}) * varN_{pel}
\end{equation}

where $varN_{black}$ and $varN_{black}$ are the variance of the estimated number of black and pelagic rockfish in the hydroacoustic survey, respectively (CITATION). 

The average weight of rockfish by species, user, area and year was modeled hierarchically at several levels within regions such that

\begin{equation}
wt_{(comp)ayu} ~\sim~ Normal(wt_{(comp)au},\sigma_{wt_{(comp)au}}) ~\sim~ Normal(wt_{(comp)a},\sigma_{wt_{(comp)a}}) ~\sim~ Normal(wt_{(comp)region},\sigma_{wt_{(comp)region}})
\end{equation}

where *region* refers to Kodiak, Southcentral and Southeast. Mean weights and variance were calculated as **XXX**.

#### Alternative likelihoods for release estimates

To loosen the assumption that logbook release data are an effective census of true releases I explored models that treated logbook release estimates as a lower bound on the estimate of true releases. In a hybrid approach yelloweye and non-pelagic releases are regarded as a reliable census (given the emphasis and ease of recording these fish) but censors the pelagic and total rockfish release estimates (where censoring implies NA values) such that

\begin{equation}
\text{censored} \widehat{LB}_R{ay}~\sim~\textrm{LogNormal}\left(\log(R_{ay}), 1\right)\text{T}\left(\widehat{LB}_R{ay}, \infty\right) \\
\text{censored} \widehat{LB}_R{(pelagic)ay}~\sim~\textrm{LogNormal}\left(\log(R_{(pelagic)ay}), 1\right)\text{T}\left(\widehat{LB}_R{(pelagic)ay}, \infty\right) \\
\widehat{LB}_R{(yelloweye)ay}~\sim~\textrm{Poisson}(R_{(yelloweye)ay1})\\
\widehat{LB}_R{(nonpel,nonye)ay}~\sim~\textrm{Poisson}(R_{(nonpel,nonye)ay1})\\
\end{equation}

This model formulation failed such that there was not enough data to inform pelagic releases and the values did not seem valid. A second approach is being explored that fits the censored data using a lognormal distribution centered around the logbook release value, but also with a lower bound equal to the number of recorded releases such that

\begin{equation}
\widehat{LB}_R{ay}~\sim~\textrm{LogNormal}\left(\log(R_{ay}), \sigma_{Ray1}^2\right)\text{T}\left(\widehat{LB}_R{ay}, \infty\right) \\
\widehat{LB}_R{(pelagic)ay}~\sim~\textrm{LogNormal}\left(\log(R_{(pelagic)ay}), \sigma_{Ray1}^2\right)\text{T}\left(\widehat{LB}_R{(pelagic)ay}, \infty\right) \\
\widehat{LB}_R{(yelloweye)ay}~\sim~\textrm{Poisson}(R_{(yelloweye)ay1})\\
\widehat{LB}_R{(nonpel,nonye)ay}~\sim~\textrm{Poisson}(R_{(nonpel,nonye)ay1})\\
\end{equation}

Logbook data is assumed to be a census and as such there is no estimate of uncertainty. As of this writing, several methods are being examined for how to treat $\sigma_{Ray1}^2$. Models are being run that attempt to allow the model to estimate $\sigma_{Ray1}^2$ with priors. A simple model applies a uniform prior (0.1,50) to $\sigma_{Ray1}^2$. A hierarchichal approach based on regions is also being examined whereby $\sigma_{Ray1}^2$ is lognormally distributed around hyper priors $\mu_{\sigma_R}$ and $\sigma_{\sigma_R}$. Initial efforts have applied a uniform prior on $\mu_{\sigma_R}$ between 1 and 50 and on $\sigma_{\sigma_R}$ between 0 and 10.  

### Priors.
Priors range from uninformative to very informative or fixed. Priors for compositional logistic parameters are in Table 2 and proportion harvest logistic parameters are in Table 3. *Until I figure out how to make a nice table in Rmarkdown, please refer to the attached spreadsheet and comp and harvp tabs.*

```{r, echo=FALSE}
#comp_priors <- read_xlsx("model_priors.xlsx", sheet = "comp_mdwn", guess_types = FALSE) %>% data.frame()
#comp_priors <- comp_priors %>% fill(Species_Complex, .direction = "down") %>%
#  fill(Parameter, .direction = "down") %>% fill(Definition, .direction = "down") %>%
#  mutate(Species_Complex = ifelse(duplicated(Species_Complex) & !is.na(Species_Complex), NA, Species_Complex))
  

#knitr::kable(comp_priors, format = "html")  %>%
#  kable_styling() %>%
#  row_spec(1:nrow(comp_priors), extra_css = "text-align: center;") %>%
  #column_spec(2, width = "3em", background = "lightblue") %>%
#  collapse_rows(columns = 1, valign = "middle")
```
 
### Unresolved issues and outstanding questions: 

1. *Reliability of unguided release estimates:* These estimates have the least information feeding them and rely on the bias-corrected SWHS release estimates of all rockfish and the trends in release probability evident in the logbook data. The $\beta4$ term that estimates the guided/unguided effect was given a very informative prior that tied the release probability of private anglers tightly to that of the charter fleet. The model is then trying to balance the three species complex estimates (pelagic, yelloweye and other) so that they sum to the total unguided releases estimated from the bias corrected SWHS data. For the most part this seems reasonable and appears to work, but there are certain areas where the estimates are "wonky":
    1. Total rockfish releases more or less align with the total releases estimated with the Howard methods. Presumably, much of the discrepancy results from the substantial bias in release estimates from the SWHS. Interestingly, the logbook data indicates that the SWHS underestimates harvests but overestimates releases by a significant factor (Figure 23 and 24 below).
    2. In general, release estimates of black rockfish are substantially lower than those calculated using the Howard methods. Presumably, much of this derives from the bias correction of the SWHS release estimates. 
    3. Yelloweye release estimates also differ considerably from the Howard estimates, but unlike black rockfish are sometimes lower and sometimes higher. Two areas in particular are a little head scratching. Yelloweye releases in the Kodiak Northeast area in particular are significantly lower than for guided anglers with the same pattern evident in Cook Inlet to a lesser extent. Cook Inlet yelloweye numbers are very small, so this is a sample size issue with little consequence. The cause of the Kodiak northeast estimates is not clear to me at this point, but the model estimates the proportion harvested by unguided anglers to be much lower than that of guided anglers, even with the informative prior on $\beta4$. This must be a product of the bias corrected SWHS release estimates and how the model is partitioning that estimate into the 3 species complexes, but itis a bit a of head scratcher. 

2. *Proportion guided estimates:* There is not much data on this proportion prior to 2011 and it is not modeled with any sort of trend as was done for species composition and harvest proportions. With the exception of Cook Inlet and North Gulf Coast areas, there is little, if any, trend apparent in the data and perhaps this approach is the best available given the data available. However, if there are data sources somewhere that could inform this part of the model they could be incorporated. 

3. *Prior choices* in general need to be vetted. The priors on the logistic curves are fairly informed in an effort to achieve the desired shapes for hindcasting. Ideally, sensitivity testing would occur but the model is very slow to converge. The beta parameters on the logistic curves have required a lot of work on the priors to reach convergence. 

4. *Proportion harvest estimates for non-pelagic, non-yelloweye in Kodiak WKMA:* I need to adjust the prior on the inflection point, $\beta3$, so that it is forced to occur after 2006. Right now the model is estimating inflection in two Kodiak areas before that point where there is no data to justify a shift. The current inflection is a result of the hierachichal model. 

5. *Proportion pelagic in PWS and CSEO:* The parameters for these particular proportions are very slow to converge. For the CSEO, the estimates of the $\beta$ parameters are similar to the other Southeast areas, but the mixing is poor over the length of the chains. In this case I think they will ultimately converge with a very long model run and the shape of the curve in the model output looks acceptable. For the two PWS areas the model seems to struggle with the disparate proportional data from the logbook and the port sampling. There is some wandering in the chains of the $\beta0$ and $\beta1$ terms and spikiness in the $\beta2$ terms. I've been working on constraining the hyperpriors for PWS $beta2$. Similar to CSEO, it may just entail a very long model run to reach convergence, but the shape of the curves looks reasonable.

### Next steps:

Once the model is finalized, harvest and release numbers need to be converted into biomass removals. This is a two step process where release mortality estimates are applied to the release estimates to estimate the number of released rockfish that do not survive. This is based on studies and will reflect the values that the department has been using with the Howard methods. Region 2 (both Southcentral and Kodiak) have release-at-depth estimates from a number of years that they apply across all years and then calculate mortality rates based on those estiates. Southease does not have release-at-depth data and simply applies an assumed rate based on research.

Once release mortality is calculated average weight data is applied to convert numbers to biomass. The plan is to incorporate all of this into the model to propogate uncertainty into the posteriors. However, the model already takes a long time to run and I may explore a simpler approach using the posteriors from the numbers model to speed up processing. 

 
# Results
* **Model:** *`r mod`* 
* **Model Run:** *`r res`* (Naming convention: modelname_thruYEAR_iters_rundate)
```{r}
rhat <- get_Rhat(postH, cutoff = 1.11)
names(rhat)[1] <- "Rhat_values"
all_rhat <- get_Rhat(postH,cutoff = 0.01)
names(all_rhat)[1] <- "Rhat_values"
as.vector(all_rhat$Rhat_values) %>% data.frame()-> rhat_vals
prop_conv <- round(nrow(rhat_vals %>% filter(Rhat <= 1.115))/nrow(rhat_vals),4)
```
* **Proportion of parmaters converged (Rhat <= 1.1):** `r prop_conv`
* *See end of document for summary of unconverged parameters.*

```{r, fig.width = 6, fig.height = 2, fig.cap = "**Figure X.**- Rhat values and proportion of parameters that converged (Rhat < 1.1.)"}
rhat_vals %>% data.frame() %>%
  ggplot(aes(Rhat)) + 
  geom_histogram(binwidth=0.01, colour="black", fill="white") +
  geom_vline(aes(xintercept = 1)) 
```
  
## Estimate comparison
Since previous estimates of rockfish harvest have been produced these first 3 graphs will be used to show how the modeled estimates compare to the estimates produced earlier. For total rockfish the estimates are in general agreement although differences are noted. These estimates should be more reliable because they include both SWHS and guide logbook data, handle variance more appropriately, use hierarchical distributions when data is missing, directly consider observation error and are produced using reproducible research. 

```{r, fig.width = 10, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Total rockfish harvests 1996-2023. Lines and error polygons represent model estimates and points and error bars represent Howard et al estimates.")}
tot_how <- readxl::read_excel(paste0("..\\output\\harvest_estimates_Howard_thru",REP_YR,".xlsx"),
                              sheet = "BRF harvest",
                              range = "A1:N400") %>%
  #read.csv(paste0("..\\output\\harvest_estimates_Howard_thru",REP_YR,".csv")) %>%
  clean_names() %>% filter(year <= end_yr) %>%
  mutate(tot_rf = log_rfharv + priv_rfharv) %>%
  select(region,year,area = rpt_area, gui_tot = log_rfharv,pri_tot=priv_rfharv,var = var_priv_rfharv, tot_rf) 

tot_how %>% select(-var) %>%
  pivot_longer(cols = c("gui_tot","pri_tot","tot_rf"),
               names_to = "user",
               values_to = "H_how") %>%
  mutate(user = ifelse(user == "gui_tot","guided",
                       ifelse(user == "pri_tot","unguided","All"))) %>%
  filter(!is.na(area)) -> tot_how

as.data.frame(
  rbind(t(postH$q50$H_ayg),
        t(postH$q50$H_ayu),
        t(postH$q50$H_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "H") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$H_ayg),
          t(postH$q2.5$H_ayu),
          t(postH$q2.5$H_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "H_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$H_ayg),
          t(postH$q97.5$H_ayu),
          t(postH$q97.5$H_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "H_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$H_ayg),
          t(postH$sd$H_ayu),
          t(postH$sd$H_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_H") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  mutate(area = toupper(as.character(area))) %>% #filter(!is.na(area)) %>%
#  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(tot_how, by = c("year","user","area")) -> rf_plotdat

rf_plotdat %>% mutate(area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
  filter(user == "All") %>%
  ggplot(aes(x = year, y = H, color = user)) +
  geom_line() + 
  geom_ribbon(aes(x=year,ymin = H_lo95, ymax = H_hi95, fill = user), alpha = 0.25, color = NA) +
  facet_wrap(. ~ area, scales = "free") +
  geom_point(aes(x = year, y = H_how, color = user, shape = user)) + 
  theme_bw(base_size = 14) +
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  scale_y_continuous(labels = comma) +
  labs(y = "Total Rockfish Harvests (numbers)", x = "Year")#+
  #geom_errorbar(aes(x = year, ymin=lo95_H_how, ymax=hi95_H_how, color = user), width=.2,
  #              position=position_dodge(0.05))

ggsave("../figures/bayes_model/rf_harvests.png", width = 10, height = 8) 

options(scipen = 999)

rf_plotdat %>%
            mutate(region = ifelse(area %in% southeast,"Southeast",
                                   ifelse(area %in% central,"Southcentral","Kodiak")),
                   area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
            arrange(area,user,year) %>% 
            mutate(H = round(H,0),
                   H_lo95 = round(H_lo95,0),
                   H_hi95 = round(H_hi95),
                   sd_H = round(sd_H,3)) %>%
            select(region,area,year,user,Harvest = H, sd_H, H_lo95,H_hi95) -> TotH_wb

#rep_wb$add_worksheet("All_RF_Harvests")
#rep_wb$add_data("All_RF_Harvests", dat_for_wb)

X<- X+1
```
<br><br>
 
```{r, fig.width = 10, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Total rockfish releases 1996--2023. Lines and error polygons represent model estimates and points and error bars represent Howard et al estimates.")}
tot_howR <- readxl::read_excel(paste0("..\\output\\release_estimates_Howard_thru",REP_YR,".xlsx"),
                              sheet = "BRF release",
                              range = "A1:N400") %>%
  #read.csv(paste0("..\\output\\harvest_estimates_Howard_thru",REP_YR,".csv")) %>%
  clean_names() %>% filter(year <= end_yr) %>%
  mutate(tot_rf = log_rfrel + priv_rfrel) %>%
  select(region,year,area = rpt_area, gui_tot = log_rfrel,pri_tot=priv_rfrel,var = var_priv_rfrel, tot_rf) 

tot_howR %>% select(-var) %>%
  pivot_longer(cols = c("gui_tot","pri_tot","tot_rf"),
               names_to = "user",
               values_to = "R_how") %>%
  mutate(user = ifelse(user == "gui_tot","guided",
                       ifelse(user == "pri_tot","unguided","All"))) %>%
  filter(!is.na(area)) -> tot_howR

as.data.frame(
  rbind(t(postH$q50$R_ayg),
        t(postH$q50$R_ayu),
        t(postH$q50$R_ay))) %>%
  setNames(nm = unique(R_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "R") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$R_ayg),
          t(postH$q2.5$R_ayu),
          t(postH$q2.5$R_ay))) %>%
      setNames(nm = unique(R_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$R_ayg),
          t(postH$q97.5$R_ayu),
          t(postH$q97.5$R_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$R_ayg),
          t(postH$sd$R_ayu),
          t(postH$sd$R_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_R") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  mutate(area = toupper(as.character(area))) %>% #filter(!is.na(area)) %>%
#  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(tot_howR, by = c("year","user","area")) -> rf_plotdat2

rf_plotdat2 %>% mutate(area = factor(area, toupper(unique(R_ayg$area)), ordered = TRUE)) %>%
  filter(user == "All") %>%
  ggplot(aes(x = year, y = R, color = user)) +
  geom_line() + 
  geom_ribbon(aes(x=year,ymin = R_lo95, ymax = R_hi95, fill = user), alpha = 0.25, color = NA) +
  facet_wrap(. ~ area, scales = "free") +
  geom_point(aes(x = year, y = R_how, color = user, shape = user)) + 
  theme_bw(base_size = 14) +
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  scale_y_continuous(labels = comma) +
  labs(y = "Total Rockfish Releases", x = "Year")#+

rf_plotdat2 %>% 
            mutate(region = ifelse(area %in% southeast,"Southeast",
                                   ifelse(area %in% central,"Southcentral","Kodiak")),
                   area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
            arrange(area,user,year) %>% 
            mutate(R = round(R,0),
                   R_lo95 = round(R_lo95,0),
                   R_hi95 = round(R_hi95),
                   sd_R = round(sd_R,3)) %>%
            select(region,area,year,user,Releases = R, sd_R,R_lo95,R_hi95) -> TotR_wb

#rep_wb$add_worksheet("All_RF_Releases")
#rep_wb$add_data("All_RF_Releases", r_for_wb)

ggsave("../figures/bayes_model/rf_releases.png", width = 10, height = 8) 
```
<br>

*Notes from Adam:* When looking at only black rockfish the most significant differences are for the Prince William Sound Inside area. I did not spend a great deal of time tracking this down although it looks like the previous version used bad values for $P_{(black)ayu}$ for at least unguided anglers. For the moment I would ignore the results for BSIA and SOKO2SAP. I think it is possible to give approximate values for these areas but it will require a little more coding which I have yet to do. 
 
```{r, fig.width = 12, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Black rockfish harvests 1996--2023. Lines and error polygons represent model estimates and points and error bars represent Howard et al estimates.")}

pal <- wes_palette(name = "IsleofDogs1", n=3)

brf_how <- read.csv(paste0("..\\output\\BRF_harv_Howard_thru",REP_YR,".csv")) %>%
  clean_names() %>%
  select(region,year,area = rpt_area, gui_brf, var_gui_brf, priv_brf, var_priv_brf,
         tot_brf = total_br_fharv, var_tot_brf = var_total_br_fharv) 

brf_how %>% select(-c("var_gui_brf","var_priv_brf","var_tot_brf")) %>%
  pivot_longer(cols = c("gui_brf","priv_brf","tot_brf"),
               names_to = "user",
               values_to = "H_how") %>%
  mutate(user = ifelse(user == "gui_brf","guided",
                       ifelse(user == "priv_brf","unguided","All"))) %>%
  left_join(brf_how %>% select(-c("gui_brf","priv_brf","tot_brf")) %>%
              pivot_longer(cols = c("var_gui_brf","var_priv_brf","var_tot_brf"),
                           names_to = "user",
                           values_to = "var_H_how") %>%
              mutate(user = ifelse(user == "var_gui_brf","guided",
                                   ifelse(user == "var_priv_brf","unguided","All"))),
            by = c("region","year","area","user")) %>%
  mutate(se_H_how = sqrt(var_H_how),
         lo95_H_how = ifelse(H_how - 1.96 * se_H_how < 0,0,
                             H_how - 1.96 * se_H_how),
         hi95_H_how = H_how + 1.96 * se_H_how) -> brf_how


as.data.frame(
  rbind(t(postH$q50$Hb_ayg),
        t(postH$q50$Hb_ayu),
        t(postH$q50$Hb_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "H") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Hb_ayg),
          t(postH$q2.5$Hb_ayu),
          t(postH$q2.5$Hb_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "H_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Hb_ayg),
          t(postH$q97.5$Hb_ayu),
          t(postH$q97.5$Hb_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "H_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$Hb_ayg),
          t(postH$sd$Hb_ayu),
          t(postH$sd$Hb_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_H") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  left_join(brf_how, by = c("year","user","area")) -> brf_plotdat

brf_plotdat %>% mutate(area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>% filter(user != "All") %>%
  ggplot(aes(x = year, y = H, color = user)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  facet_wrap(. ~ area, scales = "free") +
  geom_point(aes(x = year, y = H_how, color = user, shape = user)) +
  #geom_errorbar(aes(x = year, ymin=lo95_H_how, ymax=hi95_H_how, color = user), width=.2,
  #              position=position_dodge(0.05), alpha = 0.3) + 
  geom_line() + 
  geom_ribbon(aes(x=year,ymin = H_lo95, ymax = H_hi95, fill = user), alpha = 0.25, color = NA) +
  theme_bw(base_size = 14) +
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  scale_y_continuous(labels = comma) +
  labs(y = "Black Rockfish Harvests", x = "Year")

ggsave("../figures/bayes_model/black_harvests.png", width = 10, height = 8) 
brf_plotdat %>% 
            mutate(region = ifelse(area %in% southeast,"Southeast",
                                   ifelse(area %in% central,"Southcentral","Kodiak")),
                   area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
            arrange(area,user,year) %>%
            mutate(H = round(H,0),
                   H_lo95 = round(H_lo95,0),
                   H_hi95 = round(H_hi95),
                   sd_H = round(sd_H,3)) %>%
            select(region,area,year,user,Harvests = H, sd_H,H_lo95,H_hi95) ->brfH_wb

#rep_wb$add_worksheet("Black_Harv")
#rep_wb$add_data("Black_Harv", brf_h)

X<-X+1
```
<br>

And black rockfish releases...

```{r, fig.width = 12, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Black rockfish releases 1996--2023. Lines and error polygons represent model estimates and points and error bars represent Howard et al estimates.")}
pal <- wes_palette(name = "IsleofDogs1", n=3)

brf_howR <- read.csv(paste0("..\\output\\BRF_rel_Howard_thru",REP_YR,".csv")) %>%
  clean_names() %>%
  select(region,year,area = rpt_area, gui_brf, var_gui_brf, priv_brf, var_priv_brf,
         tot_brf = total_br_frel, var_tot_brf = var_total_br_frel) %>% unique() #note some duplicate BSAI and SOKO2SAPs

brf_howR %>% select(-c("var_gui_brf","var_priv_brf","var_tot_brf")) %>%
  pivot_longer(cols = c("gui_brf","priv_brf","tot_brf"),
               names_to = "user",
               values_to = "R_how") %>%
  mutate(user = ifelse(user == "gui_brf","guided",
                       ifelse(user == "priv_brf","unguided","All"))) %>%
  left_join(brf_howR %>% select(-c("gui_brf","priv_brf","tot_brf")) %>%
              pivot_longer(cols = c("var_gui_brf","var_priv_brf","var_tot_brf"),
                           names_to = "user",
                           values_to = "var_R_how") %>%
              mutate(user = ifelse(user == "var_gui_brf","guided",
                                   ifelse(user == "var_priv_brf","unguided","All"))),
            by = c("region","year","area","user")) %>%
  mutate(se_R_how = sqrt(var_R_how),
         lo95_R_how = ifelse(R_how - 1.96 * se_R_how < 0,0,
                             R_how - 1.96 * se_R_how),
         hi95_R_how = R_how + 1.96 * se_R_how) -> brf_howR

as.data.frame(
  rbind(t(postH$q50$Rb_ayg),
        t(postH$q50$Rb_ayu),
        t(postH$q50$Rb_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "R") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Rb_ayg),
          t(postH$q2.5$Rb_ayu),
          t(postH$q2.5$Rb_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Rb_ayg),
          t(postH$q97.5$Rb_ayu),
          t(postH$q97.5$Rb_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$Rb_ayg),
          t(postH$sd$Rb_ayu),
          t(postH$sd$Rb_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_R") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  left_join(brf_howR, by = c("year","user","area")) %>%
  mutate(area = factor(area, toupper(unique(R_ayg$area)), ordered = TRUE)) -> brf_rel

brf_rel %>%  filter(user != "All") %>%
  ggplot(aes(x = year, y = R, color = user)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_line() + 
  #geom_ribbon(aes(x=year,ymin = R_lo95, ymax = R_hi95, fill = user), alpha = 0.25, color = NA) +
  facet_wrap(. ~ area, scales = "free") +
  geom_point(aes(x = year, y = R_how, color = user, shape = user)) +
  #geom_errorbar(aes(x = year, ymin=lo95_R_how, ymax=hi95_R_how, color = user), width=.2,
  #              position=position_dodge(0.05), alpha = 0.3) +
  geom_ribbon(aes(x=year,ymin = R_lo95, ymax = R_hi95, fill = user), alpha = 0.25, color = NA) +
  geom_line() + 
  theme_bw(base_size = 14) +
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  ylim(0,max(brf_howR$R_how)) +
  scale_y_continuous(labels = comma) +
  labs(y = "Black Rockfish Releases", x = "Year")

ggsave("../figures/bayes_model/black_releases.png", width = 10, height = 8) 

X <- X+1

```
<br><br>

```{r, fig.width = 12, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Black rockfish releases and estimated release mortality 1996--2023. Lines and error polygons represent model estimates.")}
pal <- wes_palette(name = "IsleofDogs1", n=6)

as.data.frame(
  rbind(t(postH$q50$Rb_ayg),
        t(postH$q50$Rb_ayu),
        t(postH$q50$Rb_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "R") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Rb_ayg),
          t(postH$q2.5$Rb_ayu),
          t(postH$q2.5$Rb_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Rb_ayg),
          t(postH$q97.5$Rb_ayu),
          t(postH$q97.5$Rb_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  mutate(category = "Total released") -> brf_releases
  
as.data.frame(
  rbind(t(postH$q50$Rb_ayg_mort),
        t(postH$q50$Rb_ayu_mort),
        t(postH$q50$Rb_ay_mort))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "R") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Rb_ayg_mort),
          t(postH$q2.5$Rb_ayu_mort),
          t(postH$q2.5$Rb_ay_mort))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Rb_ayg_mort),
          t(postH$q97.5$Rb_ayu_mort),
          t(postH$q97.5$Rb_ay_mort))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$Rb_ayg_mort),
          t(postH$sd$Rb_ayu_mort),
          t(postH$sd$Rb_ay_mort))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_Rmort") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  mutate(category = "Est. mortality") -> brf_r_mort

brf_rel %>% full_join(brf_r_mort %>% filter(category == "Est. mortality") %>%
                        select(year,area,user,
                               Release_morts = R, sd_Rmort, RM_lo95 = R_lo95, RM_hi95 = R_hi95),
                      by = c("year","user","area")) %>%
  mutate(region = ifelse(area %in% southeast,"Southeast",
                                   ifelse(area %in% central,"Southcentral","Kodiak")),
                   area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
  arrange(area,user,year) %>%
            mutate(R = round(R,0),
                   Release_morts = round(Release_morts,0),
                   RM_lo95 = round(RM_lo95,0),
                   RM_hi95 = round(RM_hi95,0),
                   R_lo95 = round(R_lo95,0),
                   R_hi95 = round(R_hi95),
                   sd_R = round(sd_R,3),
                   sd_RM = round(sd_Rmort,3)) %>%
            select(region,area,year,user,Releases = R, sd_R, R_lo95,R_hi95,Release_morts, sd_RM, RM_lo95,RM_hi95) -> brfR_wb

#rep_wb$add_worksheet("Black_Rel")
#rep_wb$add_data("Black_Rel", brf_rel)

#X <- X+1

```
<br><br>

```{r, fig.width = 11.5, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Yellow rockfish harvests 1996--2023. Lines and error polygons represent model estimates and points and error bars represent Howard et al estimates.")}
#pal <- wes_palette(name = "Darjeeling1", n=3)
pal <- wes_palette(name = "FantasticFox1", n=3)[c(1,5)] 

ye_how <- read.csv(paste0("..\\output\\YE_harv_Howard_thru",REP_YR,".csv")) %>%
  clean_names() %>%
  select(region,year,area = rpt_area, gui_ye, var_gui_ye, priv_ye, var_priv_ye,
         tot_ye = total_y_eharv, var_tot_ye = var_total_y_eharv) 

ye_how %>% select(-c("var_gui_ye","var_priv_ye","var_tot_ye")) %>%
  pivot_longer(cols = c("gui_ye","priv_ye","tot_ye"),
               names_to = "user",
               values_to = "H_how") %>%
  mutate(user = ifelse(user == "gui_ye","guided",
                       ifelse(user == "priv_ye","unguided","All"))) %>%
  left_join(ye_how %>% select(-c("gui_ye","priv_ye","tot_ye")) %>%
              pivot_longer(cols = c("var_gui_ye","var_priv_ye","var_tot_ye"),
                           names_to = "user",
                           values_to = "var_H_how") %>%
              mutate(user = ifelse(user == "var_gui_ye","guided",
                                   ifelse(user == "var_priv_ye","unguided","All"))),
            by = c("region","year","area","user")) %>%
  mutate(se_H_how = sqrt(var_H_how),
         lo95_H_how = ifelse(H_how - 1.96 * se_H_how < 0,0,
                             H_how - 1.96 * se_H_how),
         hi95_H_how = H_how + 1.96 * se_H_how) -> ye_how

as.data.frame(
  rbind(t(postH$q50$Hy_ayg),
        t(postH$q50$Hy_ayu),
        t(postH$q50$Hy_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "H") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Hy_ayg),
          t(postH$q2.5$Hy_ayu),
          t(postH$q2.5$Hy_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "H_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Hy_ayg),
          t(postH$q97.5$Hy_ayu),
          t(postH$q97.5$Hy_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "H_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$Hy_ayg),
          t(postH$sd$Hy_ayu),
          t(postH$sd$Hy_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_H") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(ye_how, by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  mutate(area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) -> YE_harv
  
YE_harv %>% filter(user != "All") %>%
  ggplot(aes(x = year, y = H, color = user)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  facet_wrap(. ~ area, scales = "free") +
  geom_point(aes(x = year, y = H_how, color = user, shape = user)) +
  #geom_errorbar(aes(x = year, ymin=lo95_H_how, ymax=hi95_H_how, color = user), width=.2,
  #              position=position_dodge(0.05), alpha = 0.3) + 
  geom_line() + 
  geom_ribbon(aes(x=year,ymin = H_lo95, ymax = H_hi95, fill = user), alpha = 0.25, color = NA) +
  theme_bw(base_size = 14) +
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  scale_y_continuous(labels = comma) +
  labs(y = "Yelloweye Rockfish Harvests", x = "Year")

ggsave("../figures/bayes_model/ye_harvests.png", width = 10, height = 8) 

YE_harv %>% 
            mutate(region = ifelse(area %in% southeast,"Southeast",
                                   ifelse(area %in% central,"Southcentral","Kodiak")),
                   area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
            arrange(area,user,year) %>%
            mutate(H = round(H,0),
                   H_lo95 = round(H_lo95,0),
                   H_hi95 = round(H_hi95),
                   sd_H = round(sd_H,3)) %>%
            select(region,area,year,user,Harvests = H, sd_H, H_lo95,H_hi95) -> yeH_wb

X <- X+1
```
<br><br>

```{r, fig.width = 11.5, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Yellow rockfish releases 1996--2023. Lines and error polygons represent model estimates and points and error bars represent Howard et al estimates.")}
#pal <- wes_palette(name = "Darjeeling1", n=3)
pal <- wes_palette(name = "FantasticFox1", n=3)[c(1,5)]

ye_howR <- read.csv(paste0("..\\output\\YE_rel_Howard_thru",REP_YR,".csv")) %>%
  clean_names() %>%
  select(region,year,area = rpt_area, gui_ye, var_gui_ye, priv_ye, var_priv_ye,
         tot_ye = total_y_erel, var_tot_ye = var_total_y_erel) %>% unique()

ye_howR %>% select(-c("var_gui_ye","var_priv_ye","var_tot_ye")) %>%
  pivot_longer(cols = c("gui_ye","priv_ye","tot_ye"),
               names_to = "user",
               values_to = "R_how") %>%
  mutate(user = ifelse(user == "gui_ye","guided",
                       ifelse(user == "priv_ye","unguided","All"))) %>%
  left_join(ye_howR %>% select(-c("gui_ye","priv_ye","tot_ye")) %>%
              pivot_longer(cols = c("var_gui_ye","var_priv_ye","var_tot_ye"),
                           names_to = "user",
                           values_to = "var_R_how") %>%
              mutate(user = ifelse(user == "var_gui_ye","guided",
                                   ifelse(user == "var_priv_ye","unguided","All"))),
            by = c("region","year","area","user")) %>%
  mutate(se_R_how = sqrt(var_R_how),
         lo95_R_how = ifelse(R_how - 1.96 * se_R_how < 0,0,
                             R_how - 1.96 * se_R_how),
         hi95_R_how = R_how + 1.96 * se_R_how) -> ye_howR

as.data.frame(
  rbind(t(postH$q50$Ry_ayg),
        t(postH$q50$Ry_ayu),
        t(postH$q50$Ry_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "R") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Ry_ayg),
          t(postH$q2.5$Ry_ayu),
          t(postH$q2.5$Ry_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Ry_ayg),
          t(postH$q97.5$Ry_ayu),
          t(postH$q97.5$Ry_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$Ry_ayg),
          t(postH$sd$Ry_ayu),
          t(postH$sd$Ry_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_R") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(ye_how, by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  left_join(ye_howR, by = c("year","user","area")) %>%
  mutate(area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
  
  filter(user != "All") %>%
  ggplot(aes(x = year, y = R, color = user)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  facet_wrap(. ~ area, scales = "free") +
  geom_point(aes(x = year, y = R_how, color = user, shape = user)) +
  #geom_errorbar(aes(x = year, ymin=lo95_R_how, ymax=hi95_R_how, color = user), width=.2,
  #              position=position_dodge(0.05), alpha = 0.3) + 
  geom_line() + 
  geom_ribbon(aes(x=year,ymin = R_lo95, ymax = R_hi95, fill = user), alpha = 0.25, color = NA) +
  theme_bw(base_size = 14) +
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  scale_y_continuous(labels = comma) +
  labs(y = "Yelloweye Rockfish Releases", x = "Year")

ggsave("../figures/bayes_model/ye_releases.png", width = 10, height = 8) 
X <- X+1
```

<br><br>

```{r, fig.width = 11.5, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Yellow rockfish releases 1996--2023. Lines and error polygons represent model estimates and points and error bars represent Howard et al estimates.")}
#pal <- wes_palette(name = "Darjeeling1", n=3)
pal <- wes_palette(name = "FantasticFox1", n=3)[c(1,5)]

as.data.frame(
  rbind(t(postH$q50$Ry_ayg),
        t(postH$q50$Ry_ayu),
        t(postH$q50$Ry_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "R") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Ry_ayg),
          t(postH$q2.5$Ry_ayu),
          t(postH$q2.5$Ry_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Ry_ayg),
          t(postH$q97.5$Ry_ayu),
          t(postH$q97.5$Ry_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$Ry_ayg),
          t(postH$sd$Ry_ayu),
          t(postH$sd$Ry_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_R") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(ye_how, by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  mutate(area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE),
         category = "Total released") ->ye_releases

as.data.frame(
  rbind(t(postH$q50$Ry_ayg_mort),
        t(postH$q50$Ry_ayu_mort),
        t(postH$q50$Ry_ay_mort))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "R") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Ry_ayg_mort),
          t(postH$q2.5$Ry_ayu_mort),
          t(postH$q2.5$Ry_ay_mort))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Ry_ayg_mort),
          t(postH$q97.5$Ry_ayu_mort),
          t(postH$q97.5$Ry_ay_mort))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$Ry_ayg_mort),
          t(postH$sd$Ry_ayu_mort),
          t(postH$sd$Ry_ay_mort))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_Rmort") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(ye_how, by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  mutate(area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE),
         category = "Est. mortality") ->ye_rmort
  
ye_releases %>% full_join(ye_rmort %>% filter(category == "Est. mortality") %>%
                        select(year,area,user,sd_Rmort,
                               Release_morts = R, RM_lo95 = R_lo95, RM_hi95 = R_hi95),
                      by = c("year","user","area")) %>%
  mutate(region = ifelse(area %in% southeast,"Southeast",
                                   ifelse(area %in% central,"Southcentral","Kodiak")),
                   area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
  arrange(area,user,year) %>%
            mutate(R = round(R,0),
                   Release_morts = round(Release_morts,0),
                   RM_lo95 = round(RM_lo95,0),
                   RM_hi95 = round(RM_hi95,0),
                   R_lo95 = round(R_lo95,0),
                   R_hi95 = round(R_hi95,0),
                   sd_R = round(sd_R,3),
                   sd_RM = round(sd_Rmort,3)) %>%
            select(region,area,year,user,Releases = R, sd_R, R_lo95,R_hi95,Release_morts, sd_RM, RM_lo95,RM_hi95) -> yeR_wb

```

<br><br>

```{r, fig.width = 8, fig.height = 4, fig.cap = paste0("**Figure ",X,".**- DSR rockfish (excluding yelloweye) harvests 1996--2023. Lines and error polygons represent model estimates and points and error bars represent Howard et al estimates.")}
#BottleRocket2 2,3 or 2,4 Rushmore1 2,3,4 Darjeeling 1,2,3,4,5 FantasticFox1 3,4,5
#library(paletteer); scale_colour_paletteer_d("nationalparkcolors::Acadia")
pal <- wes_palette(name = "AsteroidCity1", n=3) 

dsr_how <- read.csv(paste0("..\\output\\DSR_harv_Howard_thru",REP_YR,".csv")) %>%
  clean_names() %>%
  select(region,year,area = rpt_area, gui_dsr, var_gui_dsr, priv_dsr, var_priv_dsr,
         tot_dsr = total_ds_rharv, var_tot_dsr = var_total_ds_rharv) 

dsr_how %>% select(-c("var_gui_dsr","var_priv_dsr","var_tot_dsr")) %>%
  pivot_longer(cols = c("gui_dsr","priv_dsr","tot_dsr"),
               names_to = "user",
               values_to = "H_how") %>%
  mutate(user = ifelse(user == "gui_dsr","guided",
                       ifelse(user == "priv_dsr","unguided","All"))) %>%
  left_join(dsr_how %>% select(-c("gui_dsr","priv_dsr","tot_dsr")) %>%
              pivot_longer(cols = c("var_gui_dsr","var_priv_dsr","var_tot_dsr"),
                           names_to = "user",
                           values_to = "var_H_how") %>%
              mutate(user = ifelse(user == "var_gui_dsr","guided",
                                   ifelse(user == "var_priv_dsr","unguided","All"))),
            by = c("region","year","area","user")) %>%
  mutate(se_H_how = sqrt(var_H_how),
         lo95_H_how = ifelse(H_how - 1.96 * se_H_how < 0,0,
                             H_how - 1.96 * se_H_how),
         hi95_H_how = H_how + 1.96 * se_H_how) %>%
  left_join(ye_how %>% select(region,area,year,user,ye_how = H_how),
            by = c("region","area","user","year")) %>%
  mutate(H_how = H_how - ye_how)-> dsr_how

as.data.frame(
  rbind(t(postH$q50$Hdnye_ayg),
        t(postH$q50$Hdnye_ayu),
        t(postH$q50$Hdnye_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "H") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Hdnye_ayg),
          t(postH$q2.5$Hdnye_ayu),
          t(postH$q2.5$Hdnye_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "H_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Hdnye_ayg),
          t(postH$q97.5$Hdnye_ayu),
          t(postH$q97.5$Hdnye_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "H_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$Hdnye_ayg),
          t(postH$sd$Hdnye_ayu),
          t(postH$sd$Hdnye_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_H") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  left_join(dsr_how, by = c("year","user","area")) %>%
  mutate(area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
  filter(area %in% southeast) ->DSR_harv
  
DSR_harv %>%  filter(user != "All" & area %in% c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO")) %>%
  ggplot(aes(x = year, y = H, color = user)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  facet_wrap(. ~ area, scales = "free") +
  geom_point(aes(x = year, y = H_how, color = user, shape = user)) +
  #geom_errorbar(aes(x = year, 
  #                  ymin=ifelse(lo95_H_how-ye_how<0,0,lo95_H_how-ye_how), #ymin=max(0,lo95_H_how-ye_how,na.rm=T), 
  #                  ymax=(hi95_H_how-ye_how), color = user), width=.2,
  #              position=position_dodge(0.05), alpha = 0.3) + 
  geom_line() + 
  geom_ribbon(aes(x=year,ymin = H_lo95, ymax = H_hi95, fill = user), alpha = 0.25, color = NA) +
  theme_bw(base_size = 14) +
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  scale_y_continuous(labels = comma) +
  #ylim(0,) +
  labs(y = "DSR Rockfish Harvests", x = "Year") 

ggsave("../figures/bayes_model/dsr_harvests.png", width = 7, height = 4) 
X <- X+1

DSR_harv %>% 
            mutate(region = ifelse(area %in% southeast,"Southeast",
                                   ifelse(area %in% central,"Southcentral","Kodiak")),
                   area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
            arrange(area,user,year) %>%
            mutate(H = round(H,0),
                   H_lo95 = round(H_lo95,0),
                   H_hi95 = round(H_hi95),
                   sd_H = round(sd_H,3)) %>%
            select(region,area,year,user,Harvests = H, sd_H, H_lo95,H_hi95)-> dsrH_wb

#rep_wb$add_worksheet("nonYE_DSR_Harv")
#rep_wb$add_data("nonYE_DSR_Harv", dsr_harv)
```
<br><br>

```{r, fig.width = 8, fig.height = 4, fig.cap = paste0("**Figure ",X,".**- DSR rockfish releases (including yelloweye) 1996--2023. Lines and error polygons represent model estimates and points and error bars represent Howard et al estimates.")}
#pal <- wes_palette(name = "Darjeeling1", n=3)
pal <- wes_palette(name = "AsteroidCity1", n=3)

dsr_howR <- read.csv(paste0("..\\output\\DSR_rel_Howard_thru",REP_YR,".csv")) %>%
  clean_names() %>%
  select(region,year,area = rpt_area, gui_dsr, var_gui_dsr, priv_dsr, var_priv_dsr,
         tot_dsr = total_ds_rrel, var_tot_dsr = var_total_ds_rrel) %>% unique()

dsr_howR %>% select(-c("var_gui_dsr","var_priv_dsr","var_tot_dsr")) %>%
  pivot_longer(cols = c("gui_dsr","priv_dsr","tot_dsr"),
               names_to = "user",
               values_to = "R_how") %>%
  mutate(user = ifelse(user == "gui_dsr","guided",
                       ifelse(user == "priv_dsr","unguided","All"))) %>%
  left_join(dsr_howR %>% select(-c("gui_dsr","priv_dsr","tot_dsr")) %>%
              pivot_longer(cols = c("var_gui_dsr","var_priv_dsr","var_tot_dsr"),
                           names_to = "user",
                           values_to = "var_R_how") %>%
              mutate(user = ifelse(user == "var_gui_dsr","guided",
                                   ifelse(user == "var_priv_dsr","unguided","All"))),
            by = c("region","year","area","user")) %>%
  mutate(se_R_how = sqrt(var_R_how),
         lo95_R_how = ifelse(R_how - 1.96 * se_R_how < 0,0,
                             R_how - 1.96 * se_R_how),
         hi95_R_how = R_how + 1.96 * se_R_how) %>%
  left_join(ye_howR %>% select(region,area,year,user,ye_how = R_how),
            by = c("region","area","user","year")) %>%
  mutate(R_how = R_how - ye_how)-> dsr_howR

#ye_howR %>% filter(area == "PWSI") %>% arrange(user,year) %>% print(n = 80)

as.data.frame(
  rbind(t(postH$q50$Rdnye_ayg),
        t(postH$q50$Rdnye_ayu),
        t(postH$q50$Rdnye_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "R") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Rdnye_ayg),
          t(postH$q2.5$Rdnye_ayu),
          t(postH$q2.5$Rdnye_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Rdnye_ayg),
          t(postH$q97.5$Rdnye_ayu),
          t(postH$q97.5$Rdnye_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$Rdnye_ayg),
          t(postH$sd$Rdnye_ayu),
          t(postH$sd$Rdnye_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_R") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  left_join(dsr_howR, by = c("year","user","area")) %>%
  mutate(area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
  filter(area %in% southeast) -> DSR_rel

as.data.frame(
  rbind(t(postH$q50$Rdnye_ayg_mort),
        t(postH$q50$Rdnye_ayu_mort),
        t(postH$q50$Rdnye_ay_mort))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "R") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Rdnye_ayg_mort),
          t(postH$q2.5$Rdnye_ayu_mort),
          t(postH$q2.5$Rdnye_ay_mort))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Rdnye_ayg_mort),
          t(postH$q97.5$Rdnye_ayu_mort),
          t(postH$q97.5$Rdnye_ay_mort))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$Rdnye_ayg_mort),
          t(postH$sd$Rdnye_ayu_mort),
          t(postH$sd$Rdnye_ay_mort))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_Rmort") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  left_join(dsr_howR, by = c("year","user","area")) %>%
  mutate(area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
  filter(area %in% southeast) -> DSR_rmort
  
DSR_rel %>% filter(user != "All" & area %in% c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO")) %>%
  ggplot(aes(x = year, y = R, color = user)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  facet_wrap(. ~ area, scales = "free") +
  geom_point(aes(x = year, y = R_how, color = user, shape = user)) +
  #geom_errorbar(aes(x = year, 
  #                  ymin=ifelse(lo95_R_how-ye_how<0,0,lo95_R_how-ye_how), 
  #                  ymax=hi95_R_how, color = user), width=.2,
  #              position=position_dodge(0.05), alpha = 0.3) + 
  geom_line() + 
  geom_ribbon(aes(x=year,ymin = R_lo95, ymax = R_hi95, fill = user), alpha = 0.25, color = NA) +
  theme_bw(base_size = 14) +
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Non-YE DSR Rockfish Releases", x = "Year")

ggsave("../figures/bayes_model/dsr_releases.png", width = 7, height = 4) 
X <- X+1

DSR_rel %>% full_join(DSR_rmort %>% #filter(category == "Est. mortality") %>%
                        select(year,area,user, sd_Rmort,
                               Release_morts = R, RM_lo95 = R_lo95, RM_hi95 = R_hi95),
                      by = c("year","user","area")) %>%
  mutate(region = ifelse(area %in% southeast,"Southeast",
                                   ifelse(area %in% central,"Southcentral","Kodiak")),
                   area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
  arrange(area,user,year) %>%
            mutate(R = round(R,0),
                   Release_morts = round(Release_morts,0),
                   RM_lo95 = round(RM_lo95,0),
                   RM_hi95 = round(RM_hi95,0),
                   R_lo95 = round(R_lo95,0),
                   R_hi95 = round(R_hi95),
                   sd_R = round(sd_R,3),
                   sd_RM = round(sd_Rmort,3)) %>%
            select(region,area,year,user,Releases = R, sd_R, R_lo95,R_hi95,Release_morts, sd_RM, RM_lo95,RM_hi95) -> dsrR_wb

#rep_wb$add_worksheet("nonYE_DSR_Rel")
#rep_wb$add_data("nonYE_DSR_Rel", dsr_rel)
```
<br><br>

```{r, fig.width = 8, fig.height = 4, fig.cap = paste0("**Figure ",X,".**- Slope rockfish harvests 1996-2023. Lines and error polygons represent model estimates and points and error bars represent Howard et al estimates.")}
#BottleRocket2 2,3 or 2,4 Rushmore1 2,3,4 Darjeeling 1,2,3,4,5 FantasticFox1 3,4,5
#library(paletteer); scale_colour_paletteer_d("nationalparkcolors::Acadia")
pal <- wes_palette(name = "Rushmore1")[c(3,4)] 

slope_how <- read.csv(paste0("..\\output\\SLO_harv_Howard_thru",REP_YR,".csv")) %>%
  clean_names() %>%
  select(region,year,area = rpt_area, gui_slope, var_gui_slope, priv_slope, var_priv_slope,
         tot_slope = total_slopeharv, var_tot_slope = var_total_slopeharv) 

slope_how %>% select(-c("var_gui_slope","var_priv_slope","var_tot_slope")) %>%
  pivot_longer(cols = c("gui_slope","priv_slope","tot_slope"),
               names_to = "user",
               values_to = "H_how") %>%
  mutate(user = ifelse(user == "gui_slope","guided",
                       ifelse(user == "priv_slope","unguided","All"))) %>%
  left_join(slope_how %>% select(-c("gui_slope","priv_slope","tot_slope")) %>%
              pivot_longer(cols = c("var_gui_slope","var_priv_slope","var_tot_slope"),
                           names_to = "user",
                           values_to = "var_H_how") %>%
              mutate(user = ifelse(user == "var_gui_slope","guided",
                                   ifelse(user == "var_priv_slope","unguided","All"))),
            by = c("region","year","area","user")) %>%
  mutate(se_H_how = sqrt(var_H_how),
         lo95_H_how = ifelse(H_how - 1.96 * se_H_how < 0,0,
                             H_how - 1.96 * se_H_how),
         hi95_H_how = H_how + 1.96 * se_H_how) -> slope_how

as.data.frame(
  rbind(t(postH$q50$Hs_ayg),
        t(postH$q50$Hs_ayu),
        t(postH$q50$Hs_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "H") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Hs_ayg),
          t(postH$q2.5$Hs_ayu),
          t(postH$q2.5$Hs_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "H_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Hs_ayg),
          t(postH$q97.5$Hs_ayu),
          t(postH$q97.5$Hs_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "H_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$Hs_ayg),
          t(postH$sd$Hs_ayu),
          t(postH$sd$Hs_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_H") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  left_join(slope_how, by = c("year","user","area")) %>%
  mutate(area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
  filter(area %in% southeast)-> slope_harv
  
slope_harv %>% filter(user != "All" & area %in% c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO")) %>%
  ggplot(aes(x = year, y = H, color = user)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  facet_wrap(. ~ area, scales = "free") +
  geom_point(aes(x = year, y = H_how, color = user, shape = user)) +
  #geom_errorbar(aes(x = year, ymin=lo95_H_how, ymax=hi95_H_how, color = user), width=.2,
  #              position=position_dodge(0.05), alpha = 0.3) + 
  geom_line() + 
  geom_ribbon(aes(x=year,ymin = H_lo95, ymax = H_hi95, fill = user), alpha = 0.25, color = NA) +
  theme_bw(base_size = 14) +
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  scale_y_continuous(labels = comma) +
  labs(y = "Slope Rockfish Harvests", x = "Year")

ggsave("../figures/bayes_model/slope_harvests.png", width = 7, height = 4) 
X <- X+1

slope_harv %>% 
            mutate(region = ifelse(area %in% southeast,"Southeast",
                                   ifelse(area %in% central,"Southcentral","Kodiak")),
                   area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
            arrange(area,user,year) %>%
            mutate(H = round(H,0),
                   H_lo95 = round(H_lo95,0),
                   H_hi95 = round(H_hi95),
                   sd_H = round(sd_H,3)) %>%
            select(region,area,year,user,Harvests = H, sd_H, H_lo95,H_hi95) -> slopeH_wb

#rep_wb$add_worksheet("Slope_Harv")
#rep_wb$add_data("Slope_Harv", slope_h)

X <- X+1
```
<br><br>

```{r, fig.width = 8, fig.height = 4, fig.cap = paste0("**Figure ",X,".**- Slope rockfish releases 1996--2023. Lines and error polygons represent model estimates and points and error bars represent Howard et al estimates.")}
#pal <- wes_palette(name = "Darjeeling1", n=3)
pal <- wes_palette(name = "Rushmore1")[c(3,4)] 

slope_howR <- read.csv(paste0("..\\output\\SLO_rel_Howard_thru",REP_YR,".csv")) %>%
  clean_names() %>%
  select(region,year,area = rpt_area, gui_slope, var_gui_slope, priv_slope, var_priv_slope,
         tot_slope = total_sloperel, var_tot_slope = var_total_sloperel) %>% unique()

slope_howR %>% select(-c("var_gui_slope","var_priv_slope","var_tot_slope")) %>%
  pivot_longer(cols = c("gui_slope","priv_slope","tot_slope"),
               names_to = "user",
               values_to = "R_how") %>%
  mutate(user = ifelse(user == "gui_slope","guided",
                       ifelse(user == "priv_slope","unguided","All"))) %>%
  left_join(slope_howR %>% select(-c("gui_slope","priv_slope","tot_slope")) %>%
              pivot_longer(cols = c("var_gui_slope","var_priv_slope","var_tot_slope"),
                           names_to = "user",
                           values_to = "var_R_how") %>%
              mutate(user = ifelse(user == "var_gui_slope","guided",
                                   ifelse(user == "var_priv_slope","unguided","All"))),
            by = c("region","year","area","user")) %>%
  mutate(se_R_how = sqrt(var_R_how),
         lo95_R_how = ifelse(R_how - 1.96 * se_R_how < 0,0,
                             R_how - 1.96 * se_R_how),
         hi95_R_how = R_how + 1.96 * se_R_how) -> slope_howR

#ye_howR %>% filter(area == "PWSI") %>% arrange(user,year) %>% print(n = 80)

as.data.frame(
  rbind(t(postH$q50$Rs_ayg),
        t(postH$q50$Rs_ayu),
        t(postH$q50$Rs_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "R") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Rs_ayg),
          t(postH$q2.5$Rs_ayu),
          t(postH$q2.5$Rs_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Rs_ayg),
          t(postH$q97.5$Rs_ayu),
          t(postH$q97.5$Rs_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$Rs_ayg),
          t(postH$sd$Rs_ayu),
          t(postH$sd$Rs_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_R") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  left_join(slope_howR, by = c("year","user","area")) %>%
  mutate(area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
  filter(area %in% southeast) -> slope_rel

as.data.frame(
  rbind(t(postH$q50$Rs_ayg_mort),
        t(postH$q50$Rs_ayu_mort),
        t(postH$q50$Rs_ay_mort))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "R") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Rs_ayg_mort),
          t(postH$q2.5$Rs_ayu_mort),
          t(postH$q2.5$Rs_ay_mort))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Rs_ayg_mort),
          t(postH$q97.5$Rs_ayu_mort),
          t(postH$q97.5$Rs_ay_mort))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$Rs_ayg_mort),
          t(postH$sd$Rs_ayu_mort),
          t(postH$sd$Rs_ay_mort))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_Rmort") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  left_join(slope_howR, by = c("year","user","area")) %>%
  mutate(area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE),
         category = "Est. mortality") %>%
  filter(area %in% southeast) -> slope_rmort
  
slope_rel %>% filter(user != "All" & area %in% c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO")) %>%
  ggplot(aes(x = year, y = R, color = user)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  facet_wrap(. ~ area, scales = "free") +
  geom_point(aes(x = year, y = R_how, color = user, shape = user)) +
  #geom_errorbar(aes(x = year, ymin=lo95_R_how, ymax=hi95_R_how, color = user), width=.2,
  #              position=position_dodge(0.05), alpha = 0.3) + 
  geom_line() + 
  geom_ribbon(aes(x=year,ymin = R_lo95, ymax = R_hi95, fill = user), alpha = 0.25, color = NA) +
  theme_bw(base_size = 14) +
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  scale_y_continuous(labels = comma) +
  labs(y = "Slope Rockfish Releases", x = "Year")

ggsave("../figures/bayes_model/slope_releases.png", width = 7, height = 4) 

slope_rel %>% full_join(slope_rmort %>% filter(category == "Est. mortality") %>%
                        select(year,area,user, sd_Rmort,
                               Release_morts = R, RM_lo95 = R_lo95, RM_hi95 = R_hi95),
                      by = c("year","user","area")) %>%
  mutate(region = ifelse(area %in% southeast,"Southeast",
                                   ifelse(area %in% central,"Southcentral","Kodiak")),
                   area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
  arrange(area,user,year) %>%
            mutate(R = round(R,0),
                   Release_morts = round(Release_morts,0),
                   RM_lo95 = round(RM_lo95,0),
                   RM_hi95 = round(RM_hi95,0),
                   R_lo95 = round(R_lo95,0),
                   R_hi95 = round(R_hi95),
                   sd_R = round(sd_R,3),
                   sd_RM = round(sd_Rmort,3)) %>%
            select(region,area,year,user,Releases = R,sd_R, R_lo95,R_hi95,Release_morts, sd_RM,RM_lo95,RM_hi95) -> slopeR_wb

#rep_wb$add_worksheet("Slope_Rel")
#rep_wb$add_data("Slope_Rel", slope_release)
X <- X+1
```

## Total Biomass Removal Estimates

```{r, fig.width = 11.5, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Black rockfish estimated total removals in lbs in 1996--2023. Total removals are calculated from the harvests, the estimated release mortality and mean fish weights. Error polygons represent 95% confidence intervals.")}
#pal <- wes_palette(name = "Darjeeling1", n=3)
pal <- wes_palette(name = "IsleofDogs1", n=6)

as.data.frame(
  rbind(t(postH$q50$Bb_ayg),
        t(postH$q50$Bb_ayu),
        t(postH$q50$Bb_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "B") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Bb_ayg),
          t(postH$q2.5$Bb_ayu),
          t(postH$q2.5$Bb_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "B_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Bb_ayg),
          t(postH$q97.5$Bb_ayu),
          t(postH$q97.5$Bb_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "B_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$Bb_ayg),
          t(postH$sd$Bb_ayu),
          t(postH$sd$Bb_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_B") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  mutate(area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE),
         category = "Total released") ->brf_removals

brf_removals %>%
  ggplot(aes(x = year, y = B, color = user, shape = category)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  facet_wrap(. ~ area, scales = "free") +
  geom_line() + #geom_point() +
  geom_ribbon(aes(x=year,ymin = B_lo95, ymax = B_hi95, fill = user), alpha = 0.25, color = NA) +
  theme_bw(base_size = 14) +
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  scale_y_continuous(labels = comma) +
  labs(y = "Black Rockfish Removals (lbs)", x = "Year")

ggsave("../figures/bayes_model/brf_removals.png", width = 10, height = 8) 
X <- X+1

brf_removals %>% 
            mutate(region = ifelse(area %in% southeast,"Southeast",
                                   ifelse(area %in% central,"Southcentral","Kodiak")),
                   area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
            arrange(area,user,year) %>%
            mutate(Mort_lbs = round(B,2),
                   M_lo95 = round(B_lo95,2),
                   M_hi95 = round(B_hi95,2),
                   sd_M = round(sd_B,3)) %>%
            select(region,area,year,user,Mort_lbs,sd_M, M_lo95,M_hi95) -> brf_m

```
<br><br>

```{r, fig.width = 11.5, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Yellow rockfish estimated total removals in lbs in 1996--2023. Total removals are calculated from the harvests, the estimated release mortality and mean fish weights. Error polygons represent 95% confidence intervals.")}
pal <- wes_palette(name = "FantasticFox1", n=3)#[c(1,5)]

as.data.frame(
  rbind(t(postH$q50$By_ayg),
        t(postH$q50$By_ayu),
        t(postH$q50$By_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "B") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$By_ayg),
          t(postH$q2.5$By_ayu),
          t(postH$q2.5$By_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "B_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$By_ayg),
          t(postH$q97.5$By_ayu),
          t(postH$q97.5$By_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "B_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$By_ayg),
          t(postH$sd$By_ayu),
          t(postH$sd$By_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_B") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  mutate(area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE),
         category = "Total released") ->ye_removals

ye_removals %>%
  ggplot(aes(x = year, y = B, color = user, shape = category)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  facet_wrap(. ~ area, scales = "free") +
  geom_line() + #geom_point() +
  geom_ribbon(aes(x=year,ymin = B_lo95, ymax = B_hi95, fill = user), alpha = 0.25, color = NA) +
  theme_bw(base_size = 14) +
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  scale_y_continuous(labels = comma) +
  labs(y = "Yelloweye Rockfish Removals (lbs)", x = "Year")

ggsave("../figures/bayes_model/ye_removals.png", width = 10, height = 8) 
X <- X+1

ye_removals %>% 
            mutate(region = ifelse(area %in% southeast,"Southeast",
                                   ifelse(area %in% central,"Southcentral","Kodiak")),
                   area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
            arrange(area,user,year) %>%
            mutate(Mort_lbs = round(B,2),
                   M_lo95 = round(B_lo95,2),
                   M_hi95 = round(B_hi95,2),
                   sd_M = round(sd_B,3)) %>%
            select(region,area,year,user,Mort_lbs, sd_M, M_lo95,M_hi95) -> ye_m

#rep_wb$add_worksheet("YE_Mort_Lbs")
#rep_wb$add_data("YE_Mort_Lbs", ye_m)
```

```{r, fig.width = 8, fig.height = 4, fig.cap = paste0("**Figure ",X,".**- Pelagic rockfish estimated total removals in lbs in 1996--2023. Total removals are calculated from the harvests, the estimated release mortality and mean fish weights. Error polygons represent 95% confidence intervals.")}
pal <- wes_palette(name = "IsleofDogs1", n=6)

as.data.frame(
  rbind(t(postH$q50$Bp_ayg),
        t(postH$q50$Bp_ayu),
        t(postH$q50$Bp_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "B") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Bp_ayg),
          t(postH$q2.5$Bp_ayu),
          t(postH$q2.5$Bp_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "B_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Bp_ayg),
          t(postH$q97.5$Bp_ayu),
          t(postH$q97.5$Bp_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "B_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$Bp_ayg),
          t(postH$sd$Bp_ayu),
          t(postH$sd$Bp_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_B") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  mutate(area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE),
         category = "Total released") %>%
  filter(area %in% southeast) ->pel_removals

pel_removals %>% filter(area %in% c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO")) %>%
  ggplot(aes(x = year, y = B, color = user, shape = category)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  facet_wrap(. ~ area, scales = "free") +
  geom_line() + #geom_point() +
  geom_ribbon(aes(x=year,ymin = B_lo95, ymax = B_hi95, fill = user), alpha = 0.25, color = NA) +
  theme_bw(base_size = 14) +
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  scale_y_continuous(labels = comma) +
  labs(y = "Non-Black, Pelagic Removals (lbs)", x = "Year")

ggsave("../figures/bayes_model/pel_removals.png", width = 7, height = 4) 
X <- X+1

pel_removals %>% 
            mutate(region = ifelse(area %in% southeast,"Southeast",
                                   ifelse(area %in% central,"Southcentral","Kodiak")),
                   area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
            arrange(area,user,year) %>%
            mutate(Mort_lbs = round(B,2),
                   M_lo95 = round(B_lo95,2),
                   M_hi95 = round(B_hi95,2),
                   sd_M = round(sd_B,3)) %>%
            select(region,area,year,user,Mort_lbs,sd_M, M_lo95,M_hi95) -> pel_m

#Also need to get pelagic harvests and releases to be complete:
as.data.frame(
  rbind(t(postH$mean$Hp_ayg),
        t(postH$mean$Hp_ayu),
        t(postH$mean$Hp_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "H") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Hp_ayg),
          t(postH$q2.5$Hp_ayu),
          t(postH$q2.5$Hp_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "H_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Hp_ayg),
          t(postH$q97.5$Hp_ayu),
          t(postH$q97.5$Hp_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "H_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$Hp_ayg),
          t(postH$sd$Hp_ayu),
          t(postH$sd$Hp_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_H") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  #left_join(slope_how, by = c("year","user","area")) %>%
  mutate(area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
  filter(area %in% southeast)-> pel_harv
  
pel_harv %>% 
            mutate(region = ifelse(area %in% southeast,"Southeast",
                                   ifelse(area %in% central,"Southcentral","Kodiak")),
                   area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
            arrange(area,user,year) %>%
            mutate(H = round(H,0),
                   H_lo95 = round(H_lo95,0),
                   H_hi95 = round(H_hi95),
                   sd_H = round(sd_H,3)) %>%
            select(region,area,year,user,Harvests = H, H_lo95,H_hi95) -> pelH_wb

as.data.frame(
  rbind(t(postH$q50$Rp_ayg),
        t(postH$q50$Rp_ayu),
        t(postH$q50$Rp_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "R") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Rp_ayg),
          t(postH$q2.5$Rp_ayu),
          t(postH$q2.5$Rp_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Rp_ayg),
          t(postH$q97.5$Rp_ayu),
          t(postH$q97.5$Rp_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$Rp_ayg),
          t(postH$sd$Rp_ayu),
          t(postH$sd$Rp_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_R") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  #left_join(slope_howR, by = c("year","user","area")) %>%
  mutate(area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
  filter(area %in% southeast) -> pel_rel

as.data.frame(
  rbind(t(postH$q50$Rp_ayg_mort),
        t(postH$q50$Rp_ayu_mort),
        t(postH$q50$Rp_ay_mort))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "R") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Rp_ayg_mort),
          t(postH$q2.5$Rp_ayu_mort),
          t(postH$q2.5$Rp_ay_mort))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Rp_ayg_mort),
          t(postH$q97.5$Rp_ayu_mort),
          t(postH$q97.5$Rp_ay_mort))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "R_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$Rp_ayg_mort),
          t(postH$sd$Rp_ayu_mort),
          t(postH$sd$Rp_ay_mort))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_RM") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
 #left_join(p_howR, by = c("year","user","area")) %>%
  mutate(area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE),
         category = "Est. mortality") %>%
  filter(area %in% southeast) -> pel_rmort
  
pel_rel %>% full_join(pel_rmort %>% filter(category == "Est. mortality") %>%
                        select(year,area,user,sd_RM,
                               Release_morts = R, RM_lo95 = R_lo95, RM_hi95 = R_hi95),
                      by = c("year","user","area")) %>%
  mutate(region = ifelse(area %in% southeast,"Southeast",
                                   ifelse(area %in% central,"Southcentral","Kodiak")),
                   area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
  arrange(area,user,year) %>%
            mutate(R = round(R,0),
                   Release_morts = round(Release_morts,0),
                   RM_lo95 = round(RM_lo95,0),
                   RM_hi95 = round(RM_hi95,0),
                   R_lo95 = round(R_lo95,0),
                   R_hi95 = round(R_hi95),
                   sd_R = round(sd_R,3),
                   sd_RM = round(sd_RM,3)) %>%
            select(region,area,year,user,Releases = R, sd_R, R_lo95,R_hi95,Release_morts, sd_RM, RM_lo95,RM_hi95) -> pelR_wb

```
<br>

```{r, fig.width = 8, fig.height = 4, fig.cap = paste0("**Figure ",X,".**- Non-yelloweye, demersal shelf rockfish estimated total removals in lbs in 1996-2023. Total removals are calculated from the harvests, the estimated release mortality and mean fish weights. Error polygons represent 95% confidence intervals.")}
pal <- wes_palette(name = "Rushmore1")[c(3,4,5)] 

as.data.frame(
  rbind(t(postH$q50$Bdnye_ayg),
        t(postH$q50$Bdnye_ayu),
        t(postH$q50$Bdnye_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "B") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Bdnye_ayg),
          t(postH$q2.5$Bdnye_ayu),
          t(postH$q2.5$Bdnye_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "B_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Bdnye_ayg),
          t(postH$q97.5$Bdnye_ayu),
          t(postH$q97.5$Bdnye_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "B_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$Bdnye_ayg),
          t(postH$sd$Bdnye_ayu),
          t(postH$sd$Bdnye_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_B") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  mutate(area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE),
         category = "Total released") %>%
  filter(area %in% southeast) ->dsrlessye_removals

dsrlessye_removals %>% filter(area %in% c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO")) %>%
  ggplot(aes(x = year, y = B, color = user, shape = category)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  facet_wrap(. ~ area, scales = "free") +
  geom_line() + #geom_point() +
  geom_ribbon(aes(x=year,ymin = B_lo95, ymax = B_hi95, fill = user), alpha = 0.25, color = NA) +
  theme_bw(base_size = 14) +
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  scale_y_continuous(labels = comma) +
  labs(y = "DSR (non YE) Rockfish Removals (lbs)", x = "Year")

ggsave("../figures/bayes_model/dsr_removals.png", width = 7, height = 4) 
X <- X+1

dsrlessye_removals %>% 
            mutate(region = ifelse(area %in% southeast,"Southeast",
                                   ifelse(area %in% central,"Southcentral","Kodiak")),
                   area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
            arrange(area,user,year) %>%
            mutate(Mort_lbs = round(B,2),
                   M_lo95 = round(B_lo95,2),
                   M_hi95 = round(B_hi95,2),
                   sd_M = round(sd_B,3)) %>%
            select(region,area,year,user,Mort_lbs, sd_M, M_lo95,M_hi95) -> dsr_m

#rep_wb$add_worksheet("non-YE_DSR_Mort_Lbs")
#rep_wb$add_data("non-YE_DSR_Mort_Lbs", dsr_m)
```

<br>

```{r, fig.width = 8, fig.height = 4, fig.cap = paste0("**Figure ",X,".**- Slope rockfish estimated total removals in lbs in 1996-2023. Total removals are calculated from the harvests, the estimated release mortality and mean fish weights. Error polygons represent 95% confidence intervals.")}
pal <- wes_palette(name = "Rushmore1")[c(3,4,5)] 

as.data.frame(
  rbind(t(postH$q50$Bs_ayg),
        t(postH$q50$Bs_ayu),
        t(postH$q50$Bs_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(start_yr:end_yr, times = 3),
         user = rep(c("guided", "unguided", "All"), each = Y)) %>%
  pivot_longer(!c(year,user), names_to = "area", values_to = "B") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(
    rbind(t(postH$q2.5$Bs_ayg),
          t(postH$q2.5$Bs_ayu),
          t(postH$q2.5$Bs_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "B_lo95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$q97.5$Bs_ayg),
          t(postH$q97.5$Bs_ayu),
          t(postH$q97.5$Bs_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "B_hi95") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  left_join(as.data.frame(
    rbind(t(postH$sd$Bs_ayg),
          t(postH$sd$Bs_ayu),
          t(postH$sd$Bs_ay))) %>%
      setNames(nm = unique(H_ayg$area)) %>%
      mutate(year = rep(start_yr:end_yr, times = 3),
             user = rep(c("guided", "unguided", "All"), each = Y)) %>%
      pivot_longer(!c(year,user), names_to = "area", values_to = "sd_B") %>%
      mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
    by = c("year","user","area")) %>%
  mutate(area = toupper(area)) %>%
  mutate(area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE),
         category = "Total released") %>%
  filter(area %in% southeast) -> slope_removals

slope_removals %>% filter(area %in% c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO")) %>%
  ggplot(aes(x = year, y = B, color = user, shape = category)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  facet_wrap(. ~ area, scales = "free") +
  geom_line() + #geom_point() +
  geom_ribbon(aes(x=year,ymin = B_lo95, ymax = B_hi95, fill = user), alpha = 0.25, color = NA) +
  theme_bw(base_size = 14) +
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  scale_y_continuous(labels = comma) +
  labs(y = "Slope Rockfish Removals (lbs)", x = "Year")

ggsave("../figures/bayes_model/slope_removals.png", width = 7, height = 4) 
X <- X+1

slope_removals %>% 
            mutate(region = ifelse(area %in% southeast,"Southeast",
                                   ifelse(area %in% central,"Southcentral","Kodiak")),
                   area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) %>%
            arrange(area,user,year) %>%
            mutate(Mort_lbs = round(B,2),
                   M_lo95 = round(B_lo95,2),
                   M_hi95 = round(B_hi95,2),
                   sd_M = round(sd_B,3)) %>%
            select(region,area,year,user,Mort_lbs, sd_M, M_lo95,M_hi95) -> slope_m 

```
<br>

## Model fit
### Logbook residuals
```{r, fig.width = 8, fig.height = 6, fig.cap = paste0("**Figure ",X,".**- Residuals from logbook harvests.")}
as.data.frame(
  t(postH$mean$H_ayg) - t(jags_dat$Hlb_ayg)) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = start_yr:end_yr) %>%
  pivot_longer(!year, names_to = "area", values_to = "res") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  ggplot(aes(x = year, y = res)) +
  geom_point() +
  geom_hline(aes(yintercept = 0)) +
  facet_wrap(. ~ area, scales = "free_y") + theme_bw(base_size = 16)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Logbook residuals", x = "Year")

ggsave("../figures/bayes_model/lb_resids.png") 
X <- X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check
```
<br>

### SWHS residuals
```{r, fig.width = 10, fig.height = 6, fig.cap = paste0("**Figure ",X,".**- Residuals from SWHS harvests.")}
pal <- wes_palette(name = "Zissou1Continuous", type = "continuous")

as.data.frame(
  t(log(postH$mean$H_ay) + postH$mean$logbc_H) - t(log(jags_dat$Hhat_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = start_yr:end_yr) %>%
  pivot_longer(!year, names_to = "area", values_to = "H_res") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(t(jags_dat$cvHhat_ay)) %>% setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = start_yr:end_yr) %>%
              pivot_longer(!year, names_to = "area", values_to = "cv") %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area")) -> swhs_Hres
swhs_Hres %>% ggplot(aes(x = year, y = H_res)) +
  scale_color_gradientn(colours = pal) + 
  geom_point(aes(color = cv)) +
  geom_hline(aes(yintercept = 0)) +
  facet_wrap(. ~ area, scales = "free_y") + theme_bw(base_size = 16)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "SWHS harvest residuals", x = "Year")

ggsave("../figures/bayes_model/swhs_harvest_resids.png") 
X <- X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check
```
<br><br>

```{r, fig.width = 10, fig.height = 6, fig.cap = paste0("**Figure ",X,".**- Residual of SWHS releases.")}
pal <- wes_palette(name = "Zissou1Continuous", type = "continuous")

if (mod %in% c("LB_fit","LB_hyb_2b","LB_hyb_2b_hb2","LB_fit_hb2","LB_cens_hb2","LB_fit_3pH","LB_hyb_3pH")){
  as.data.frame(
  #t(log(postH$mean$C_ay) + postH$mean$logbc_C) - t(log(jags_dat$Chat_ay_pH))) %>%
  t(log(postH$mean$R_ay) + postH$mean$logbc_R) - t(log(jags_dat$Rhat_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = start_yr:end_yr) %>%
  pivot_longer(!year, names_to = "area", values_to = "R_res") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(t(jags_dat$cvRhat_ay)) %>% setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = start_yr:end_yr) %>%
              pivot_longer(!year, names_to = "area", values_to = "cv") %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area"))-> swhs_Rres

swhs_Rres %>%  
  filter(cv < 25) %>%
  ggplot(aes(x = year, y = R_res)) +
  scale_color_gradientn(colours = pal) + 
  geom_point(aes(color = cv)) +
  geom_hline(aes(yintercept = 0)) +
  facet_wrap(. ~ area, scales = "free_y") + theme_bw(base_size = 16)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "SWHS release residuals", x = "Year")
} else {
  as.data.frame(
  #t(log(postH$mean$C_ay) + postH$mean$logbc_C) - t(log(jags_dat$Chat_ay_pH))) %>%
  t(log(postH$mean$R_ay) + postH$mean$logbc_R) - t(log(jags_dat$Rhat_ay))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = start_yr:end_yr) %>%
  pivot_longer(!year, names_to = "area", values_to = "R_res") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(as.data.frame(t(jags_dat$cvRhat_ay)) %>% setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = start_yr:end_yr) %>%
              pivot_longer(!year, names_to = "area", values_to = "cv") %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area"))-> swhs_Rres
swhs_Rres %>%  
  #filter(cv < 25) %>%
  ggplot(aes(x = year, y = R_res)) +
  scale_color_gradientn(colours = pal) + 
  geom_point(aes(color = log(cv))) +
  geom_hline(aes(yintercept = 0)) +
  facet_wrap(. ~ area, scales = "free_y") + theme_bw(base_size = 16)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "SWHS release residuals", x = "Year")
}

ggsave("../figures/bayes_model/swhs_release_resids.png") 
X <- X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check
```

## Parameter estimates
### P(Charter)
 
These histograms show the posterior distribution of the mean percent of rockfish harvested by the charter fleet.
 
```{r, fig.width = 8, fig.height = 6, fig.cap = paste0("**Figure ",X,".**- Mean percent of harvest by charter anglers.")}
pG <- postH$sims.list$b1_pG / (postH$sims.list$b1_pG + postH$sims.list$b2_pG) %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) 
pG %>%
  pivot_longer(cols = where(is.numeric), names_to = "area", values_to = "pG") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  ggplot(aes(x = pG)) +
  geom_histogram(binwidth = 0.02) +
  facet_wrap(.~area) + theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Observations", x = "Proportion of harvests from guided trips")

ggsave("../figures/bayes_model/p_charter_means.png") 
X <- X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check
```
<br>

When considered annually we see the percent of rockfish harvested by the charter fleet follows our data fairly well although the model smooths out the changes and we just do not have much information about this ratio. Prior to 2011 the percent charter is confounded with SWHS bias and should be mostly discounted. 
 
```{r, fig.width = 11.5, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Annual estimates of the percent of harvest by charter anglers for 16 commerical fishing manamgent areas, 1996-2023.")}
pG_mod <- 
  postH$mean$pG %>%
  t() %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = unique(Hhat_ay$year),
         source = "model") %>%
  pivot_longer(-c(year, source), names_to = "area", values_to = "pG") %>%
  left_join(postH$q2.5$pG %>%
              t() %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = unique(Hhat_ay$year),
                     source = "model") %>%
              pivot_longer(-c(year, source), names_to = "area", values_to = "pG_lo95"),
            by = c("year","source","area")) %>%
  left_join(postH$q97.5$pG %>%
              t() %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = unique(Hhat_ay$year),
                     source = "model") %>%
              pivot_longer(-c(year, source), names_to = "area", values_to = "pG_hi95"),
            by = c("year","source","area"))
pG_obs <- 
  (jags_dat$Hhat_ayg/jags_dat$Hhat_ay)[,35:Y] %>%
  t() %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = unique(Hhat_ayu$year[Hhat_ayu$year <= end_yr]),
         source = "observed") %>%
  pivot_longer(-c(year, source), names_to = "area", values_to = "pG")

rbind(pG_mod, pG_obs%>% mutate(pG_lo95 = NA, pG_hi95 = NA)) %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  ggplot(aes(x = year, y = pG, color = source)) +
  geom_ribbon(aes(ymin = pG_lo95, ymax = pG_hi95, borders = NA, fill = source), 
              alpha = 0.2, color = NA) +
  geom_point() +
  geom_line() +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(. ~ area) + theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Proportion of harvests from guided trips", x = "Year")

ggsave("../figures/bayes_model/p_charter_by_year.png") 
X <- X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check
```
### P(Harvest)
 
These plots show the fitted logistic line to the proportion of caught rockfish that are harvested. These estimates are used for hindcasting catch estimates based on the harvest data in early years when catch estimates are unavailable.
 
<br>
```{r, fig.width = 10, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Annual proportion of pelagic rockfish catch that was harvested. Note that pre-1990 estimates are used to estimate catch in these years when catch estimates are not available.")}
pal <- wes_palette(name = "Moonrise2", n=3)

pHpel_mod <- 
  rbind(postH$mean$pH[,,1,1] %>% t(),
        postH$mean$pH[,,2,1] %>% t()) %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "model") %>%
  pivot_longer(-c(year, user,source), names_to = "area", values_to = "pH")  %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(rbind(postH$q2.5$pH[,,1,1] %>% t(),
                  postH$q2.5$pH[,,2,1] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "p_lo95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source")) %>%
  left_join(rbind(postH$q97.5$pH[,,1,1] %>% t(),
                  postH$q97.5$pH[,,2,1] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "p_hi95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source"))
pHpel_obs <- 
  as.data.frame(
    rbind(t(jags_dat$Hhat_ayg/(jags_dat$Rhat_ayg + jags_dat$Hhat_ayg)),
          t(jags_dat$Hhat_ayu/(jags_dat$Rhat_ayu + jags_dat$Hhat_ayu)),
          t(jags_dat$Hhat_ay/(jags_dat$Rhat_ay + jags_dat$Hhat_ay)))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 3),
         user = rep(c("charter", "private","all"), each = length(unique(Hhat_ay$year))),
         source = "SWHS (all RF)") %>%
  pivot_longer(-c(year, user,source), names_to = "area", values_to = "pH") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE),
         p_lo95 = NA, p_hi95 = NA)  %>% 
  rbind(t(jags_dat$Hlbp_ayg/(jags_dat$Rlbp_ayg + jags_dat$Hlbp_ayg)) %>%
          data.frame() %>%
          setNames(nm = unique(H_ayg$area)) %>%
          mutate(year = rep(unique(Hhat_ay$year), times = 1),
                 user = rep(c("charter"), each = length(unique(Hhat_ay$year))),
                 source = "logbook") %>%
          pivot_longer(-c(year, user,source), names_to = "area", values_to = "pH") %>%
          mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE),
                 p_lo95 = NA, p_hi95 = NA))

#rbind(beta0_pH <- postH$q50$beta0_pH[,1],
#      beta1_pH <- postH$q50$beta1_pH[,1],
#      beta2_pH <- postH$q50$beta2_pH[,1],
#      beta3_pH <- postH$q50$beta3_pH[,1],
#      beta4_pH <- postH$q50$beta4_pH[,1]) %>% t() %>%
#  data.frame() %>%
#  mutate(area = unique(H_ayg$area),
#         species = "pelagic") %>%
#  rename(beta0 = X1, beta1=X2, beta2=X3, beta3=X4, beta4 = X5) %>%
#  right_join(expand.grid(y = seq(1,end_yr-start_yr+1,1), u = c(1, 2), 
#                         area = factor(comp$area, unique(H_ayg$area), ordered = TRUE)),
#             by = "area") %>%
#  mutate(logit_pH = beta0 +
#           beta1 / (1 + exp(-beta2 * (y - beta3))) *
#           (1 + (u - 1) * (beta4 - 1)),
#         pH = logit_to_prob(logit_pH),
#         year = y + 1976,
#         user = ifelse(u == 1, "charter","private"))-> pHpel_trend

pHpel_obs %>% filter(user != "all") %>%
  ggplot(aes(x = year, y = pH, color = user)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_ribbon(data = pHpel_mod, aes(ymin = p_lo95, ymax = p_hi95, fill = user), 
              alpha = 0.2, color = NA) +
  geom_point(aes(shape = source)) +
  #geom_point(data  = pHpel_obs %>% filter(user == "all"), color = "darkgrey", shape = 8, alpha = 0.5) +
  geom_line(data = pHpel_mod, aes(color = user)) +
#  geom_line(data = pHpel_trend, aes(color = user)) +
  #geom_hline(data = p_pelagic_trend, aes(yintercept = p_pelagic), linetype = 2) +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(. ~ area) +
  scale_shape_manual(values = c(19, 1)) + theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Proportion of pelagic catches that were harvested", x = "Year")

ggsave("../figures/bayes_model/p_harv_pelagics.png", width = 10, height = 8) 
X <- X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check
``` 
<br>
```{r, fig.width = 10, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Annual proportion of yelloweye rockfish catch that was harvested. Note that pre-1990 estimates are used to estimate catch in these years when catch estimates are not available.")}
pal <- wes_palette(name = "FantasticFox1", n=3)[c(1,5)]

pHye_mod <- 
  rbind(postH$mean$pH[,,1,2] %>% t(),
        postH$mean$pH[,,2,2] %>% t()) %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "model") %>%
  pivot_longer(-c(year, user,source), names_to = "area", values_to = "pH")  %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(rbind(postH$q2.5$pH[,,1,2] %>% t(),
                  postH$q2.5$pH[,,2,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "p_lo95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source")) %>%
  left_join(rbind(postH$q97.5$pH[,,1,2] %>% t(),
                  postH$q97.5$pH[,,2,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "p_hi95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source"))

pHye_obs <- 
  as.data.frame(
    rbind(t(jags_dat$Hhat_ayg/(jags_dat$Rhat_ayg + jags_dat$Hhat_ayg)),
          t(jags_dat$Hhat_ayu/(jags_dat$Rhat_ayu + jags_dat$Hhat_ayu)),
          t(jags_dat$Hhat_ay/(jags_dat$Rhat_ay + jags_dat$Hhat_ay)))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 3),
         user = rep(c("charter", "private","all"), each = length(unique(Hhat_ay$year))),
         source = "SWHS (all RF)") %>%
  pivot_longer(-c(year, user,source), names_to = "area", values_to = "pH") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE),
         p_lo95 = NA, p_hi95 = NA)  %>% 
  rbind(t(jags_dat$Hlby_ayg/(jags_dat$Rlby_ayg + jags_dat$Hlby_ayg)) %>%
          data.frame() %>%
          setNames(nm = unique(H_ayg$area)) %>%
          mutate(year = rep(unique(Hhat_ay$year), times = 1),
                 user = rep(c("charter"), each = length(unique(Hhat_ay$year))),
                 source = "logbook") %>%
          pivot_longer(-c(year, user,source), names_to = "area", values_to = "pH") %>%
          mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE),
                 p_lo95 = NA, p_hi95 = NA))

#rbind(beta0_pH <- postH$q50$beta0_pH[,2],
#      beta1_pH <- postH$q50$beta1_pH[,2],
#      beta2_pH <- postH$q50$beta2_pH[,2],
#      beta3_pH <- postH$q50$beta3_pH[,2],
#      beta4_pH <- postH$q50$beta4_pH[,2]) %>% t() %>%
#  data.frame() %>%
#  mutate(area = unique(H_ayg$area),
#         species = "ye") %>%
#  rename(beta0 = X1, beta1=X2, beta2=X3, beta3=X4, beta4 = X5) %>%
#  right_join(expand.grid(y = seq(1,end_yr-start_yr+1,1), u = c(1, 2), 
#                         area = factor(comp$area, unique(H_ayg$area), ordered = TRUE)),
#             by = "area") %>%
#  mutate(logit_pH = beta0 +
#           beta1 / (1 + exp(-beta2 * (y - beta3))) +
#           beta4 * (u - 1),
#         pH = logit_to_prob(logit_pH),
#         year = y + 1976,
#         user = ifelse(u == 1, "charter","private"))-> pHye_trend

pHye_obs %>% filter(user != "all") %>%
  ggplot(aes(x = year, y = pH, color = user)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_ribbon(data = pHye_mod, aes(ymin = p_lo95, ymax = p_hi95, fill = user), 
              alpha = 0.2, color = NA) +
  geom_point(aes(shape = source), fill = "lightgrey", alpha = 0.75) +
  #geom_point(data  = pHye_obs %>% filter(user == "all"), color = "darkgrey", shape = 8, alpha = 0.5) +
  geom_line(data = pHye_mod, aes(color = user)) +
  #geom_line(data = pHye_trend, aes(color = user)) +
  #geom_hline(data = p_pelagic_trend, aes(yintercept = p_pelagic), linetype = 2) +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(. ~ area) +
  scale_shape_manual(values = c(19, 1)) + theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Proportion of yelloweye catches that were harvested", x = "Year")

ggsave("../figures/bayes_model/p_harv_ye.png", width = 10, height = 8) 
X <- X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check
``` 
<br>

```{r, fig.width = 10, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Annual proportion of non-pelagic, non-yelloweye rockfish catch that was harvested. Note that pre-1990 estimates are used to estimate catch in these years when catch estimates are not available. Note, that this is not estimated for Southeast areas because non=pelagics are divided between DSR (including yelloweye) and Slope species.")}
pal <- wes_palette(name = "BottleRocket2", n=5)[c(2,4)] #BottleRocket2 2,3 or 2,4 Rushmore1 2,3,4 Darjeeling 1,2,3,4,5 FantasticFox1 3,4,5
#library(paletteer); scale_colour_paletteer_d("nationalparkcolors::Acadia")

pHnpny_mod <- 
  rbind(postH$mean$pH[,,1,3] %>% t(),
        postH$mean$pH[,,2,3] %>% t()) %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "model") %>%
  pivot_longer(-c(year, user,source), names_to = "area", values_to = "pH")  %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(rbind(postH$q2.5$pH[,,1,3] %>% t(),
                  postH$q2.5$pH[,,2,3] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "p_lo95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source")) %>%
  left_join(rbind(postH$q97.5$pH[,,1,3] %>% t(),
                  postH$q97.5$pH[,,2,3] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "p_hi95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source"))

pHnpny_obs <- 
  as.data.frame(
    rbind(t(jags_dat$Hhat_ayg/(jags_dat$Rhat_ayg + jags_dat$Hhat_ayg)),
          t(jags_dat$Hhat_ayu/(jags_dat$Rhat_ayu + jags_dat$Hhat_ayu)),
          t(jags_dat$Hhat_ay/(jags_dat$Rhat_ay + jags_dat$Hhat_ay)))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 3),
         user = rep(c("charter", "private","all"), each = length(unique(Hhat_ay$year))),
         source = "SWHS (all RF)") %>%
  pivot_longer(-c(year, user,source), names_to = "area", values_to = "pH") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE),
         p_lo95 = NA, p_hi95 = NA)  %>% 
  rbind(t((jags_dat$Hlb_ayg - jags_dat$Hlbp_ayg - jags_dat$Hlby_ayg)
          /(jags_dat$Rlb_ayg - jags_dat$Rlbp_ayg - jags_dat$Rlby_ayg + 
              jags_dat$Hlb_ayg - jags_dat$Hlbp_ayg - jags_dat$Hlby_ayg)) %>%
          data.frame() %>%
          setNames(nm = unique(H_ayg$area)) %>%
          mutate(year = rep(unique(Hhat_ay$year), times = 1),
                 user = rep(c("charter"), each = length(unique(Hhat_ay$year))),
                 source = "logbook") %>%
          pivot_longer(-c(year, user,source), names_to = "area", values_to = "pH") %>%
          mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE),
                 p_lo95 = NA, p_hi95 = NA))

#rbind(beta0_pH <- postH$q50$beta0_pH[,3],
#      beta1_pH <- postH$q50$beta1_pH[,3],
#      beta2_pH <- postH$q50$beta2_pH[,3],
#      beta3_pH <- postH$q50$beta3_pH[,3],
#      beta4_pH <- postH$q50$beta4_pH[,3]) %>% t() %>%
#  data.frame() %>%
#  mutate(area = unique(H_ayg$area),
#         species = "nonp-nonye") %>%
#  rename(beta0 = X1, beta1=X2, beta2=X3, beta3=X4, beta4 = X5) %>%
#  right_join(expand.grid(y = seq(1,end_yr-start_yr+1,1), u = c(1, 2), 
#                         area = factor(comp$area, unique(H_ayg$area), ordered = TRUE)),
#             by = "area") %>%
#  mutate(logit_pH = beta0 +
#           beta1 / (1 + exp(-beta2 * (y - beta3))) +
#           beta4 * (u - 1),
#         pH = logit_to_prob(logit_pH),
#         year = y + 1976,
#         user = ifelse(u == 1, "charter","private"))-> pHnpny_trend

pHnpny_obs %>% filter(user != "all") %>%
  ggplot(aes(x = year, y = pH, color = user)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_ribbon(data = pHnpny_mod, aes(ymin = p_lo95, ymax = p_hi95, fill = user), 
              alpha = 0.2, color = NA) +
  geom_point(aes(shape = source), fill = "lightgrey", alpha = 0.75) +
  #geom_point(data  = pHnpny_obs %>% filter(user == "all"), color = "darkgrey", shape = 8, alpha = 0.5) +
  geom_line(data = pHnpny_mod, aes(color = user)) +
  #geom_line(data = pHye_trend, aes(color = user)) +
  #geom_hline(data = p_pelagic_trend, aes(yintercept = p_pelagic), linetype = 2) +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(. ~ area) +
  scale_shape_manual(values = c(19, 1)) + theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Proportion of non-pelagic, non-yelloweye catches that were harvested", x = "Year")

ggsave("../figures/bayes_model/p_harv_nonyenonpel.png", width = 10, height = 8) 
X <- X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check
``` 
<br>

```{r, fig.width = 10, fig.height = 5, fig.cap = paste0("**Figure ",X,".**- Annual proportion of DSR rockfish catch that was harvested. Note that pre-1990 estimates are used to estimate catch in these years when catch estimates are not available. Note that the observed logbook data is for all non-pelagic, non-yelloweye fish.")}
pal <- wes_palette(name = "AsteroidCity1", n=5)#[c(2,5)] #BottleRocket2 2,3 or 2,4 Rushmore1 2,3,4 Darjeeling 1,2,3,4,5 FantasticFox1 3,4,5
#library(paletteer); scale_colour_paletteer_d("nationalparkcolors::Acadia")

if (mod %in% c("LB_fit_3pH","LB_hyb_3pH")){} else {
pHdsr_mod <- 
  rbind(postH$mean$pH[,,1,4] %>% t(),
        postH$mean$pH[,,2,4] %>% t()) %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "model") %>%
  pivot_longer(-c(year, user,source), names_to = "area", values_to = "pH")  %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(rbind(postH$q2.5$pH[,,1,4] %>% t(),
                  postH$q2.5$pH[,,2,4] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "p_lo95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source")) %>%
  left_join(rbind(postH$q97.5$pH[,,1,4] %>% t(),
                  postH$q97.5$pH[,,2,4] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "p_hi95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source")) %>%
  filter(area %in% c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO"))

pHdsr_obs <- 
  as.data.frame(
    rbind(t(jags_dat$Hhat_ayg/(jags_dat$Rhat_ayg + jags_dat$Hhat_ayg)),
          t(jags_dat$Hhat_ayu/(jags_dat$Rhat_ayu + jags_dat$Hhat_ayu)),
          t(jags_dat$Hhat_ay/(jags_dat$Rhat_ay + jags_dat$Hhat_ay)))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 3),
         user = rep(c("charter", "private","all"), each = length(unique(Hhat_ay$year))),
         source = "SWHS (all RF)") %>%
  pivot_longer(-c(year, user,source), names_to = "area", values_to = "pH") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE),
         p_lo95 = NA, p_hi95 = NA)  %>% 
  rbind(t((jags_dat$Hlbo_ayg)
          /(jags_dat$Rlbo_ayg + 
              jags_dat$Hlbo_ayg)) %>%
          data.frame() %>%
          setNames(nm = unique(H_ayg$area)) %>%
          mutate(year = rep(unique(Hhat_ay$year), times = 1),
                 user = rep(c("charter"), each = length(unique(Hhat_ay$year))),
                 source = "logbook") %>%
          pivot_longer(-c(year, user,source), names_to = "area", values_to = "pH")%>%
          mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE),
                 p_lo95 = NA, p_hi95 = NA)) %>%
  filter(area %in% c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO"))

rbind(beta0_pH <- postH$q50$beta0_pH[,4],
      beta1_pH <- postH$q50$beta1_pH[,4],
      beta2_pH <- postH$q50$beta2_pH[,4],
      beta3_pH <- postH$q50$beta3_pH[,4],
      beta4_pH <- postH$q50$beta4_pH[,4]) %>% t() %>%
  data.frame() %>%
  mutate(area = unique(H_ayg$area),
         species = "DSR") %>%
  rename(beta0 = X1, beta1=X2, beta2=X3, beta3=X4, beta4 = X5) %>%
  right_join(expand.grid(y = seq(1,end_yr-start_yr+1,1), u = c(1, 2), 
                         area = factor(comp$area, unique(H_ayg$area), ordered = TRUE)),
             by = "area") %>%
  mutate(logit_pH = beta0 +
           beta1 / (1 + exp(-beta2 * (y - beta3))) +
           beta4 * (u - 1),
         pH = logit_to_prob(logit_pH),
         year = y + 1976,
         user = ifelse(u == 1, "charter","private"))-> pHdsr_trend

pHdsr_obs %>% filter(user != "all" & area %in% c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO")) %>%
  ggplot(aes(x = year, y = pH, color = user)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_ribbon(data = pHdsr_mod, 
              aes(ymin = p_lo95, ymax = p_hi95, fill = user), 
              alpha = 0.2, color = NA) +
  geom_point(aes(shape = source), fill = "lightgrey", alpha = 0.75) +
  geom_point(data  = pHdsr_obs %>% filter(user == "all"), 
             color = "darkgrey", shape = 8, alpha = 0.5) +
  geom_line(data = pHdsr_mod, 
            aes(color = user)) +
  #geom_line(data = pHye_trend, aes(color = user)) +
  #geom_hline(data = p_pelagic_trend, aes(yintercept = p_pelagic), linetype = 2) +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(. ~ area) +
  scale_shape_manual(values = c(19, 1)) + theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Proportion of DSR catches harvested", x = "Year")
}
X <- X+1
``` 
<br>

```{r, fig.width = 10, fig.height = 5, fig.cap = paste0("**Figure ",X,".**- Annual proportion of Slope rockfish catch that was harvested. Note that pre-1990 estimates are used to estimate catch in these years when catch estimates are not available. Note that the observed logbook data is for all non-pelagic, non-yelloweye fish.")}
pal <- wes_palette(name = "Rushmore1", n=5)[c(3,4)] #BottleRocket2 2,3 or 2,4 Rushmore1 2,3,4 Darjeeling 1,2,3,4,5 FantasticFox1 3,4,5
#library(paletteer); scale_colour_paletteer_d("nationalparkcolors::Acadia")
if (mod %in% c("LB_fit_3pH","LB_hyb_3pH")){} else {
pHslope_mod <- 
  rbind(postH$mean$pH[,,1,5] %>% t(),
        postH$mean$pH[,,2,5] %>% t()) %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "model") %>%
  pivot_longer(-c(year, user,source), names_to = "area", values_to = "pH")  %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(rbind(postH$q2.5$pH[,,1,5] %>% t(),
                  postH$q2.5$pH[,,2,5] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "p_lo95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source")) %>%
  left_join(rbind(postH$q97.5$pH[,,1,5] %>% t(),
                  postH$q97.5$pH[,,2,5] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "p_hi95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source")) %>%
  filter(area %in% c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO"))

pHslope_obs <- 
  as.data.frame(
    rbind(t(jags_dat$Hhat_ayg/(jags_dat$Rhat_ayg + jags_dat$Hhat_ayg)),
          t(jags_dat$Hhat_ayu/(jags_dat$Rhat_ayu + jags_dat$Hhat_ayu)),
          t(jags_dat$Hhat_ay/(jags_dat$Rhat_ay + jags_dat$Hhat_ay)))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 3),
         user = rep(c("charter", "private","all"), each = length(unique(Hhat_ay$year))),
         source = "SWHS (all RF)") %>%
  pivot_longer(-c(year, user,source), names_to = "area", values_to = "pH") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE),
         p_lo95 = NA, p_hi95 = NA)  %>% 
  rbind(t((jags_dat$Hlbo_ayg)
          /(jags_dat$Rlbo_ayg + 
              jags_dat$Hlbo_ayg)) %>%
          data.frame() %>%
          setNames(nm = unique(H_ayg$area)) %>%
          mutate(year = rep(unique(Hhat_ay$year), times = 1),
                 user = rep(c("charter"), each = length(unique(Hhat_ay$year))),
                 source = "logbook") %>%
          pivot_longer(-c(year, user,source), names_to = "area", values_to = "pH") %>%
          mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE),
                 p_lo95 = NA, p_hi95 = NA)) %>%
  filter(area %in% c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO"))

rbind(beta0_pH <- postH$q50$beta0_pH[,5],
      beta1_pH <- postH$q50$beta1_pH[,5],
      beta2_pH <- postH$q50$beta2_pH[,5],
      beta3_pH <- postH$q50$beta3_pH[,5],
      beta4_pH <- postH$q50$beta4_pH[,5]) %>% t() %>%
  data.frame() %>%
  mutate(area = unique(H_ayg$area),
         species = "Slope") %>%
  rename(beta0 = X1, beta1=X2, beta2=X3, beta3=X4, beta4 = X5) %>%
  right_join(expand.grid(y = seq(1,end_yr-start_yr+1,1), u = c(1, 2), 
                         area = factor(comp$area, unique(H_ayg$area), ordered = TRUE)),
             by = "area") %>%
  mutate(logit_pH = beta0 +
           beta1 / (1 + exp(-beta2 * (y - beta3))) +
           beta4 * (u - 1),
         pH = logit_to_prob(logit_pH),
         year = y + 1976,
         user = ifelse(u == 1, "charter","private"))-> pHslope_trend

pHslope_obs %>% filter(user != "all" & area %in% c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO")) %>%
  ggplot(aes(x = year, y = pH, color = user)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_ribbon(data = pHslope_mod, aes(ymin = p_lo95, ymax = p_hi95, fill = user), 
              alpha = 0.2, color = NA) +
  geom_point(aes(shape = source), fill = "lightgrey", alpha = 0.75) +
  geom_point(data  = pHslope_obs %>% filter(user == "all"), color = "darkgrey", shape = 8, alpha = 0.5) +
  geom_line(data = pHslope_mod, aes(color = user)) +
  #geom_line(data = pHye_trend, aes(color = user)) +
  #geom_hline(data = p_pelagic_trend, aes(yintercept = p_pelagic), linetype = 2) +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(. ~ area) +
  scale_shape_manual(values = c(19, 1)) + theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Proportion of slope catches harvested", x = "Year")
}
X <- X+1
``` 
### SWHS bias
 
Figure 23 shows the mean estimate for SWHS bias in harvests and releases. Cook Inlet, North Gulf Coast and North Southeast Inside all look pretty good while most other areas have substantial bias. Prince William Sound Inside has the largest bias. Bias in release estimates is substantial and whereas the SWHS appears to underestimate harvests, it appears to greatly overestimates releases by a factor of 2 or more in most areas as derived from logbook reported releases. 
 
```{r, fig.width = 10, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Mean SWHS bias for harvests and catches. Note that a bias < 1 indicates that the SWHS *underestimates* the true value and bias > 1 indicates the survey *overestimates* the true value.")}
if (mod %in% c("LB_fit","LB_hyb_2b","LB_hyb_2b_hb2","LB_fit_hb2","LB_hyb_hb2","LB_fit_hb2","LB_cens_hb2","LB_fit_5pH","LB_fit_5pH_infPr","LB_hyb_5pH_infPr","LB_fit_3pH","LB_hyb_3pH")) { #2 bias
  exp(postH$sims.list$mu_bc_H) %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  pivot_longer(cols = where(is.numeric), names_to = "area", values_to = "bc") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE),
         data = "H") %>% #-> grr#%>%
  rbind(exp(postH$sims.list$mu_bc_R) %>%
          as.data.frame() %>%
          setNames(nm = unique(H_ayg$area)) %>%
          pivot_longer(cols = where(is.numeric), names_to = "area", values_to = "bc") %>%
          mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE),
                 data = "R")) -> bias

bias %>% data.frame() %>% filter(bc < 50) %>%
  ggplot(aes(x = bc, col = data, fill = data)) +
  geom_histogram(binwidth = .05, alpha = 0.2, position = "identity") +
  coord_cartesian(xlim = c(0, 5)) +
  geom_vline(aes(xintercept = 1)) +
  facet_wrap(.~area) + theme_bw(base_size = 16)+
  labs(y = "Count", x = "Bias correction")
} else { #1 bias with offset
exp(postH$sims.list$mu_bc_H) %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  pivot_longer(cols = where(is.numeric), names_to = "area", values_to = "bc") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE),
         data = "H") %>% #-> grr#%>%
  rbind(exp(postH$sims.list$mu_bc_H * postH$sims.list$bc_R_offset) %>%
          as.data.frame() %>%
          setNames(nm = unique(H_ayg$area)) %>%
          pivot_longer(cols = where(is.numeric), names_to = "area", values_to = "bc") %>%
          mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE),
                 data = "R")) %>%
  rbind((postH$sims.list$bc_R_offset) %>%
          as.data.frame() %>%
          setNames(nm = unique(H_ayg$area)) %>%
          pivot_longer(cols = where(is.numeric), names_to = "area", values_to = "bc") %>%
          mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE),
                 data = "R_offset")) -> bias

bias %>% filter(bc < 6 & data != "C_offset") %>%
  ggplot(aes(x = bc, col = data, fill = data)) +
  geom_histogram(binwidth = .05, alpha = 0.2, position = "identity") +
  coord_cartesian(xlim = c(0, 3)) +
  geom_vline(aes(xintercept = 1)) +
  facet_wrap(.~area) + theme_bw(base_size = 14)+
  labs(y = "Count", x = "Bias correction")
}

ggsave("../figures/bayes_model/swhs_bias_means.png") 
X <- X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check
```
<br>
Our estimates of SWHS harvest bias track observations fairly well when he have guided harvest estimates. The estimates of release bias in the SWHS data track observed patterns to an extent, but appear to smooth these more volatile disagreements with the logbook data. Adam postulated in his initial start on this that some of this could be the result of the estimates of the proportion guided. This value was not modelled with a trend and thus applies a constant estimate when hindcasting. Data on these relationships could greatly improve this model. 
 
```{r, fig.width = 10, fig.height = 7, fig.cap = paste0("**Figure ",X,".**- Annual estimates of SWHS bias in harvests and releases for 16 commerical fishing manamgent areas, 1996-2023. Note that a bias < 1 indicates that the SWHS *underestimates* the true value and bias > 1 indicates the survey *overestimates* the true value.")}
if (mod %in% c("LB_fit","LB_hyb_2b","LB_hyb_2b_hb2","LB_fit_hb2","LB_hyb_hb2","LB_fit_hb2","LB_cens_hb2","LB_fit_5pH","LB_fit_5pH_infPr","LB_hyb_5pH_infPr","LB_fit_3pH","LB_hyb_3pH")){
  mu_bc_H <- data.frame(area = unique(H_ayg$area), mu_bc = apply(exp(postH$sims.list$mu_bc_H), 2, mean))
bc_mod <- 
  apply(exp(postH$sims.list$logbc_H), c(2, 3), mean) %>%
  t() %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = unique(Hhat_ay$year),
         source = "model") %>%
  pivot_longer(-c(year, source), names_to = "area", values_to = "bc") %>%
  mutate(data = "H") %>%
  rbind(apply(exp(postH$sims.list$logbc_R), c(2, 3), mean) %>%
          t() %>%
          as.data.frame() %>%
          setNames(nm = unique(H_ayg$area)) %>%
          mutate(year = unique(Hhat_ay$year),
                 source = "model") %>%
          pivot_longer(-c(year, source), names_to = "area", values_to = "bc") %>%
          mutate(data = "R"))

dim(postH$q50$logbc_H)
dim(postH$q50$bc_R_offset)

bc_mod2 <- 
  #apply(exp(postH$sims.list$logbc_H), c(2, 3), mean) %>%
  exp(postH$q50$logbc_H) %>%
  t() %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = unique(Hhat_ay$year),
         source = "model") %>%
  pivot_longer(-c(year, source), names_to = "area", values_to = "bc") %>%
  mutate(data = "H") %>%
  rbind(exp(postH$q50$logbc_R) %>%
          t() %>%
          as.data.frame() %>%
          setNames(nm = unique(H_ayg$area)) %>%
          mutate(year = unique(Hhat_ay$year),
                 source = "model") %>%
          pivot_longer(-c(year, source), names_to = "area", values_to = "bc") %>%
          mutate(data = "R"))

bc_obs <- 
  (jags_dat$Hhat_ayg/jags_dat$Hlb_ayg)[,35:Y] %>%
  t() %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = unique(Hhat_ayu$year[Hhat_ayu$year <= end_yr]),
         source = "observed") %>%
  pivot_longer(-c(year, source), names_to = "area", values_to = "bc") %>%
  mutate(data = "H") %>% 
  rbind((jags_dat$Rhat_ayg/jags_dat$Rlb_ayg)[,35:Y] %>%
  #rbind((jags_dat$Chat_ayg/(jags_dat$Rlb_ayg + jags_dat$Hlb_ayg))[,35:Y] %>%
          t() %>%
          as.data.frame() %>%
          setNames(nm = unique(H_ayg$area)) %>%
          mutate(year = unique(Hhat_ayu$year[Hhat_ayu$year <= end_yr]),
                 source = "observed") %>%
          pivot_longer(-c(year, source), names_to = "area", values_to = "bc") %>%
          mutate(data = "R"))

rbind(bc_mod2, bc_obs) %>%
  filter(data == "H") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  ggplot(aes(x = year, y = bc, color = source)) +
  geom_point() +
  geom_line() +
  coord_cartesian(ylim = c(0, 5)) +
  geom_hline(aes(yintercept = mu_bc), data = mu_bc_H) +
  facet_wrap(. ~ area) + theme_bw(base_size = 16)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
         legend.position = "bottom",
         plot.margin = margin(t = 20, r = 5, b = 5, l = 5)) +
  labs(y = "", x = "Year")-> Hbias

rbind(bc_mod2, bc_obs) %>%
  filter(data == "R") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  ggplot(aes(x = year, y = bc, color = source)) +
  geom_point() +
  geom_line() +
  coord_cartesian(ylim = c(0, 8)) +
  geom_hline(aes(yintercept = mu_bc), data = mu_bc_H) +
  facet_wrap(. ~ area) + theme_bw(base_size = 16)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
         legend.position = "bottom",
         plot.margin = margin(t = 20, r = 5, b = 5, l = 5)) +
  labs(y = "", x = "Year")-> Rbias

ggarrange(Hbias,Rbias,
          labels = c("Harvests","Releases"),
          ncol=2, common.legend = TRUE, label.y = 1.01, legend = "bottom")
} else {
 mu_bc_H <- data.frame(area = unique(H_ayg$area), mu_bc = apply(exp(postH$sims.list$mu_bc_H), 2, mean))
bc_mod <- 
  apply(exp(postH$sims.list$logbc_H), c(2, 3), mean) %>%
  t() %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = unique(Hhat_ay$year),
         source = "model") %>%
  pivot_longer(-c(year, source), names_to = "area", values_to = "bc") %>%
  mutate(data = "H") %>%
  rbind(apply(exp(postH$sims.list$logbc_H * 
                    array(postH$sims.list$bc_R_offset, 
                          dim = c(dim(postH$sims.list$logbc_H)[1],jags_dat$A,Y))), c(2, 3), mean) %>%
          t() %>%
          as.data.frame() %>%
          setNames(nm = unique(H_ayg$area)) %>%
          mutate(year = unique(Hhat_ay$year),
                 source = "model") %>%
          pivot_longer(-c(year, source), names_to = "area", values_to = "bc") %>%
          mutate(data = "R"))

bc_mod2 <- 
  #apply(exp(postH$sims.list$logbc_H), c(2, 3), mean) %>%
  exp(postH$q50$logbc_H) %>%
  t() %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = unique(Hhat_ay$year),
         source = "model") %>%
  pivot_longer(-c(year, source), names_to = "area", values_to = "bc") %>%
  mutate(data = "H") %>%
  rbind(exp(postH$q50$logbc_H * array(postH$q50$bc_R_offset,
                                      dim = c(jags_dat$A,Y))) %>%
          t() %>%
          as.data.frame() %>%
          setNames(nm = unique(H_ayg$area)) %>%
          mutate(year = unique(Hhat_ay$year),
                 source = "model") %>%
          pivot_longer(-c(year, source), names_to = "area", values_to = "bc") %>%
          mutate(data = "R"))

bc_obs <- 
  (jags_dat$Hhat_ayg/jags_dat$Hlb_ayg)[,35:Y] %>%
  t() %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = unique(Hhat_ayu$year[Hhat_ayu$year <= end_yr]),
         source = "observed") %>%
  pivot_longer(-c(year, source), names_to = "area", values_to = "bc") %>%
  mutate(data = "H") %>% 
  rbind((jags_dat$Rhat_ayg/jags_dat$Rlb_ayg)[,35:Y] %>%
  #rbind((jags_dat$Chat_ayg/(jags_dat$Rlb_ayg + jags_dat$Hlb_ayg))[,35:Y] %>%
          t() %>%
          as.data.frame() %>%
          setNames(nm = unique(H_ayg$area)) %>%
          mutate(year = unique(Hhat_ayu$year[Hhat_ayu$year <= end_yr]),
                 source = "observed") %>%
          pivot_longer(-c(year, source), names_to = "area", values_to = "bc") %>%
          mutate(data = "R"))

rbind(bc_mod2, bc_obs) %>%
  filter(data == "H") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  ggplot(aes(x = year, y = bc, color = source)) +
  geom_point() +
  geom_line() +
  coord_cartesian(ylim = c(0, 5)) +
  geom_hline(aes(yintercept = mu_bc), data = mu_bc_H) +
  facet_wrap(. ~ area) + theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
         legend.position = "bottom",
         plot.margin = margin(t = 20, r = 5, b = 5, l = 5)) +
  labs(y = "Bias correction for SWHS estimates", x = "Year") -> Hbias

rbind(bc_mod2, bc_obs) %>%
  filter(data == "R") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  ggplot(aes(x = year, y = bc, color = source)) +
  geom_point() +
  geom_line() +
  #coord_cartesian(ylim = c(0, 5)) +
  geom_hline(aes(yintercept = mu_bc), data = mu_bc_H) +
  facet_wrap(. ~ area) + theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
         legend.position = "bottom",
         plot.margin = margin(t = 20, r = 5, b = 5, l = 5)) +
  labs(y = "", x = "Year") -> Cbias

ggarrange(Hbias,Cbias,
          labels = c("Harvest","Releases"),
          ncol=2, common.legend = TRUE, label.y = 1.01, legend = "bottom")
}

ggsave("../figures/bayes_model/swhs_bias_byyear.png") 
X <- X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check
```
 
### P(pelagic)
 
We model the percentage of pelagic rockfish in the harvest because we have the information for charter anglers (via logbooks) starting in 1998. Other than looking at the model estimates you can use Figure 25 to compare the two data streams for pelagic rockfish harvest. In general they are in agreement with major exceptions in Price William Sound inside, Prince William Sound outside (early in the time series) and South Southeast inside.
 
```{r, fig.width = 11.5, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Annual estimates of the percent of the sport harvest that was pelagic rockfish for 16 commerical fishing manamgent areas, 1996-2023.")}
pal <- wes_palette(name = "Moonrise2", n=3)

p_pelagic_mod <- 
  rbind(postH$mean$p_pelagic[,,1] %>% t(),
        postH$mean$p_pelagic[,,2] %>% t()) %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
  pivot_longer(-c(year, user), names_to = "area", values_to = "p_pelagic")  %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(rbind(postH$q2.5$p_pelagic[,,1] %>% t(),
                  postH$q2.5$p_pelagic[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "p_lo95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user")) %>%
  left_join(rbind(postH$q97.5$p_pelagic[,,1] %>% t(),
                  postH$q97.5$p_pelagic[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "p_hi95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user"))

p_pelagic_obs <-
  comp %>%
  mutate(year = year_n + 1976, #1995,
         area = unique(H_ayg$area)[area_n],
         user = ifelse(user_n == 0, "charter", "private"),
         source = ifelse(source == 1, "sample", "logbook"),
         p_pelagic = pelagic / N,
         area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  select(year, area, user, source, p_pelagic) %>%
  rbind(H_ayg %>% 
          mutate(p_pelagic = Hp / H, 
                 user = "charter", 
                 source = "logbook") %>% 
          select(year, area, user, source, p_pelagic)) %>%
  mutate(p_lo95 = NA, p_hi95 = NA)

rbind(beta0_pelagic <- postH$q50$beta0_pelagic,
      beta1_pelagic <- postH$q50$beta1_pelagic,
      beta2_pelagic <- postH$q50$beta2_pelagic,
      beta3_pelagic <- postH$q50$beta3_pelagic,
      beta4_pelagic <- postH$q50$beta4_pelagic) %>% t() %>%
  data.frame() %>%
  mutate(area = unique(H_ayg$area)) %>%
  rename(beta0 = X1, beta1=X2, beta2=X3, beta3=X4, beta4 = X5) %>%
  right_join(expand.grid(y = seq(1,end_yr-start_yr+1,1), u = c(1, 2), 
                         area = factor(comp$area, unique(H_ayg$area), ordered = TRUE)),
             by = "area") %>%
  mutate(logit_pel = beta0 +
           beta1 / (1 + exp(-beta2 * (y - beta3))) +
           beta4 * (u - 1),
         p_pelagic = logit_to_prob(logit_pel),
         year = y + 1976,
         user = ifelse(u == 1, "charter","private"))-> pel_trend

p_pelagic_obs %>%
  ggplot(aes(x = year, y = p_pelagic, color = user)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_ribbon(data = p_pelagic_mod, aes(ymin = p_lo95, ymax = p_hi95, fill = user), 
              alpha = 0.2, color = NA) +
  geom_point(aes(shape = source)) +
  geom_line(data = p_pelagic_mod, linetype = 2) +
  #geom_hline(data = p_pelagic_trend, aes(yintercept = p_pelagic), linetype = 2) +
  geom_line(data=pel_trend) +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(. ~ area) + theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Proportion of rockfish that were pelagic", x = "Year") +
  scale_shape_manual(values = c(19, 2))

ggsave("../figures/bayes_model/p_pelagic.png", width = 10, height = 8) 
X <- X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check
```
 
### P(black|pelagic)
 
Note that in Southeast Alaska we only have composition data starting in 2006. Tania dug up old SE data, but it did not provide any useful data for species apportionment. For the most part, P(black|pelagic) is relatively constant across areas, with the exception of Cook Inlet and NSEI in Southeast AK. It may be worth discussing whether the shifts in those areas is a result of improved or changing species identification rather than actual shift in the species composition of the catch.  
 
```{r, fig.width = 11.5, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Annual estimates of the percent of the sport harvest of pelagic rockfish that were black rockfish for 16 commerical fishing manamgent areas, 1996-2023. Kodiak panels include data from a hydroacoustic survey and the proportion of pelagic rockfish that are black in those areas (red) and the adjusted proportions based on obseved harvests for charter (blue) and private (cyan) users.")}
p_black_mod <- 
  rbind(postH$mean$p_black[,,1] %>% t(),
        postH$mean$p_black[,,2] %>% t()) %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "model") %>%
  pivot_longer(-c(year, user, source), names_to = "area", values_to = "p_black")  %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(rbind(postH$q2.5$p_black[,,1] %>% t(),
                  postH$q2.5$p_black[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "p_lo95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user")) %>%
  left_join(rbind(postH$q97.5$p_black[,,1] %>% t(),
                  postH$q97.5$p_black[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "p_hi95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user"))

p_black_obs <-
  #jags_dat[grep("comp_", names(jags_dat), value = TRUE)] %>%
  jags_dat[grep("comp_(?!.*_x)", names(jags_dat), value = TRUE, perl = TRUE)] %>%
  as.data.frame() %>%
  mutate(year = comp_year + 1976,
         area = (unique(H_ayg$area)[comp_area]),
         user = ifelse(comp_user == 0, "charter", "private"),
         p_black = comp_black / comp_pelagic,
         area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  mutate(p_lo95 = NA, p_hi95 = NA,
         area = factor(area, unique(H_ayg$area), ordered = TRUE))

p_black_mod %>%
  left_join(postH$mean$beta0_black %>% t() %>% data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              pivot_longer(cols = unique(H_ayg$area),
                           names_to = "area", values_to = "beta0") %>%
              left_join(postH$mean$beta1_black %>% t() %>% data.frame() %>%
                          setNames(nm = unique(H_ayg$area)) %>%
                          pivot_longer(cols = unique(H_ayg$area),
                                       names_to = "area", values_to = "beta1"), 
                        by = "area") %>%
              left_join(postH$mean$beta2_black %>% t() %>% data.frame() %>%
                          setNames(nm = unique(H_ayg$area)) %>%
                          pivot_longer(cols = unique(H_ayg$area),
                                       names_to = "area", values_to = "beta2"), 
                        by = "area"), 
            by = c("area")) %>%
  mutate(trend = ifelse(user == "charter",
                        beta0+beta1*(year-1976)+beta2,
                        beta0+beta1*(year-1976))) %>% 
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) -> p_black_mod

rbind(beta0_black <- postH$q50$beta0_black,
      beta1_black <- postH$q50$beta1_black,
      beta2_black <- postH$q50$beta2_black,
      beta3_black <- postH$q50$beta3_black,
      beta4_black <- postH$q50$beta4_black) %>% t() %>%
  data.frame() %>%
  mutate(area = unique(H_ayg$area)) %>%
  rename(beta0 = X1, beta1=X2, beta2=X3, beta3=X4, beta4 = X5) %>%
  right_join(expand.grid(y = seq(1,end_yr-start_yr+1,1), u = c(1, 2), 
                         area = factor(comp$area, unique(H_ayg$area), ordered = TRUE)),
             by = "area") %>%
  mutate(logit_b = beta0 +
           beta1 / (1 + exp(-beta2 * (y - beta3))) +
           beta4 * (u - 1),
         p_black = logit_to_prob(logit_b),
         year = y + 1976,
         user = ifelse(u == 1, "charter","private"))-> black_trend

rbind(postH$q50$kap[,1] %>% t(),
        postH$q50$kap[,2] %>% t()) %>% t() %>%
  as.data.frame() %>% 
  setNames(nm = c("charter","private")) %>%
  mutate(area = unique(H_ayg$area)[1:10]) %>%
  pivot_longer(cols = c("charter","private"),
               values_to = "adj",
               names_to = "user")-> kap

data.frame('ha est' = jags_dat$kprop_b,
           area_n = jags_dat$kha_area,
           user = jags_dat$kha_user,
           comp_year = jags_dat$kha_year) %>%
  full_join(data.frame(area = unique(H_ayg$area)[1:10],
           area_n = c(1:10)), by = "area_n") %>%
  full_join(p_black_obs %>% select(comp_year,year), by = "comp_year") %>%
  unique() %>% 
  mutate(user = ifelse(user == 0, "charter","private")) %>%
  left_join(kap, by = c("area","user")) %>%
  mutate(ha_adj = ifelse(ha.est - adj > 1,0.99,ha.est - adj)) %>%
  #mutate(ha_adj_check = ha.est - adj) %>%
  filter(!is.na(area)) %>%
  #mutate(source = "HA adjusted") %>%
  mutate(source = factor(case_when(
    !is.na(ha_adj) ~ "p black adj.",
    TRUE ~ "p black"
  ))) -> ha_dat

ha_dat %>% pivot_longer(cols = c("ha.est","ha_adj"),
                        names_to = "ha",
                        values_to = "p_black") %>%
  mutate(user = ifelse(ha == "ha.est","ha p black",
                       ifelse(ha == "ha_adj" & user == "charter",
                              "ha charter adj.","ha private adj."))) %>%
  filter(!is.na(p_black))-> ha_dat

pal <- c(wes_palette(name = "IsleofDogs1", n=2),"navyblue","blue","darkcyan") 

#halines <- ha_dat %>% select(year,p_black, user,area) %>%

rbind(p_black_obs %>% select(year,p_black,user,area),
      ha_dat %>% select(year,p_black, user,area)) %>%
  filter(!is.na(user)) %>%
  mutate(user = factor(user, levels = c("charter", "private", 
                                        "ha p black","ha charter adj.","ha private adj."))) %>%
  ggplot(aes(x = year, y = p_black, color = user, fill = user, shape = user)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_ribbon(data = p_black_mod %>%
                mutate(user = factor(user, levels = c("charter", "private", 
                                        "ha p black","ha charter adj.","ha private adj."))),
              aes(ymin = p_lo95, ymax = p_hi95), 
              alpha = 0.2, color = NA) +
  geom_point(aes(size = user)) +
  geom_point(data = p_black_obs) +
  geom_line(data = p_black_mod %>%
                mutate(user = factor(user, levels = c("charter", "private", 
                                        "ha p black","ha charter adj.","ha private adj."))),
            linetype = 2, aes(color = user)) +
  geom_line(data=black_trend,aes(color = user)) +
  scale_alpha_manual(values = c(0.2, 1)) +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(. ~ area) + theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Proportion of pelagic rockfish that were black", x = "Year") +
  scale_shape_manual(values = c(18, 18,10,17,17)) +
  scale_size_manual(values = c(2,2,3,2,2))

ggsave("../figures/bayes_model/p_black.png", width = 10, height = 8) 
X <- X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check
```
 
### P(yelloweye|non-pelagic / yelloweye|DSR)
 
```{r, fig.width = 11.5, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Annual estimates of the percent of the sport harvest of non-pelagic rockfish that were yelloweye rockfish for 16 commerical fishing manamgent areas, 1996-2023. Note that P(yelloweye) is the the proportion relative to non-pelagics for Central and Kodiak areas but is relative to DSR for Southeast areas.")}
pal <- wes_palette(name = "FantasticFox1", n=3)[c(1,5)]

p_yellow_mod <- 
  rbind(postH$mean$p_yellow[,,1] %>% t(),
        postH$mean$p_yellow[,,2] %>% t()) %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "model") %>%
  pivot_longer(-c(year, user, source), names_to = "area", values_to = "p_yellow")  %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(rbind(postH$q2.5$p_yellow[,,1] %>% t(),
                  postH$q2.5$p_yellow[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "p_lo95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user")) %>%
  left_join(rbind(postH$q97.5$p_yellow[,,1] %>% t(),
                  postH$q97.5$p_yellow[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "p_hi95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user")) %>%
  left_join(rbind(postH$q25$p_yellow[,,1] %>% t(),
                  postH$q25$p_yellow[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "p_lo50")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user")) %>%
  left_join(rbind(postH$q75$p_yellow[,,1] %>% t(),
                  postH$q75$p_yellow[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "p_hi50")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user")) %>%
  left_join(rbind(postH$q50$p_yellow[,,1] %>% t(),
                  postH$q50$p_yellow[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "med_p")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user"))

p_yellow_obs <-
#  jags_dat[grep("comp_", names(jags_dat), value = TRUE)] %>%
  jags_dat[grep("comp_(?!.*_x)", names(jags_dat), value = TRUE, perl = TRUE)] %>%
  as.data.frame() %>%
  mutate(year = comp_year + 1976,
         area = unique(H_ayg$area)[comp_area],
         user = ifelse(comp_user == 0, "charter", "private"),
         p_yellow = ifelse(comp_area < 11,
                           comp_yellow / (comp_N - comp_pelagic),
                           comp_yellow / comp_dsr),
         area = factor(area, unique(H_ayg$area), ordered = TRUE))

#p_yellowX_obs <- compX %>%
#  mutate(p_yellow = yellow_x / (N - pelagic),
#         user = ifelse(user_n == 0, "charter", "private"))

rbind(beta0_ye <- postH$q50$beta0_yellow,
      beta1_ye <- postH$q50$beta1_yellow,
      beta2_ye <- postH$q50$beta2_yellow,
      beta3_ye <- postH$q50$beta3_yellow,
      beta4_ye <- postH$q50$beta4_yellow) %>% t() %>%
  data.frame() %>%
  mutate(area = unique(H_ayg$area)) %>%
  rename(beta0 = X1, beta1=X2, beta2=X3, beta3=X4, beta4 = X5) %>%
  right_join(expand.grid(y = seq(1,end_yr-start_yr+1,1), u = c(1, 2), 
                         area = factor(comp$area, unique(H_ayg$area), ordered = TRUE)),
             by = "area") %>%
  mutate(logit_y = beta0 +
           beta1 / (1 + exp(-beta2 * (y - beta3))) +
           beta4 * (u - 1),
         p_yellow = logit_to_prob(logit_y),
         year = y + 1976,
         user = ifelse(u == 1, "charter","private"))-> yellow_trend

southeast <- c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO")
central <- c("CI","NG","PWSI","PWSO","BSAI","SOKO2SAP","WKMA","afognak","eastside","northeast")
  
rbind(p_yellow_obs) %>%
  ggplot(aes(x = year, y = p_yellow, color = user)) +
  #ggplot(aes(x = year, y = use_p_ye, color = user)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_ribbon(data = p_yellow_mod,
              aes(ymin = p_lo95, ymax = p_hi95, fill = user), 
              alpha = 0.15, color = NA) +
  geom_point() +
  #geom_point(data = p_yellowX_obs, aes(x = year, y = p_yellow), color = "yellow", size = 0.5) +
  geom_line(data = p_yellow_mod, linetype = 2) +
  geom_line(data = yellow_trend) +
  #geom_hline(data = p_yellow_trend, aes(yintercept = p_yellow), linetype = 2) +
  scale_alpha_manual(values = c(0.2, 1)) +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(. ~ area) + theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Proportion of non-pelagic rockfish that were yelloweye", x = "Year")

ggsave("../figures/bayes_model/p_ye.png", width = 10, height = 8) 
X<-X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check
```
### P(DSR|non-pelagic)
 
```{r, fig.width = 8, fig.height = 4, fig.cap = paste0("**Figure ",X,".**- Annual estimates of the percent of the sport harvest of non-pelagic rockfish that were DSR rockfish for 6 Southeast commerical fishing manamgent areas, 1996-2023.")}
pal <- wes_palette(name = "AsteroidCity1", n=3) 

p_dsr_mod <- 
  rbind(postH$mean$p_dsr[,,1] %>% t(),
        postH$mean$p_dsr[,,2] %>% t()) %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "model") %>%
  pivot_longer(-c(year, user, source), names_to = "area", values_to = "p_dsr")  %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(rbind(postH$q2.5$p_dsr[,,1] %>% t(),
                  postH$q2.5$p_dsr[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "p_lo95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user")) %>%
  left_join(rbind(postH$q97.5$p_dsr[,,1] %>% t(),
                  postH$q97.5$p_dsr[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "p_hi95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user")) %>%
  left_join(rbind(postH$q25$p_dsr[,,1] %>% t(),
                  postH$q25$p_dsr[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "p_lo50")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user")) %>%
  left_join(rbind(postH$q75$p_dsr[,,1] %>% t(),
                  postH$q75$p_dsr[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "p_hi50")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user")) %>%
  left_join(rbind(postH$q50$p_dsr[,,1] %>% t(),
                  postH$q50$p_dsr[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "med_p")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user"))

p_dsr_obs <-
#  jags_dat[grep("comp_", names(jags_dat), value = TRUE)] %>%
  jags_dat[grep("comp_(?!.*_x)", names(jags_dat), value = TRUE, perl = TRUE)] %>%
  as.data.frame() %>%
  mutate(year = comp_year + 1976,
         area = unique(H_ayg$area)[comp_area],
         user = ifelse(comp_user == 0, "charter", "private"),
         p_dsr = comp_dsr / (comp_N - comp_pelagic),
         area = factor(area, unique(H_ayg$area), ordered = TRUE))

#rbind(beta0_dsr <- postH$q50$beta0_dsr,
#      beta1_dsr <- postH$q50$beta1_dsr,
#      beta2_dsr <- postH$q50$beta2_dsr,
#      beta3_dsr <- postH$q50$beta3_dsr,
#      beta4_dsr <- postH$q50$beta4_dsr) %>% t() %>%
#  data.frame() %>%
#  mutate(area = unique(H_ayg$area)) %>%
#  rename(beta0 = X1, beta1=X2, beta2=X3, beta3=X4, beta4 = X5) %>%
#  right_join(expand.grid(y = seq(1,end_yr-start_yr+1,1), u = c(1, 2), 
#                         area = factor(comp$area, unique(H_ayg$area), ordered = TRUE)),
#             by = "area") %>%
#  mutate(logit_y = beta0 +
#           beta1 / (1 + exp(-beta2 * (y - beta3))) +
#           beta4 * (u - 1),
#         p_dsr = logit_to_prob(logit_y),
#         year = y + 1976,
#         user = ifelse(u == 1, "charter","private"))-> dsr_trend

southeast <- c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO")
central <- c("CI","NG","PWSI","PWSO","BSAI","SOKO2SAP","WKMA","afognak","eastside","northeast")
  
rbind(p_dsr_obs) %>% filter(area %in% southeast) %>%
  ggplot(aes(x = year, y = p_dsr, color = user)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_ribbon(data = p_dsr_mod %>% filter(area %in% southeast),
              aes(ymin = p_lo95, ymax = p_hi95, fill = user), 
              alpha = 0.15, color = NA) +
  geom_point() +
  #geom_point(data = p_yellowX_obs, aes(x = year, y = p_yellow), color = "yellow", size = 0.5) +
  geom_line(data = p_dsr_mod %>% filter(area %in% southeast), linetype = 2) +
  #geom_line(data = dsr_trend %>% filter(area %in% southeast)) +
  #geom_hline(data = p_yellow_trend, aes(yintercept = p_yellow), linetype = 2) +
  scale_alpha_manual(values = c(0.2, 1)) +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(. ~ area) + theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Proportion of non-pelagics that were DSR", x = "Year")

ggsave("../figures/bayes_model/p_dsr.png", width = 7, height = 4) 
X <- X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check
```

### P(slope|non-pelagic)
 
```{r, fig.width = 8, fig.height = 4, fig.cap = paste0("**Figure ",X,".**- Annual estimates of the percent of the sport harvest of non-pelagic rockfish that were slope rockfish for 6 southeast commerical fishing manamgent areas, 1996-2023. Note that P(yelloweye) is the the proportion relative to non-pelagics for Central and Kodiak areas but is relative to DSR for Southeast areas.")}
pal <- wes_palette(name = "Rushmore1")[c(3,4)] 

p_slope_mod <- 
  rbind(postH$mean$p_slope[,,1] %>% t(),
        postH$mean$p_slope[,,2] %>% t()) %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "model") %>%
  pivot_longer(-c(year, user, source), names_to = "area", values_to = "p_slope")  %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(rbind(postH$q2.5$p_slope[,,1] %>% t(),
                  postH$q2.5$p_slope[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "p_lo95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user")) %>%
  left_join(rbind(postH$q97.5$p_slope[,,1] %>% t(),
                  postH$q97.5$p_slope[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "p_hi95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user")) %>%
  left_join(rbind(postH$q25$p_slope[,,1] %>% t(),
                  postH$q25$p_slope[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "p_lo50")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user")) %>%
  left_join(rbind(postH$q75$p_slope[,,1] %>% t(),
                  postH$q75$p_slope[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "p_hi50")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user")) %>%
  left_join(rbind(postH$q50$p_slope[,,1] %>% t(),
                  postH$q50$p_slope[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "med_p")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user"))

p_slope_obs <-
#  jags_dat[grep("comp_", names(jags_dat), value = TRUE)] %>%
  jags_dat[grep("comp_(?!.*_x)", names(jags_dat), value = TRUE, perl = TRUE)] %>%
  as.data.frame() %>%
  mutate(year = comp_year + 1976,
         area = unique(H_ayg$area)[comp_area],
         user = ifelse(comp_user == 0, "charter", "private"),
         p_slope = comp_slope / (comp_N - comp_pelagic),
         area = factor(area, unique(H_ayg$area), ordered = TRUE))

#rbind(beta0_slope <- postH$q50$beta0_slope,
#      beta1_slope <- postH$q50$beta1_slope,
#      beta2_slope <- postH$q50$beta2_slope,
#      beta3_slope <- postH$q50$beta3_slope,
#      beta4_slope <- postH$q50$beta4_slope) %>% t() %>%
#  data.frame() %>%
#  mutate(area = unique(H_ayg$area)) %>%
#  rename(beta0 = X1, beta1=X2, beta2=X3, beta3=X4, beta4 = X5) %>%
#  right_join(expand.grid(y = seq(1,end_yr-start_yr+1,1), u = c(1, 2), 
#                         area = factor(comp$area, unique(H_ayg$area), ordered = TRUE)),
#             by = "area") %>%
#  mutate(logit_y = beta0 +
#           beta1 / (1 + exp(-beta2 * (y - beta3))) +
#           beta4 * (u - 1),
#         p_slope = logit_to_prob(logit_y),
#         year = y + 1976,
#         user = ifelse(u == 1, "charter","private"))-> slope_trend

southeast <- c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO")
central <- c("CI","NG","PWSI","PWSO","BSAI","SOKO2SAP","WKMA","afognak","eastside","northeast")
  
rbind(p_slope_obs %>% filter(area %in% southeast)) %>%
  ggplot(aes(x = year, y = p_slope, color = user)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_ribbon(data = p_slope_mod %>% filter(area %in% southeast),
              aes(ymin = p_lo95, ymax = p_hi95, fill = user), 
              alpha = 0.15, color = NA) +
  geom_point() +
  #geom_point(data = p_yellowX_obs, aes(x = year, y = p_yellow), color = "yellow", size = 0.5) +
  geom_line(data = p_slope_mod %>% filter(area %in% southeast), linetype = 2) +
#  geom_line(data = slope_trend %>% filter(area %in% southeast)) +
  #geom_hline(data = p_yellow_trend, aes(yintercept = p_yellow), linetype = 2) +
  scale_alpha_manual(values = c(0.2, 1)) +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(. ~ area) + theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Proportion of non-pelagics that were slope", x = "Year")

ggsave("../figures/bayes_model/p_slope_harv.png", width = 7, height = 4) 
X <- X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check
```
<br><br>

### P(slope|non-pelagic & non-yellowye) *For release estimates*
 
```{r, fig.width = 8, fig.height = 4, fig.cap = paste0("**Figure ",X,".**- Annual estimates of the percent of the sport non-pelagic, non-yelloweye releases that were slope rockfish for 6 southeast commerical fishing manamgent areas, 1996-2023. ")}
pal <- wes_palette(name = "Rushmore1")[c(3,4)] 

pr_slope_mod <- 
  rbind(postH$mean$pr_slope[,,1] %>% t(),
        postH$mean$pr_slope[,,2] %>% t()) %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "model") %>%
  pivot_longer(-c(year, user, source), names_to = "area", values_to = "pr_slope")  %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(rbind(postH$q2.5$pr_slope[,,1] %>% t(),
                  postH$q2.5$pr_slope[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "p_lo95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user")) %>%
  left_join(rbind(postH$q97.5$pr_slope[,,1] %>% t(),
                  postH$q97.5$pr_slope[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "p_hi95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user")) %>%
  left_join(rbind(postH$q25$pr_slope[,,1] %>% t(),
                  postH$q25$pr_slope[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "p_lo50")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user")) %>%
  left_join(rbind(postH$q75$pr_slope[,,1] %>% t(),
                  postH$q75$pr_slope[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "p_hi50")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user")) %>%
  left_join(rbind(postH$q50$pr_slope[,,1] %>% t(),
                  postH$q50$pr_slope[,,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year)))) %>%
              pivot_longer(-c(year, user), names_to = "area", values_to = "med_p")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user"))

pr_slope_obs <-
#  jags_dat[grep("comp_", names(jags_dat), value = TRUE)] %>%
  jags_dat[grep("comp_(?!.*_x)", names(jags_dat), value = TRUE, perl = TRUE)] %>%
  as.data.frame() %>%
  mutate(year = comp_year + 1976,
         area = unique(H_ayg$area)[comp_area],
         user = ifelse(comp_user == 0, "charter", "private"),
         pr_slope = comp_slope / (comp_N - comp_pelagic - comp_yellow),
         area = factor(area, unique(H_ayg$area), ordered = TRUE))

#rbind(beta0_slope <- postH$q50$beta0_slope,
#      beta1_slope <- postH$q50$beta1_slope,
#      beta2_slope <- postH$q50$beta2_slope,
#      beta3_slope <- postH$q50$beta3_slope,
#      beta4_slope <- postH$q50$beta4_slope,
#      beta5_rslope <- postH$q50$beta4_slope) %>% t() %>%
#  data.frame() %>%
#  mutate(area = unique(H_ayg$area)) %>%
#  rename(beta0 = X1, beta1=X2, beta2=X3, beta3=X4, beta4 = X5, beta5 = X6) %>%
#  right_join(expand.grid(y = seq(1,end_yr-start_yr+1,1), u = c(1, 2), 
#                         area = factor(comp$area, unique(H_ayg$area), ordered = TRUE)),
#             by = "area") %>%
#  mutate(logit_y = beta0 +
#           beta1 / (1 + exp(-beta2 * (y - beta3))) +
#           beta4 * (u - 1) + beta5,
#         pr_slope = logit_to_prob(logit_y),
#         year = y + 1976,
#         user = ifelse(u == 1, "charter","private"))-> rslope_trend

southeast <- c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO")
central <- c("CI","NG","PWSI","PWSO","BSAI","SOKO2SAP","WKMA","afognak","eastside","northeast")
  
rbind(pr_slope_obs %>% filter(area %in% southeast)) %>%
  ggplot(aes(x = year, y = pr_slope, color = user)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_ribbon(data = pr_slope_mod %>% filter(area %in% southeast),
              aes(ymin = p_lo95, ymax = p_hi95, fill = user), 
              alpha = 0.15, color = NA) +
  geom_point() +
  #geom_point(data = p_yellowX_obs, aes(x = year, y = p_yellow), color = "yellow", size = 0.5) +
  geom_line(data = pr_slope_mod %>% filter(area %in% southeast), linetype = 2) +
  #geom_line(data = rslope_trend %>% filter(area %in% southeast)) +
  #geom_hline(data = p_yellow_trend, aes(yintercept = p_yellow), linetype = 2) +
  scale_alpha_manual(values = c(0.2, 1)) +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(. ~ area) + theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Proportion of non-pelagics and non-yelloweye releases that were slope", x = "Year")

ggsave("../figures/bayes_model/p_slope_rel.png", width = 7, height = 4) 
X <- X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check
```
<br><br>

### Weight Fits
```{r, fig.width = 10, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Mean weights of black rockfish used to estimate biomass from harvest and release mortality estimates in numbers of fish.")}
pal <- wes_palette(name = "Moonrise2", n=3)

brf_wt_mod <- 
  rbind(postH$mean$wt[,,1,1] %>% t(), #area,year,user,species
        postH$mean$wt[,,2,1] %>% t()) %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "model") %>%
  pivot_longer(-c(year, user,source), names_to = "area", values_to = "wt")  %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(rbind(postH$q2.5$wt[,,1,1] %>% t(),
                  postH$q2.5$wt[,,2,1] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "w_lo95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source")) %>%
  left_join(rbind(postH$q97.5$wt[,,1,1] %>% t(),
                  postH$q97.5$wt[,,2,1] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "w_hi95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source")) %>%
  left_join(rbind(postH$sd$wt[,,1,1] %>% t(),
                  postH$sd$wt[,,2,1] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "sd_wt")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source"))
brf_wt_obs <- 
  as.data.frame(
    rbind(cbind(t(jags_dat$r2_gwt_b),t(jags_dat$r1_gwt_b)),
          cbind(t(jags_dat$r2_uwt_b),t(jags_dat$r1_uwt_b)))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "port samples") %>%
  pivot_longer(-c(year, user,source), names_to = "area", values_to = "wt") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE))  %>% 
  left_join(
    as.data.frame(
    rbind(cbind(t(jags_dat$r2_gwtcv_b),t(jags_dat$r1_gwtcv_b)),
          cbind(t(jags_dat$r2_uwtcv_b),t(jags_dat$r1_uwtcv_b)))) %>%
    setNames(nm = unique(H_ayg$area)) %>%
    mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "samples") %>%
    pivot_longer(-c(year, user,source), names_to = "area", values_to = "wt_cv"),
    by = c("year","user","source","area")
  ) %>%
  filter(!is.na(wt)) %>%
  mutate(lo_95 = wt - wt * (1.95 * wt_cv),
         hi_95 = wt + wt * (1.95 * wt_cv),
         area = factor(area, unique(H_ayg$area), ordered = TRUE))
  
brf_wt_mod %>% #filter(user != "all") %>%
  ggplot(aes(x = year, y = wt, color = user, shape = source)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_ribbon(aes(ymin = w_lo95, ymax = w_hi95, fill = user), 
              alpha = 0.2, color = NA) +
  #geom_point(aes(shape = source)) + 
  geom_line() + geom_point(alpha = 0.5, size = 0.5) +
  geom_point(data  = brf_wt_obs, size = 2) +
  #geom_line(data = brf_wt_mod, aes(color = user)) +
  #geom_line(data = pHpel_trend, aes(color = user)) +
  #geom_hline(data = p_pelagic_trend, aes(yintercept = p_pelagic), linetype = 2) +
  #coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(. ~ area) +
  scale_shape_manual(values = c(18, 10)) + theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Wt (lbs)", x = "Year")

ggsave("../figures/bayes_model/brf_wts.png", width = 10, height = 8) 
X <- X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check

``` 
<br>

```{r, fig.width = 10, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Mean weights of yelloweye rockfish used to estimate biomass from harvest and release mortality estimates in numbers of fish.")}
pal <- wes_palette(name = "Moonrise2", n=3)

ye_wt_mod <- 
  rbind(postH$mean$wt[,,1,2] %>% t(), #area,year,user,species
        postH$mean$wt[,,2,2] %>% t()) %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "model") %>%
  pivot_longer(-c(year, user,source), names_to = "area", values_to = "wt")  %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(rbind(postH$q2.5$wt[,,1,2] %>% t(),
                  postH$q2.5$wt[,,2,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "w_lo95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source")) %>%
  left_join(rbind(postH$q97.5$wt[,,1,2] %>% t(),
                  postH$q97.5$wt[,,2,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "w_hi95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source")) %>%
  left_join(rbind(postH$sd$wt[,,1,2] %>% t(),
                  postH$sd$wt[,,2,2] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "sd_wt")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source"))
ye_wt_obs <- 
  as.data.frame(
    rbind(cbind(t(jags_dat$r2_gwt_y),t(jags_dat$r1_gwt_y)),
          cbind(t(jags_dat$r2_uwt_y),t(jags_dat$r1_uwt_y)))) %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "port samples") %>%
  pivot_longer(-c(year, user,source), names_to = "area", values_to = "wt") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE))  %>% 
  left_join(
    as.data.frame(
    rbind(cbind(t(jags_dat$r2_gwtcv_y),t(jags_dat$r1_gwtcv_y)),
          cbind(t(jags_dat$r2_uwtcv_y),t(jags_dat$r1_uwtcv_y)))) %>%
    setNames(nm = unique(H_ayg$area)) %>%
    mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "samples") %>%
    pivot_longer(-c(year, user,source), names_to = "area", values_to = "wt_cv"),
    by = c("year","user","source","area")
  ) %>%
  filter(!is.na(wt)) %>%
  mutate(lo_95 = wt - wt * (1.95 * wt_cv),
         hi_95 = wt + wt * (1.95 * wt_cv),
         area = factor(area, unique(H_ayg$area), ordered = TRUE))
  
ye_wt_mod %>% #filter(user != "all") %>%
  ggplot(aes(x = year, y = wt, color = user, shape = source)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_ribbon(aes(ymin = w_lo95, ymax = w_hi95, fill = user), 
              alpha = 0.2, color = NA) +
  #geom_point(aes(shape = source)) + 
  geom_line() + geom_point(alpha = 0.5, size = 0.5) +
  geom_point(data  = ye_wt_obs, size = 2) +
  facet_wrap(. ~ area) +
  scale_shape_manual(values = c(18, 10)) + theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Wt (lbs)", x = "Year")

ggsave("../figures/bayes_model/ye_wts.png", width = 10, height = 8) 
X <- X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check
``` 
<br>
```{r, fig.width = 8, fig.height = 4, fig.cap = paste0("**Figure ",X,".**- Mean weights of non-black, pelagic rockfish used to estimate biomass from harvest and release mortality estimates in numbers of fish.")}
pal <- wes_palette(name = "Moonrise2", n=3)

pel_wt_mod <- 
  rbind(postH$mean$wt[,,1,3] %>% t(), #area,year,user,species
        postH$mean$wt[,,2,3] %>% t()) %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "model") %>%
  pivot_longer(-c(year, user,source), names_to = "area", values_to = "wt")  %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(rbind(postH$q2.5$wt[,,1,3] %>% t(),
                  postH$q2.5$wt[,,2,3] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "w_lo95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source")) %>%
  left_join(rbind(postH$q97.5$wt[,,1,3] %>% t(),
                  postH$q97.5$wt[,,2,3] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "w_hi95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source")) %>%
  left_join(rbind(postH$sd$wt[,,1,3] %>% t(),
                  postH$sd$wt[,,2,3] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "sd_wt")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source"))
pel_wt_obs <- 
  as.data.frame(
    rbind(cbind(t(jags_dat$r1_gwt_p)),
          cbind(t(jags_dat$r1_uwt_p)))) %>%
  setNames(nm = unique(H_ayg$area)[11:16]) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "port samples") %>%
  pivot_longer(-c(year, user,source), names_to = "area", values_to = "wt") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE))  %>% 
  left_join(
    as.data.frame(
    rbind(cbind(t(jags_dat$r1_gwtcv_p)),
          cbind(t(jags_dat$r1_uwtcv_p)))) %>%
    setNames(nm = unique(H_ayg$area)[11:16]) %>%
    mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "samples") %>%
    pivot_longer(-c(year, user,source), names_to = "area", values_to = "wt_cv"),
    by = c("year","user","source","area")
  ) %>%
  filter(!is.na(wt)) %>%
  mutate(lo_95 = wt - wt * (1.95 * wt_cv),
         hi_95 = wt + wt * (1.95 * wt_cv),
         area = factor(area, unique(H_ayg$area), ordered = TRUE))

southeast <- c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO")

pel_wt_mod %>% filter(area %in% southeast) %>%
  ggplot(aes(x = year, y = wt, color = user, shape = source)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_ribbon(aes(ymin = w_lo95, ymax = w_hi95, fill = user), 
              alpha = 0.2, color = NA) +
  #geom_point(aes(shape = source)) + 
  geom_line() + geom_point(alpha = 0.5, size = 0.5) +
  geom_point(data  = pel_wt_obs, size = 2) +
  facet_wrap(. ~ area) +
  scale_shape_manual(values = c(18, 10)) + theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Wt (lbs)", x = "Year")

ggsave("../figures/bayes_model/pel_wts.png", width = 7, height = 4) 
X <- X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check
``` 
<br>
```{r, fig.width = 8, fig.height = 4, fig.cap = paste0("**Figure ",X,".**- Mean weights of non-yelloweye, demersal shelf rockfish used to estimate biomass from harvest and release mortality estimates in numbers of fish.")}
pal <- wes_palette(name = "Moonrise2", n=3)

dsr_wt_mod <- 
  rbind(postH$mean$wt[,,1,4] %>% t(), #area,year,user,species
        postH$mean$wt[,,2,4] %>% t()) %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "model") %>%
  pivot_longer(-c(year, user,source), names_to = "area", values_to = "wt")  %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(rbind(postH$q2.5$wt[,,1,4] %>% t(),
                  postH$q2.5$wt[,,2,4] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "w_lo95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source")) %>%
  left_join(rbind(postH$q97.5$wt[,,1,4] %>% t(),
                  postH$q97.5$wt[,,2,4] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "w_hi95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source")) %>%
  left_join(rbind(postH$sd$wt[,,1,4] %>% t(),
                  postH$sd$wt[,,2,4] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "sd_wt")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source"))
dsr_wt_obs <- 
  as.data.frame(
    rbind(cbind(t(jags_dat$r1_gwt_d)),
          cbind(t(jags_dat$r1_uwt_d)))) %>%
  setNames(nm = unique(H_ayg$area)[11:16]) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "port samples") %>%
  pivot_longer(-c(year, user,source), names_to = "area", values_to = "wt") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE))  %>% 
  left_join(
    as.data.frame(
    rbind(cbind(t(jags_dat$r1_gwtcv_d)),
          cbind(t(jags_dat$r1_uwtcv_d)))) %>%
    setNames(nm = unique(H_ayg$area)[11:16]) %>%
    mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "samples") %>%
    pivot_longer(-c(year, user,source), names_to = "area", values_to = "wt_cv"),
    by = c("year","user","source","area")
  ) %>%
  filter(!is.na(wt)) %>%
  mutate(lo_95 = wt - wt * (1.95 * wt_cv),
         hi_95 = wt + wt * (1.95 * wt_cv),
         area = factor(area, unique(H_ayg$area), ordered = TRUE))

southeast <- c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO")

dsr_wt_mod %>% filter(area %in% southeast) %>%
  ggplot(aes(x = year, y = wt, color = user, shape = source)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_ribbon(aes(ymin = w_lo95, ymax = w_hi95, fill = user), 
              alpha = 0.2, color = NA) +
  #geom_point(aes(shape = source)) + 
  geom_line() + geom_point(alpha = 0.5, size = 0.5) +
  geom_point(data  = dsr_wt_obs, size = 2) +
  facet_wrap(. ~ area) +
  scale_shape_manual(values = c(18, 10)) + theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Wt (lbs)", x = "Year")

ggsave("../figures/bayes_model/dsr_wts.png", width = 7, height = 4) 
X <- X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check
``` 
<br>
```{r, fig.width = 8, fig.height = 4, fig.cap = paste0("**Figure ",X,".**- Mean weights of slope rockfish used to estimate biomass from harvest and release mortality estimates in numbers of fish.")}
pal <- wes_palette(name = "Moonrise2", n=3)

slope_wt_mod <- 
  rbind(postH$mean$wt[,,1,5] %>% t(), #area,year,user,species
        postH$mean$wt[,,2,5] %>% t()) %>%
  as.data.frame() %>%
  setNames(nm = unique(H_ayg$area)) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "model") %>%
  pivot_longer(-c(year, user,source), names_to = "area", values_to = "wt")  %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) %>%
  left_join(rbind(postH$q2.5$wt[,,1,5] %>% t(),
                  postH$q2.5$wt[,,2,5] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "w_lo95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source")) %>%
  left_join(rbind(postH$q97.5$wt[,,1,5] %>% t(),
                  postH$q97.5$wt[,,2,5] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "w_hi95")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source")) %>%
  left_join(rbind(postH$sd$wt[,,1,5] %>% t(),
                  postH$sd$wt[,,2,5] %>% t()) %>%
              as.data.frame() %>%
              setNames(nm = unique(H_ayg$area)) %>%
              mutate(year = rep(unique(Hhat_ay$year), times = 2),
                     user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
                     source = "model") %>%
              pivot_longer(-c(year, user,source), names_to = "area", values_to = "sd_wt")  %>%
              mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)),
            by = c("year","area","user","source"))
slope_wt_obs <- 
  as.data.frame(
    rbind(cbind(t(jags_dat$r1_gwt_s)),
          cbind(t(jags_dat$r1_uwt_s)))) %>%
  setNames(nm = unique(H_ayg$area)[11:16]) %>%
  mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "port samples") %>%
  pivot_longer(-c(year, user,source), names_to = "area", values_to = "wt") %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE))  %>% 
  left_join(
    as.data.frame(
    rbind(cbind(t(jags_dat$r1_gwtcv_s)),
          cbind(t(jags_dat$r1_uwtcv_s)))) %>%
    setNames(nm = unique(H_ayg$area)[11:16]) %>%
    mutate(year = rep(unique(Hhat_ay$year), times = 2),
         user = rep(c("charter", "private"), each = length(unique(Hhat_ay$year))),
         source = "samples") %>%
    pivot_longer(-c(year, user,source), names_to = "area", values_to = "wt_cv"),
    by = c("year","user","source","area")
  ) %>%
  filter(!is.na(wt)) %>%
  mutate(lo_95 = wt - wt * (1.95 * wt_cv),
         hi_95 = wt + wt * (1.95 * wt_cv),
         area = factor(area, unique(H_ayg$area), ordered = TRUE))

southeast <- c("CSEO","EWYKT","NSEI","NSEO","SSEI","SSEO")

slope_wt_mod %>% filter(area %in% southeast) %>%
  ggplot(aes(x = year, y = wt, color = user, shape = source)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_ribbon(aes(ymin = w_lo95, ymax = w_hi95, fill = user), 
              alpha = 0.2, color = NA) +
  #geom_point(aes(shape = source)) + 
  geom_line() + geom_point(alpha = 0.5, size = 0.5) +
  geom_point(data  = slope_wt_obs, size = 2) +
  facet_wrap(. ~ area) +
  scale_shape_manual(values = c(18, 10)) + theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Wt (lbs)", x = "Year")

ggsave("../figures/bayes_model/slope_wts.png", width = 7, height = 4) 
X <- X+1

df <- t(jags_dat$r2_gmort_b)
stopifnot(ncol(df) == length(reg2))  # sanity check
``` 
<br>
### Summary of unconverged parameters:

**Table X.** Unconverged parameters.

```{r}  
#names(rhat)[1] <- "Rhat_values"

rhat_exam <- rhat$Rhat_values %>%
  rownames_to_column(var = "Parameter") %>%
  separate(Parameter, into = c("variable", "index"), sep = "\\[", extra = "merge") %>%
  mutate(index = str_replace(index, "\\]", ""),
         index_n = str_count(index, ","))

with(rhat_exam, table(variable)) %>% data.frame() %>%
  filter(!str_detect(variable, "Bb|By|Bs|Bd|Bs|_mort|Tb|Tp|Ty|Td|Ts")) -> unconverged1
  
rhat_exam %>%  separate(index, into = c("area_n", "i2", "i3","i4"), sep = ",", fill = "right") %>%
  mutate(year = ifelse(!str_detect(variable, "beta"),
                       i2,NA),
         user = ifelse(!str_detect(variable, "beta") & index_n %in% c(2,3),
                       i3, NA),
         species = ifelse(str_detect(variable, "beta"),i2,
                          ifelse(index_n == 3, i4, NA))) %>%
  left_join(comp %>% select(area,area_n) %>% unique() %>%
              add_row(area = "BSAI", area_n = 5) %>%
              add_row(area = "SOKO2SAP", area_n = 6) %>%
              add_row(area = "WKMA", area_n = 7) %>%
              mutate(area_n = as.character(area_n)),
            by = "area_n") %>%
  select(area, variable, year, user, species, Rhat) %>%
  filter(!str_detect(variable, "Bb|By|Bs|_mort|Tb|Tp|Ty")) %>%
  arrange(area, -Rhat, variable) -> unconverged

flextable(unconverged1) %>%
  #set_caption("Table 1. Biological reference points from the base assessment model, including estimates of maximum sustained yield (MSY), stock status, exploitation rates corresponding to MSY values.",
 #             align_with_table = TRUE, style = "Table Caption") %>%
  autofit() %>%
  flextable::font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 12, part = "all") %>%
  #align(j = 2:4, align = "center", part = "all") %>%
  set_table_properties(width = 1, layout = "autofit")

sumtab <- postH$summary
bad_params <- rownames(sumtab[sumtab[,"Rhat"] > 1.01, , drop = FALSE])
bad_df <- as.data.frame(postH$summary) %>%
  mutate(parameter = rownames(postH$summary)) %>%
  filter(Rhat > 1.1) %>%
  select(parameter, mean, median = `50%`, Rhat) %>%
  mutate(mean = round(mean,3),
         median = round(median,3),
         Rhat = round(Rhat,3))

flextable(bad_df) %>%
  #set_caption("Table 1. Biological reference points from the base assessment model, including estimates of maximum sustained yield (MSY), stock status, exploitation rates corresponding to MSY values.",
 #             align_with_table = TRUE, style = "Table Caption") %>%
  autofit() %>%
  flextable::font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 12, part = "all") %>%
  #align(j = 2:4, align = "center", part = "all") %>%
  set_table_properties(width = 1, layout = "autofit")
    
    
#  mutate(across(starts_with("index"), as.numeric)) %>%
#  left_join(comp %>% select(area,area_n) %>% unique() %>%
#              add_row(area = "BSAI", area_n = 5) %>%
#              add_row(area = "SOKO2SAP", area_n = 6) %>%
#              add_row(area = "WKMA", area_n = 7) %>%
#              mutate(area_n = as.character(area_n)),
#            by = "area_n") %>%
#  mutate(parameter = variable) %>% select(-variable) #%>%

```

```{r}
  
#  filter(parameter %in% c("mu_bc_H", "sd_bc_H",
#                        #"logbc_C", "mu_bc_C", "sd_bc_C",
#                        "bc_C_offset","mu_bc_C_offset","sd_bcCoff",
#                        #User proportions (proportion guided); different for H and C
#                        "b1_pG_H", "b2_pG_H",
#                        "b1_pG_C", "b2_pG_C",
#                        #proportion harvested: 
#                        #polynomial
#                        "mu_beta0_pH","tau_beta0_pH","beta0_pH","beta1_pH","beta2_pH","beta3_pH",
#                        #"re_pH","sd_pH",
#                        #proportions same for catch and harvest? thinking on it?
#                        "beta0_pelagic", "beta1_pelagic", "beta2_pelagic", "beta3_pelagic", "beta4_pelagic", 
#                        "mu_beta0_pelagic", "tau_beta0_pelagic",
#                        "beta0_yellow", "beta1_yellow", "beta2_yellow", "beta3_yellow", "beta4_yellow",
#                        "mu_beta0_yellow", "tau_beta0_yellow",
#                        "beta0_yellow_x", "beta1_yellow_x", "beta2_yellow_x", "beta3_yellow_x", "beta4_yellow_x",
#                        "mu_beta0_yellow_x", "tau_beta0_yellow_x",
#                        "beta0_black", "beta1_black", "beta2_black",  "beta3_black", "beta4_black",
#                        "mu_beta0_black", "tau_beta0_black",
#                        #random effects on species
#                        #"re_pelagic", "re_black","re_yellow",
#                        "sd_comp", 
#                        #
#                        "mu_lambda_H","sigma_lambda_H","beta_H",
#                        #catch estimates and spline parts
#                        #with hierarchichal pline lambda
#                        "mu_lambda_C","sigma_lambda_C","beta_C")) 

#rhat_exam %>% group_by(parameter) %>%
#  summarise(n = n(),
#            badRhat_avg = mean(Rhat)) %>%
#  arrange(-badRhat_avg,-n) ->param_conv

#tabl <- nrow(param_conv)

#round_up_even <- function(x) {
#  rounded <- ceiling(x)
#  if (rounded %% 2 != 0) {
#    rounded <- rounded + 1
#  }
#  return(rounded)
#}

#sapply(tabl, round_up_even) ->col1

#rhat_exam %>% group_by(parameter,area) %>%
#  summarise(n = n(),
#            badRhat_avg = mean(Rhat)) %>%
#  arrange(-badRhat_avg,-n) -> par_x_area

#with(par_x_area, table(parameter,area)) -> par_x_area_tbl

#t1 <- param_conv %>% slice(1:(col1*0.5))
#t2 <- param_conv %>% slice(((col1*0.5)+1):tabl)

#kable1 <- t1 %>% 
#  kable(format = "html") %>% 
#  kable_styling(full_width = FALSE)

#kable2 <- t2 %>% 
#  kable(format = "html") %>% 
#  kable_styling(full_width = FALSE)

# Display side-by-side using a table layout
#div <- tags$table(
#  style = "width: 100%;",
#  tags$tr(
#    tags$td(style = "width: 50%;", HTML(kable1)),
#    tags$td(style = "width: 50%;", HTML(kable2))
#  )
#)

#caption <- tags$caption(
#  style = "text-align: center; font-weight: bold; margin-bottom: 10px;",
#  tags$strong("Table 1. "),
#  "Summary of unconverged parameters including the number (n) and the average Rhat from the unconverged parameters."
#)

#kable(par_x_area_tbl, booktabs = TRUE, longtable = FALSE,  #format = "latex", 
#      escape = FALSE, #align = c("l",rep("c",ncol(tab1)-1)),
#      caption = "**Table 2.** Summary of unconverged major parameters by area") %>% kable_styling(full_width = F)

```
```{r}
#rhat_exam2 <- rhat$Rhat_values %>%
#  rownames_to_column(var = "Parameter") %>%
#  separate(Parameter, into = c("variable", "index"), sep = "\\[", extra = "merge") %>%
#  mutate(index = str_replace(index, "\\]", "")) %>%
#  separate(index, into = c("area_n", "year", "user"), sep = ",", fill = "right") %>%
#  mutate(across(starts_with("index"), as.numeric)) %>%
#  left_join(comp %>% select(area,area_n) %>% unique() %>%
#              add_row(area = "BSAI", area_n = 5) %>%
#              add_row(area = "SOKO2SAP", area_n = 6) %>%
#              add_row(area = "WKMA", area_n = 7) %>%
#              mutate(area_n = as.character(area_n)),
#            by = "area_n") %>%
#  arrange(-Rhat)

#rhat_exam2 %>% filter(!is.na(rhat_exam2$year) & !is.na(rhat_exam2$area_n)) -> more_bad
#unique(more_bad$variable)
#with(more_bad, table(variable,area)) %>% data.frame() %>%
#  pivot_wider(names_from = area, values_from = Freq) -> unconv

#unconv %>% 
#  filter(str_detect(variable, str_c(c("R","H","p"), collapse = "|"))) %>% data.frame-> unconv

#par_x_area_tbl %>%
#  data.frame() %>%
#  pivot_wider(names_from = area, 
#              values_from = Freq) -> unconv2

#for (i in factor(unique(H_ayg$area), ordered = TRUE)){ #i <- factor(unique(H_ayg$area), ordered = TRUE)[2]
#  col_name <- as.character(i)
#  if (i %in% c(colnames(unconv))) {} else 
#    {unconv$new = 0
#    unconv <- unconv %>% rename(!!col_name := new)}
#  if (i %in% c(colnames(unconv2))) {} else 
#    {unconv2$new = 0
#    unconv2 <- unconv2 %>% rename(!!col_name := new)}
#}

#rbind(unconv %>% rename(parameter = variable),
#      unconv2) %>%
#  select(Parameter = parameter, CI,NG,PWSI,PWSO,BSAI,SOKO2SAP,WKMA,afognak,eastside,northeast,
#         CSEO,EWYKT,NSEI,NSEO,SSEI,SSEO) %>%
#  arrange(Parameter) -> unconverged

# Display the caption and the tables
#tags$div(
#  caption,
#  div
#)

#kable(unconverged, booktabs = TRUE, longtable = FALSE,  #format = "latex", 
#      escape = FALSE, #align = c("l",rep("c",ncol(tab1)-1)),
#      caption = "**Table 2.** Summary of unconverged major parameters by area") %>% kable_styling(full_width = F)


```

### Parameter estimates: 
```{r}
#kable(summary_table, 
#      digits = 3, 
#      format = "markdown", 
#      caption = "Parameter Estimates with Credibility Intervals")

summary_table %>%
  kbl(digits = 3, caption = "Summary Table of Parameter Estimates") %>%
  kable_styling(full_width = FALSE, position = "center", font_size = 10, fixed_thead = TRUE)
```

```{r}
# SAVE all of the model output and estimates. Make some plots of mortality source.

# Save all the results in an EXCEL workbook to share with staff
rep_wb <- createWorkbook()
rep_wb <- wb_workbook()

#All rockfish numbers only
full_join(TotH_wb,TotR_wb, by = c("region","area","year","user")) %>%
  mutate(area = factor(area, unique(H_ayg$area), ordered = TRUE)) -> allRF
rep_wb$add_worksheet("All_RF")
rep_wb$add_data("All_RF",allRF)

#Black Rockfish
t(jags_dat$r1_gmort_b) %>% data.frame() %>%
  rename_with(~southeast) %>%
  mutate(year = unique(brfH_wb$year),
         user = "guided") %>%
  pivot_longer(cols = southeast,
               names_to = "area",
               values_to = "mort_rate") %>%
  rbind(t(jags_dat$r1_umort_b) %>% data.frame() %>%
    rename_with(~southeast) %>%
    mutate(year = unique(brfH_wb$year),
          user = "unguided") %>%
    pivot_longer(cols = southeast,
               names_to = "area",
               values_to = "mort_rate")) %>%
  rbind(t(jags_dat$r2_gmort_b[c(1:10),]) %>% data.frame() %>%
    #rename_with(~reg2) %>%
    setNames(reg2) %>%
    mutate(year = unique(brfH_wb$year),
         user = "guided") %>%
    pivot_longer(cols = reg2,
               names_to = "area",
               values_to = "mort_rate") ) %>%
  rbind(t(jags_dat$r2_umort_b[c(1:10),]) %>% data.frame() %>%
    #rename_with(~reg2) %>%
    setNames(reg2) %>%
    mutate(year = unique(brfH_wb$year),
         user = "unguided") %>%
    pivot_longer(cols = reg2,
               names_to = "area",
               values_to = "mort_rate") ) -> brf_m_rates

#unique(brf_wt_mod$area)
#unique(brf_m$area)
#unique(brfH_wb$area)

#s1 <- full_join(brfH_wb,brfR_wb, by = c("region","area","year","user"))
#print(s1); nrow(s1 %>% filter(is.na(Releases)))

#unique(brfH_wb$area)
#unique(brf_wt_mod$area)
#unique(brf_m$area)
#unique(brf_m_rates$area)

full_join(brfH_wb,brfR_wb, by = c("region","area","year","user")) %>%
  full_join(brf_m_rates %>%
              mutate(area = toupper(area)), 
            by = c("area","year","user")) %>%
  full_join(brf_wt_mod %>% 
              mutate(wt = round(wt,2), sd_wt = round(sd_wt,2),
                     user = ifelse(user == "charter","guided","unguided"),
                     area = toupper(area)) %>%
              select(-w_lo95,-w_hi95,-source), 
            by = c("area","year","user")) %>%
  full_join(brf_m, by = c("region","area","year","user")) %>%
  mutate(p_mort_H = Harvests / (Release_morts + Harvests),
         p_mort_R = Release_morts / (Release_morts + Harvests),
         area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE))-> BRF_wb

#unique(BRF_wb$area)
#ch <- createWorkbook()
#ch <- wb_workbook()
#ch$add_worksheet("Black")
#ch$add_data("Black",BRF_wb)
#if (interactive()) ch$open()

rep_wb$add_worksheet("Black")
rep_wb$add_data("Black",BRF_wb)

```

```{r}

## Yelloweye
t(jags_dat$r1_gmort_y) %>% data.frame() %>%
  rename_with(~southeast) %>%
  mutate(year = unique(brfH_wb$year),
         user = "guided") %>%
  pivot_longer(cols = southeast,
               names_to = "area",
               values_to = "mort_rate") %>%
  rbind(t(jags_dat$r1_umort_y) %>% data.frame() %>%
    rename_with(~southeast) %>%
    mutate(year = unique(brfH_wb$year),
          user = "unguided") %>%
    pivot_longer(cols = southeast,
               names_to = "area",
               values_to = "mort_rate")) %>%
  rbind(t(jags_dat$r2_gmort_y[c(1:10),]) %>% data.frame() %>%
    #rename_with(~reg2) %>%
    setNames(reg2) %>%
    mutate(year = unique(brfH_wb$year),
         user = "guided") %>%
    pivot_longer(cols = reg2,
               names_to = "area",
               values_to = "mort_rate") ) %>%
  rbind(t(jags_dat$r2_umort_y[c(1:10),]) %>% data.frame() %>%
    #rename_with(~reg2) %>%
    setNames(reg2) %>%
    mutate(year = unique(brfH_wb$year),
         user = "unguided") %>%
    pivot_longer(cols = reg2,
               names_to = "area",
               values_to = "mort_rate") ) -> ye_m_rates


full_join(yeH_wb,yeR_wb, by = c("region","area","year","user")) %>%
  full_join(ye_m_rates %>%
              mutate(area = toupper(area)), 
            by = c("area","year","user")) %>%
  full_join(ye_wt_mod %>% 
              mutate(wt = round(wt,2), sd_wt = round(sd_wt,2),
                     user = ifelse(user == "charter","guided","unguided"),
                     area = toupper(area)) %>%
              select(-w_lo95,-w_hi95,-source), 
            by = c("area","year","user")) %>%
  full_join(ye_m, by = c("region","area","year","user")) %>%
  mutate(p_mort_H = Harvests / (Release_morts + Harvests),
         p_mort_R = Release_morts / (Release_morts + Harvests),
         area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE))-> YE_wb

rep_wb$add_worksheet("Yelloweye")
rep_wb$add_data("Yelloweye",YE_wb)

```

```{r}

# Non-black Pelagics for Southeast only
t(jags_dat$r1_gmort_p) %>% data.frame() %>%
  rename_with(~southeast) %>%
  mutate(year = unique(brfH_wb$year),
         user = "guided") %>%
  pivot_longer(cols = southeast,
               names_to = "area",
               values_to = "mort_rate") %>%
  rbind(t(jags_dat$r1_umort_p) %>% data.frame() %>%
    rename_with(~southeast) %>%
    mutate(year = unique(brfH_wb$year),
          user = "unguided") %>%
    pivot_longer(cols = southeast,
               names_to = "area",
               values_to = "mort_rate")) -> pel_m_rates

full_join(pelH_wb,pelR_wb, by = c("region","area","year","user")) %>%
  full_join(pel_m_rates %>%
              mutate(area = toupper(area)), 
            by = c("area","year","user")) %>%
  full_join(pel_wt_mod %>% 
              mutate(wt = round(wt,2), sd_wt = round(sd_wt,2),
                     user = ifelse(user == "charter","guided","unguided"),
                     area = toupper(area)) %>%
              select(-w_lo95,-w_hi95,-source), 
            by = c("area","year","user")) %>%
  full_join(pel_m, by = c("region","area","year","user")) %>%
  mutate(p_mort_H = Harvests / (Release_morts + Harvests),
         p_mort_R = Release_morts / (Release_morts + Harvests),
         area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) -> PEL_wb

rep_wb$add_worksheet("Non-black Pelagics")
rep_wb$add_data("Non-black Pelagics",PEL_wb %>% filter(area %in% southeast))

```

```{r}
# Non-YE DSR for Southeast only
t(jags_dat$r1_gmort_d) %>% data.frame() %>%
  rename_with(~southeast) %>%
  mutate(year = unique(brfH_wb$year),
         user = "guided") %>%
  pivot_longer(cols = southeast,
               names_to = "area",
               values_to = "mort_rate") %>%
  rbind(t(jags_dat$r1_umort_d) %>% data.frame() %>%
    rename_with(~southeast) %>%
    mutate(year = unique(brfH_wb$year),
          user = "unguided") %>%
    pivot_longer(cols = southeast,
               names_to = "area",
               values_to = "mort_rate")) -> dsr_m_rates

full_join(dsrH_wb,dsrR_wb, by = c("region","area","year","user")) %>%
  full_join(dsr_m_rates %>%
              mutate(area = toupper(area)), 
            by = c("area","year","user")) %>%
  full_join(dsr_wt_mod %>% 
              mutate(wt = round(wt,2), sd_wt = round(sd_wt,2),
                     user = ifelse(user == "charter","guided","unguided"),
                     area = toupper(area)) %>%
              select(-w_lo95,-w_hi95,-source), 
            by = c("area","year","user")) %>%
  #full_join(dsr_wtcvs, by = c("area","year","user")) %>%
  full_join(dsr_m, by = c("region","area","year","user")) %>%
  mutate(p_mort_H = Harvests / (Release_morts + Harvests),
         p_mort_R = Release_morts / (Release_morts + Harvests),
         area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE))-> DSR_wb

rep_wb$add_worksheet("Non-ye DSR")
rep_wb$add_data("Non-ye DSR",DSR_wb %>% filter(area %in% southeast))

```

```{r}
# Slope for Southeast only
t(jags_dat$r1_gmort_s) %>% data.frame() %>%
  rename_with(~southeast) %>%
  mutate(year = unique(brfH_wb$year),
         user = "guided") %>%
  pivot_longer(cols = southeast,
               names_to = "area",
               values_to = "mort_rate") %>%
  rbind(t(jags_dat$r1_umort_s) %>% data.frame() %>%
    rename_with(~southeast) %>%
    mutate(year = unique(brfH_wb$year),
          user = "unguided") %>%
    pivot_longer(cols = southeast,
               names_to = "area",
               values_to = "mort_rate")) -> slope_m_rates

full_join(slopeH_wb,slopeR_wb, by = c("region","area","year","user")) %>%
  full_join(slope_m_rates %>%
              mutate(area = toupper(area)), 
            by = c("area","year","user")) %>%
  full_join(slope_wt_mod %>% 
              mutate(wt = round(wt,2), sd_wt = round(sd_wt,2),
                     user = ifelse(user == "charter","guided","unguided"),
                     area = toupper(area)) %>%
              select(-w_lo95,-w_hi95,-source), 
            by = c("area","year","user")) %>%
  #full_join(slope_wtcvs, by = c("area","year","user")) %>%
  full_join(slope_m, by = c("region","area","year","user")) %>%
  mutate(p_mort_H = Harvests / (Release_morts + Harvests),
         p_mort_R = Release_morts / (Release_morts + Harvests),
         area = factor(area, toupper(unique(H_ayg$area)), ordered = TRUE)) -> SLOPE_wb

rep_wb$add_worksheet("Slope")
rep_wb$add_data("Slope",SLOPE_wb %>% filter(area %in% southeast))

### Save it all!!
#wb_save(rep_wb, file = "RF_Sport_Removals.xlsx", overwrite = TRUE, path = NULL, flush = FALSE)
wb_save(rep_wb, file = "RF_Sport_Removals.xlsx", overwrite = TRUE, path = NULL)
if (interactive()) rep_wb$open()
#saveWorkbook(res_wb, paste0("SF_Rockfish_Catch_Removal_Ests_thru",end_yr,".xlsx"), overwrite = TRUE)
```

<br>
```{r, fig.width = 10, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Proportion of black rockfish total mortality, in biomass, from harvests and releases.")}
pal <- c(wes_palette(name = "Moonrise2", n=4),"black")

BRF_wb %>% select(area,year,user,p_mort_H,p_mort_R) %>%
  pivot_longer(cols = c(p_mort_H,p_mort_R),
               values_to = "M_prop",
               names_to = "M_source") %>%
  mutate(M_source = ifelse(M_source == "p_mort_H","Harvests","Releases")) -> brf_m_source

BRF_wb %>% select(area,year,user,Harvests,'Release Mortalities' = Release_morts) %>%
  pivot_longer(cols = c(Harvests,'Release Mortalities'),
               values_to = "Mortalities",
               names_to = "Source")  -> brf_m_x_source

brf_m_source %>% filter(user != "all") %>%
  ggplot(aes(x = year, y = M_prop, fill = M_source)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_bar(position="fill", stat="identity") +
  facet_wrap(. ~ area) +
  theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Proportion of total mortality", x = "Year") -> brf_m_prop

ggsave("../figures/bayes_model/brf_mort_props.png",brf_m_prop, width = 10, height = 8) 

brf_m_x_source %>% filter(user != "All") %>%
  mutate(Source = paste0(Source," by ",user)) %>%
  ggplot(aes(x = year, y = Mortalities, fill = Source)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_bar(position="stack", stat="identity") +
  facet_wrap(. ~ area, scales = "free") +
  scale_y_continuous(labels = comma) +
  theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Mortality (n)", x = "Year") -> brf_m_n

ggsave("../figures/bayes_model/brf_mort_source.png",brf_m_n, width = 10, height = 8) 
X <- X+1

brf_removals %>% 
  left_join(brf_m_x_source %>%
              pivot_wider(names_from = Source, values_from = Mortalities) %>% clean_names() %>%
              mutate(p_h = harvests / (harvests + release_mortalities),
                     p_rm = 1 - p_h) %>%
              select(-harvests,-release_mortalities),
            by = c("year","user","area")) %>%
  mutate(h_morts = p_h * B,
         rm_morts = p_rm * B) %>%
  pivot_longer(cols = c(h_morts,rm_morts),
               names_to = "Source",
               values_to = "Removals") ->brf_rem_x_source

brf_rem_x_source %>% filter(user != "All") %>%
  mutate(Source = ifelse(Source == "h_morts","Harvest mortalities","Release mortalities"),
         Source = str_wrap(paste0(Source," by ",user, " anglers")),width = 5) %>%
   
  ggplot(aes(x = year, y = Removals, fill = Source)) +
  scale_fill_manual(values = pal,
                    labels = function(x) str_wrap(x, width = 15)) +
  scale_color_manual(values = pal) +
  #geom_line(data = brf_removals %>% filter(user == "All") %>% mutate(Source = "Total"),
  #          aes(x = year, y = B), col = "lightgrey", fill = "darkgrey", size = 0.25) +
  geom_ribbon(data = brf_removals %>% filter(user == "All") %>% mutate(Source = "Total",
                                                                       Removals = B),
              aes(x=year,ymin = B_lo95, ymax = B_hi95), 
              alpha = 0.3, color = "lightgrey", fill = "darkgrey", size = 0.25) +
  geom_bar(position="stack", stat="identity", width = 0.75) +
  facet_wrap(. ~ area, scales = "free") +
  scale_y_continuous(labels = comma) +
  theme_bw(base_size = 14)+
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    legend.spacing.y = unit(2, "cm"),
    legend.text = element_text(margin = margin(b = 13))
  ) +
  guides(fill = guide_legend(byrow = TRUE)) +
  labs(y = "Mortality (lbs)", x = "Year") -> brf_rem_x_source_lbs

ggsave("../figures/bayes_model/brf_mort_source_lbs.png",brf_rem_x_source_lbs, width = 10, height = 8) 

``` 

<br>
```{r, fig.width = 10, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Proportion of yelloweye rockfish total mortality, in biomass, from harvests and releases.")}
pal <- wes_palette(name = "Moonrise2", n=4)

YE_wb %>% select(area,year,user,p_mort_H,p_mort_R) %>%
  pivot_longer(cols = c(p_mort_H,p_mort_R),
               values_to = "M_prop",
               names_to = "M_source") %>%
  mutate(M_source = ifelse(M_source == "p_mort_H","Harvests","Releases")) -> ye_m_source

YE_wb %>% select(area,year,user,Harvests,'Release Mortalities' = Release_morts) %>%
  pivot_longer(cols = c(Harvests,'Release Mortalities'),
               values_to = "Mortalities",
               names_to = "Source")  -> ye_m_x_source

ye_m_source %>% filter(user != "all") %>%
  ggplot(aes(x = year, y = M_prop, fill = M_source)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_bar(position="fill", stat="identity") +
  facet_wrap(. ~ area) +
  theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Proportion of total mortality", x = "Year") -> ye_m_prop

ggsave("../figures/bayes_model/ye_mort_props.png", ye_m_prop, width = 10, height = 8) 

ye_m_x_source %>% filter(user != "all" & user != "All") %>%
  mutate(Source = paste0(Source," by ",user)) %>%
  ggplot(aes(x = year, y = Mortalities, fill = Source)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_bar(position="stack", stat="identity") +
  facet_wrap(. ~ area, scales = "free") +
  scale_y_continuous(labels = comma) +
  theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Mortality (n)", x = "Year") -> ye_m_n

ggsave("../figures/bayes_model/ye_mort_source.png", ye_m_n, width = 10, height = 8) 
X <- X+1

ye_removals %>% 
  left_join(ye_m_x_source %>%
              pivot_wider(names_from = Source, values_from = Mortalities) %>% clean_names() %>%
              mutate(p_h = harvests / (harvests + release_mortalities),
                     p_rm = 1 - p_h) %>%
              select(-harvests,-release_mortalities),
            by = c("year","user","area")) %>%
  mutate(h_morts = p_h * B,
         rm_morts = p_rm * B) %>%
  pivot_longer(cols = c(h_morts,rm_morts),
               names_to = "Source",
               values_to = "Removals") ->ye_rem_x_source

ye_rem_x_source %>% filter(user != "All" & user != "all") %>%
  mutate(Source = ifelse(Source == "h_morts","Harvest mortalities","Release mortalities"),
         Source = str_wrap(paste0(Source," by ",user, " anglers")),width = 5) %>%
   
  ggplot(aes(x = year, y = Removals, fill = Source)) +
  scale_fill_manual(values = pal,
                    labels = function(x) str_wrap(x, width = 15)) +
  scale_color_manual(values = pal) +
  geom_ribbon(data = ye_removals %>% filter(user == "All") %>% mutate(Source = "Total",
                                                                       Removals = B),
              aes(x=year,ymin = B_lo95, ymax = B_hi95), 
              alpha = 0.3, color = "lightgrey", fill = "darkgrey", size = 0.25) +
  geom_bar(position="stack", stat="identity", width = 0.75) +
  facet_wrap(. ~ area, scales = "free") +
  scale_y_continuous(labels = comma) +
  theme_bw(base_size = 14)+
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    legend.spacing.y = unit(2, "cm"),
    legend.text = element_text(margin = margin(b = 13))
  ) +
  guides(fill = guide_legend(byrow = TRUE)) +
  labs(y = "Mortality (lbs)", x = "Year") -> ye_rem_x_source_lbs

ggsave("../figures/bayes_model/ye_mort_source_lbs.png",ye_rem_x_source_lbs, width = 10, height = 8) 

``` 
<br>
```{r, fig.width = 10, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Proportion of non-black pelagic rockfish total mortality, in biomass, from harvests and releases.")}
pal <- wes_palette(name = "Moonrise2", n=4)

PEL_wb %>% select(area,year,user,p_mort_H,p_mort_R) %>%
  pivot_longer(cols = c(p_mort_H,p_mort_R),
               values_to = "M_prop",
               names_to = "M_source") %>%
  mutate(M_source = ifelse(M_source == "p_mort_H","Harvests","Releases")) -> pel_m_source

PEL_wb %>% select(area,year,user,Harvests,'Release Mortalities' = Release_morts) %>%
  pivot_longer(cols = c(Harvests,'Release Mortalities'),
               values_to = "Mortalities",
               names_to = "Source")  -> pel_m_x_source

pel_m_source %>% filter(user != "all" & area %in% southeast & user != "All") %>%
  ggplot(aes(x = year, y = M_prop, fill = M_source)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_bar(position="fill", stat="identity") +
  facet_wrap(. ~ area) +
  theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Proportion of total mortality", x = "Year") -> pel_m_prop

ggsave("../figures/bayes_model/pel_mort_props.png", pel_m_prop, width = 7, height = 4) 

pel_m_x_source %>% filter(user != "all" & area %in% southeast & user != "All") %>%
  mutate(Source = paste0(Source," by ",user)) %>%
  ggplot(aes(x = year, y = Mortalities, fill = Source)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_bar(position="stack", stat="identity") +
  facet_wrap(. ~ area, scales = "free") +
  scale_y_continuous(labels = comma) +
  theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Mortality (n)", x = "Year") -> pel_m_n

ggsave("../figures/bayes_model/pel_mort_source.png", pel_m_n, width = 7, height = 4) 
X <- X+1

pel_removals %>% 
  left_join(pel_m_x_source %>%
              pivot_wider(names_from = Source, values_from = Mortalities) %>% clean_names() %>%
              mutate(p_h = harvests / (harvests + release_mortalities),
                     p_rm = 1 - p_h) %>%
              select(-harvests,-release_mortalities),
            by = c("year","user","area")) %>%
  mutate(h_morts = p_h * B,
         rm_morts = p_rm * B) %>%
  pivot_longer(cols = c(h_morts,rm_morts),
               names_to = "Source",
               values_to = "Removals") ->pel_rem_x_source

pel_rem_x_source %>% filter(user != "All"  & area %in% southeast ) %>%
  mutate(Source = ifelse(Source == "h_morts","Harvest mortalities","Release mortalities"),
         Source = str_wrap(paste0(Source," by ",user, " anglers")),width = 5) %>%
   
  ggplot(aes(x = year, y = Removals, fill = Source)) +
  scale_fill_manual(values = pal,
                    labels = function(x) str_wrap(x, width = 15)) +
  scale_color_manual(values = pal) +
  geom_ribbon(data = pel_removals %>% filter(user == "All") %>% mutate(Source = "Total",
                                                                       Removals = B),
              aes(x=year,ymin = B_lo95, ymax = B_hi95), 
              alpha = 0.3, color = "lightgrey", fill = "darkgrey", size = 0.25) +
  geom_bar(position="stack", stat="identity", width = 0.75) +
  facet_wrap(. ~ area, scales = "free") +
  scale_y_continuous(labels = comma) +
  theme_bw(base_size = 14)+
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    legend.spacing.y = unit(2, "cm"),
    legend.text = element_text(margin = margin(b = 13))
  ) +
  guides(fill = guide_legend(byrow = TRUE)) +
  labs(y = "Mortality (lbs)", x = "Year") -> pel_rem_x_source_lbs

ggsave("../figures/bayes_model/pel_mort_source_lbs.png",pel_rem_x_source_lbs, width = 7, height = 4)

```
<br>
```{r, fig.width = 10, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Proportion of non-yelloweye demersal shelf rockfish total mortality, in biomass, from harvests and releases.")}
pal <- wes_palette(name = "Moonrise2", n=4)

DSR_wb %>% select(area,year,user,p_mort_H,p_mort_R) %>%
  pivot_longer(cols = c(p_mort_H,p_mort_R),
               values_to = "M_prop",
               names_to = "M_source") %>%
  mutate(M_source = ifelse(M_source == "p_mort_H","Harvests","Releases")) -> dsr_m_source

DSR_wb %>% select(area,year,user,Harvests,'Release Mortalities' = Release_morts) %>%
  pivot_longer(cols = c(Harvests,'Release Mortalities'),
               values_to = "Mortalities",
               names_to = "Source")  -> dsr_m_x_source

dsr_m_source %>% filter(user != "all" & area %in% southeast) %>%
  ggplot(aes(x = year, y = M_prop, fill = M_source)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_bar(position="fill", stat="identity") +
  facet_wrap(. ~ area) +
  theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Proportion of total mortality", x = "Year") -> dsr_m_prop

ggsave("../figures/bayes_model/dsr_mort_props.png", dsr_m_prop, width = 7, height = 4) 

dsr_m_x_source %>% filter(user != "all" & area %in% southeast & user != "All") %>%
  mutate(Source = paste0(Source," by ",user)) %>%
  ggplot(aes(x = year, y = Mortalities, fill = Source)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_bar(position="stack", stat="identity") +
  facet_wrap(. ~ area, scales = "free") +
  scale_y_continuous(labels = comma) +
  theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Mortality (n)", x = "Year") -> dsr_m_n

ggsave("../figures/bayes_model/dsr_mort_source.png", dsr_m_n, width = 7, height = 4) 
X <- X+1

dsrlessye_removals %>% 
  left_join(dsr_m_x_source %>%
              pivot_wider(names_from = Source, values_from = Mortalities) %>% clean_names() %>%
              mutate(p_h = harvests / (harvests + release_mortalities),
                     p_rm = 1 - p_h) %>%
              select(-harvests,-release_mortalities),
            by = c("year","user","area")) %>%
  mutate(h_morts = p_h * B,
         rm_morts = p_rm * B) %>%
  pivot_longer(cols = c(h_morts,rm_morts),
               names_to = "Source",
               values_to = "Removals") ->dsr_rem_x_source

dsr_rem_x_source %>% filter(user != "All"  & area %in% southeast) %>%
  mutate(Source = ifelse(Source == "h_morts","Harvest mortalities","Release mortalities"),
         Source = str_wrap(paste0(Source," by ",user, " anglers")),width = 5) %>%
   
  ggplot(aes(x = year, y = Removals, fill = Source)) +
  scale_fill_manual(values = pal,
                    labels = function(x) str_wrap(x, width = 15)) +
  scale_color_manual(values = pal) +
  geom_ribbon(data = dsrlessye_removals %>% filter(user == "All") %>% mutate(Source = "Total",
                                                                       Removals = B),
              aes(x=year,ymin = B_lo95, ymax = B_hi95), 
              alpha = 0.3, color = "lightgrey", fill = "darkgrey", size = 0.25) +
  geom_bar(position="stack", stat="identity", width = 0.75) +
  facet_wrap(. ~ area, scales = "free") +
  scale_y_continuous(labels = comma) +
  theme_bw(base_size = 14)+
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    legend.spacing.y = unit(2, "cm"),
    legend.text = element_text(margin = margin(b = 13))
  ) +
  guides(fill = guide_legend(byrow = TRUE)) +
  labs(y = "Mortality (lbs)", x = "Year") -> dsr_rem_x_source_lbs

ggsave("../figures/bayes_model/dsr_mort_source_lbs.png",dsr_rem_x_source_lbs, width = 7, height = 4)

``` 
<br>
```{r, fig.width = 10, fig.height = 8, fig.cap = paste0("**Figure ",X,".**- Proportion of non-black pelagic rockfish total mortality, in biomass, from harvests and releases.")}
pal <- wes_palette(name = "Moonrise2", n=4)

SLOPE_wb %>% select(area,year,user,p_mort_H,p_mort_R) %>%
  pivot_longer(cols = c(p_mort_H,p_mort_R),
               values_to = "M_prop",
               names_to = "M_source") %>%
  mutate(M_source = ifelse(M_source == "p_mort_H","Harvests","Releases")) -> slope_m_source

SLOPE_wb %>% select(area,year,user,Harvests,'Release Mortalities' = Release_morts) %>%
  pivot_longer(cols = c(Harvests,'Release Mortalities'),
               values_to = "Mortalities",
               names_to = "Source")  -> slope_m_x_source

slope_m_source %>% filter(user != "all" & area %in% southeast & user != "All") %>%
  ggplot(aes(x = year, y = M_prop, fill = M_source)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_bar(position="fill", stat="identity") +
  facet_wrap(. ~ area) +
  theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Proportion of total mortality", x = "Year") -> slope_m_prop

ggsave("../figures/bayes_model/slope_mort_props.png", slope_m_prop, width = 7, height = 4) 

slope_m_x_source %>% filter(user != "all" & area %in% southeast) %>%
  ggplot(aes(x = year, y = Mortalities, fill = Source)) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_bar(position="stack", stat="identity") +
  facet_wrap(. ~ area) +
  scale_y_continuous(labels = comma) +
  theme_bw(base_size = 14)+
  theme (axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(y = "Mortality (n)", x = "Year") -> slope_m_n

ggsave("../figures/bayes_model/slope_mort_source.png", slope_m_n, width = 7, height = 4) 
X <- X+1

slope_removals %>% 
  left_join(slope_m_x_source %>%
              pivot_wider(names_from = Source, values_from = Mortalities) %>% clean_names() %>%
              mutate(p_h = harvests / (harvests + release_mortalities),
                     p_rm = 1 - p_h) %>%
              select(-harvests,-release_mortalities),
            by = c("year","user","area")) %>%
  mutate(h_morts = p_h * B,
         rm_morts = p_rm * B) %>%
  pivot_longer(cols = c(h_morts,rm_morts),
               names_to = "Source",
               values_to = "Removals") ->slope_rem_x_source

slope_rem_x_source %>% filter(user != "All"  & area %in% southeast) %>%
  mutate(Source = ifelse(Source == "h_morts","Harvest mortalities","Release mortalities"),
         Source = str_wrap(paste0(Source," by ",user, " anglers")),width = 5) %>%
   
  ggplot(aes(x = year, y = Removals, fill = Source)) +
  scale_fill_manual(values = pal,
                    labels = function(x) str_wrap(x, width = 15)) +
  scale_color_manual(values = pal) +
  geom_ribbon(data = slope_removals %>% filter(user == "All") %>% mutate(Source = "Total",
                                                                       Removals = B),
              aes(x=year,ymin = B_lo95, ymax = B_hi95), 
              alpha = 0.3, color = "lightgrey", fill = "darkgrey", size = 0.25) +
  geom_bar(position="stack", stat="identity", width = 0.75) +
  facet_wrap(. ~ area, scales = "free") +
  scale_y_continuous(labels = comma) +
  theme_bw(base_size = 14)+
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    legend.spacing.y = unit(2, "cm"),
    legend.text = element_text(margin = margin(b = 15))
  ) +
  guides(fill = guide_legend(byrow = TRUE)) +
  labs(y = "Mortality (lbs)", x = "Year") -> slope_rem_x_source_lbs

ggsave("../figures/bayes_model/slope_mort_source_lbs.png",slope_rem_x_source_lbs, width = 7, height = 4)

``` 